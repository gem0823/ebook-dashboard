<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>eBook Dashboard</title>

  <!-- 檔案 1: 登入頁面樣式 (AdminLTE) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">

  <!-- 檔案 2: 儀表板樣式 (Tailwind & SheetJS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- 檔案 2: 儀表板自訂樣式 -->
  <style>
    /* 使用 Inter 和 Noto Sans TC 字體 */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body {
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden; /* 防止水平滾動 */
    }

    /* --- 修改：增加 icon 和文字的間距 (展開時) --- */
    #sidebar:not(.collapsed) nav ul a svg {
        margin-right: 1rem; /* 原本是 mr-3 (0.75rem)，增加到 1rem (mr-4) */
    }

    /* --- 修改：縮小所有選單 icon --- */
    #sidebar nav ul a svg {
        width: 1rem; /* 原本是 w-5 (1.25rem) */
        height: 1rem; /* 原本是 h-5 (1.25rem) */
    }
    /* 登出按鈕的 icon 也一起縮小 */
    #logoutBtn svg {
        width: 1rem; /* 原本是 w-4 (1rem)，保持一致 */
        height: 1rem; /* 原本是 h-4 (1rem)，保持一致 */
    }


    .content-section { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
    .content-section.hidden { opacity: 0; transform: translateY(10px); position: absolute; width: 100%; pointer-events: none; }
    .modal-content.open { transform: scale(1); opacity: 1; }
    .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .table-container::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 3px; }
    .table-container::-webkit-scrollbar-thumb:hover { background: #818cf8; }
    .task-header-new { background-color: #e0f2fe; color: #0c4a6e; }
    .task-header-expand { background-color: #dcfce7; color: #166534; }
     /* --- 新增：日期顯示樣式 --- */
    .date-display { min-width: 100px; display: inline-block; } /* 讓日期有最小寬度 */
    .date-display.empty { color: #9ca3af; } /* 無日期時的顏色 */

    /* --- 表二 KPI 表格樣式 (已重構) --- */
    .kpi-table th, .kpi-table td { text-align: center; padding: 0.75rem 0.5rem; border: 1px solid #e5e7eb; }
    /* .kpi-table .header-group { font-weight: bold; } */
    /* .kpi-table .header-group-target { background-color: #ffe4e6; } */
    /* .kpi-table .header-group-progress { background-color: #dbeafe; } */
    .kpi-table .header-sub { background-color: #f9fafb; font-size: 0.75rem; }
    .kpi-table .item-col { text-align: left; font-weight: bold; background-color: #f9fafb; }
    .kpi-table .total-row { font-weight: bold; background-color: #f3f4f6; }
    .kpi-table .highlight { background-color: #e0f2fe; }
    .kpi-table .gap-col { color: #dc2626; font-weight: bold; }
    .percentage { color: #6b7280; font-size: 0.75rem; margin-left: 4px; }
    .kpi-progress-link { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; text-decoration-color: #9ca3af; transition: all 0.2s; font-weight: 500; }
    .kpi-progress-link:hover { color: #4f46e5; text-decoration-color: #4f46e5; }
    .kpi-progress-link[data-count="0"] { color: #9ca3af; text-decoration: none; cursor: default; } /* 0 的樣式 */
    
    /* --- 表四可點擊樣式 --- */
    .clickable-stat { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; text-decoration-color: #9ca3af; transition: all 0.2s; }
    .clickable-stat:hover { color: #4f46e5; text-decoration-color: #4f46e5; }

    .health-warning { background-color: #fef9c3; color: #a16207; }
    .health-critical { background-color: #fee2e2; color: #b91c1c; }
    .sortable-header { cursor: pointer; user-select: none; }
    .sortable-header:hover { background-color: #f3f4f6; }
    .sort-asc::after { content: ' ▲'; font-size: 0.6em; }
    .sort-desc::after { content: ' ▼'; font-size: 0.6em; }
    #toast { position: fixed; top: 20px; right: 20px; transform: translateX(200%); transition: transform 0.5s ease-in-out; z-index: 100; }
    #toast.show { transform: translateX(0); }
    /* Checkbox column width */
    .checkbox-col { width: 3rem; text-align: center; }
    /* Row number column width and style */
    .row-number-col { width: 3.5rem; text-align: center; background-color: #f9fafb; font-weight: 500; color: #6b7280; }
    /* Column letter header style */
    .col-letter-header th { background-color: #f3f4f6; font-weight: bold; text-align: center; }

    /* --- 調整：欄寬調整 --- */
    .col-publisher-name { min-width: 12em; white-space: normal !important; word-break: break-word; }
    .col-contract-id { min-width: 130px; }
    .col-staff { min-width: 100px; }
    .col-tier { min-width: 60px; }
    .col-mission-tags { min-width: 150px; }
    .col-action { min-width: 80px; text-align: center; }

     /* --- 側邊欄收合樣式 --- */
    #sidebar { transition: width 0.3s ease-in-out; width: 16rem; /* 預設寬度 w-64 */ }
    /* --- 修改：增加收合時的寬度 --- */
    #sidebar.collapsed { width: 4.5rem; /* 收合寬度 4rem -> 4.5rem */ }
    #sidebar.collapsed .sidebar-text { display: none; }
    #sidebar.collapsed .sidebar-header-text { display: none; }
    #sidebar.collapsed .sidebar-footer > *:not(#logoutBtn):not(#db-status) { display: none; }
    #sidebar.collapsed #logoutBtn span { display: none; }
     #sidebar.collapsed #logoutBtn { width: auto; padding: 0.5rem; }
     #sidebar.collapsed #userRoleDisplay { display: none; }
     #sidebar.collapsed #db-status { font-size: 0.7rem; }
     #sidebar.collapsed #nav-admin svg,
     #sidebar.collapsed #nav-export svg,
     #sidebar.collapsed #nav-individual-contact svg,
     #sidebar.collapsed #nav-publisher-tier svg,
     #sidebar.collapsed #nav-individual-signing svg,
     #sidebar.collapsed #nav-team-signing svg,
     #sidebar.collapsed #nav-publisher-master svg { margin-right: 0 !important; }
     #sidebar.collapsed nav ul a {
        /* justify-content: center; */
        padding-left: 0.75rem;
        padding-right: 0.75rem;
     }

     #mainContent { transition: margin-left 0.3s ease-in-out; margin-left: 16rem; }
     /* --- 修改：配合側邊欄寬度調整 margin --- */
     body.sidebar-collapsed #mainContent { margin-left: 4.5rem; /* 收合時 margin 4rem -> 4.5rem */ }

     /* 漢堡按鈕樣式 */
     #sidebar-toggle {
        background: none; border: none; cursor: pointer; padding: 0.5rem;
        position: absolute; top: 1.25rem; right: -2.5rem;
        background-color: white; border-radius: 0 0.375rem 0.375rem 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        z-index: 10;
     }
      #sidebar.collapsed #sidebar-toggle { right: -2.5rem; }
     #sidebar-toggle svg { width: 1.5rem; height: 1.5rem; color: #4b5563; }

    /* --- 新增：複選下拉選單樣式 --- */
    .multi-select-container { position: relative; display: inline-block; min-width: 120px; /* 基礎最小寬度 */ }
    .multi-select-button {
      background-color: white; border: 1px solid #d1d5db; /* border-gray-300 */
      border-radius: 0.375rem; /* rounded-md */
      padding: 0.5rem 2.5rem 0.5rem 0.75rem; /* py-2 pl-3 pr-10 */
      text-align: left; width: 100%;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
      font-size: 0.875rem; /* sm:text-sm */
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-select-button:focus { outline: none; border-color: #4f46e5; /* focus:border-indigo-500 */ ring: 1px; ring-color: #4f46e5; /* focus:ring-indigo-500 */ }
    .multi-select-button .placeholder { color: #6b7280; /* text-gray-500 */ }
    .multi-select-button .count { font-weight: 500; color: #1f2937; /* text-gray-800 */ }
    .multi-select-button::after {
      content: ''; display: block; position: absolute; right: 0.75rem; top: 50%;
      transform: translateY(-50%); width: 0; height: 0; border-left: 5px solid transparent;
      border-right: 5px solid transparent; border-top: 5px solid #6b7280; /* text-gray-500 */
      pointer-events: none;
    }
    .multi-select-dropdown {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 20;
      background-color: white; border: 1px solid #d1d5db; /* border-gray-300 */
      border-radius: 0.375rem; /* rounded-md */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
      margin-top: 0.25rem; /* mt-1 */
      max-height: 200px; overflow-y: auto; padding: 0.5rem 0; /* py-2 */
      display: none; /* 預設隱藏 */
    }
    .multi-select-dropdown.open { display: block; }
    .multi-select-dropdown label {
      display: flex; align-items: center; padding: 0.5rem 1rem; /* px-4 py-2 */
      font-size: 0.875rem; /* text-sm */ color: #374151; /* text-gray-700 */
      cursor: pointer;
    }
    .multi-select-dropdown label:hover { background-color: #f3f4f6; /* hover:bg-gray-100 */ }
    .multi-select-dropdown input[type="checkbox"] {
      margin-right: 0.75rem; /* mr-3 */
      border-radius: 0.25rem; /* rounded */ border-color: #d1d5db; /* border-gray-300 */
      color: #4f46e5; /* text-indigo-600 */
    }
    .multi-select-dropdown input[type="checkbox"]:focus { ring: #4f46e5; /* focus:ring-indigo-500 */ }
    /* --- 結束新增 --- */

  </style>

  <!-- 整合：顯示/隱藏 的樣式 -->
  <style>
    #loginSection { display: flex; }
    #mainSection { display: none; }
  </style>
<style id="nx-ux-animations">
/* Modal & Toast micro-animations */
.modal { opacity: 0; transform: scale(.98); }
.modal.open { opacity: 1; transform: scale(1); transition: opacity .18s ease, transform .18s ease; }

#toast { opacity: 0; transform: translateY(6px); }
#toast.show { opacity: 1; transform: translateY(0); transition: opacity .18s ease, transform .18s ease; }
</style>
<!-- (移除) 舊的 nx-kpi2-pink 樣式 -->
</head>
<!-- 新增 class="sidebar-collapsed" 預設收合 -->
<body class="bg-gray-100 antialiased sidebar-collapsed">

  <!-- 🔐 登入畫面區塊 (來自 檔案 1) -->
  <div id="loginSection" class="flex items-center justify-center min-h-screen p-4">
    <div class="card card-primary w-full max-w-md shadow-lg">
      <div class="card-header"><h3 class="card-title">登入 eBook Dashboard</h3></div>
      <div class="card-body">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" class="form-control" id="loginEmail" placeholder="輸入 Email">
        </div>
        <div class="form-group">
          <label for="loginPassword">密碼</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="輸入密碼">
        </div>
        <button class="btn btn-primary mt-3 w-100" id="loginBtn">登入</button>
        <div id="loginError" class="text-danger text-center mt-2"></div>
      </div>
    </div>
  </div>

  <!-- 🧭 主系統區塊 (來自 檔案 2) -->
  <div id="mainSection" class="flex h-screen">

    <!-- 左側導覽選單 (來自 檔案 2，整合了 檔案 1 的登出按鈕) -->
    <aside id="sidebar" class="bg-white shadow-md flex flex-col shrink-0 relative">
        <!-- 新增漢堡按鈕 -->
        <button id="sidebar-toggle" title="收合/展開選單">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
        <div class="p-6 border-b flex items-center justify-center">
             <div class="sidebar-header-text text-center">
                 <p class="text-sm text-gray-500 mt-1">中文電子書徵集進度</p>
             </div>
        </div>
        <nav class="flex-1 px-4 py-6 overflow-y-auto">
            <ul class="space-y-2">
                <!-- 修改：移除 w-5 h-5 mr-3，讓 style 裡的 CSS 控制大小和間距 -->
                <li><a href="#" id="nav-publisher-master" class="flex items-center px-4 py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-lg shadow-sm"><svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg><span class="sidebar-text">出版社母體管理</span></a></li>
                <li><a href="#" id="nav-team-signing" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="sidebar-text">團隊簽約進度</span></a></li>
                <li><a href="#" id="nav-individual-signing" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 11h-4.17a6.12 6.12 0 0 1-5.6-3.07"/></svg><span class="sidebar-text">個人簽約進度</span></a></li>
                <li><a href="#" id="nav-publisher-tier" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 10v12"/><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><path d="M12 2v4"/><path d="m15 13-3-3-3 3"/></svg><span class="sidebar-text">出版社分級聯繫進度</span></a></li>
                <li><a href="#" id="nav-individual-contact" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"/><rect width="18" height="18" x="3" y="4" rx="2"/><circle cx="12" cy="10" r="2"/><line x1="8" y1="2" x2="8" y2="4"/><line x1="16" y1="2" x2="16" y2="4"/></svg><span class="sidebar-text">個人聯繫進度</span></a></li>

                <li class="admin-only" style="display: none;">
                  <a href="#" id="nav-admin" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg">
                    <svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 11V16"/><path d="M12 8H12.01"/><path d="M21.17 16.83A9.95 9.95 0 0 0 22 12c0-5.52-4.48-10-10-10S2 6.48 2 12a9.95 9.95 0 0 0 .83 4.17L2 22l5.17-1.17Z"/></svg>
                    <span class="sidebar-text">管理員專區</span>
                  </a>
                </li>

                <li class="border-t pt-2 mt-2"><a href="#" id="nav-export" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span class="sidebar-text">匯出報表</span></a></li>
            </ul>
        </nav>

        <div class="p-4 border-t mt-auto sidebar-footer">
            <div id="userRoleDisplay" class="text-sm font-medium text-gray-700 mb-2 truncate">
              未登入
            </div>
            <button id="logoutBtn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition-all duration-200 text-sm flex items-center justify-center gap-2">
              <svg class="shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" > <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /> </svg>
              <span class="sidebar-text">登出</span>
            </button>

            <!-- --- 修改：版本號 (v4.14.0 Table2 Refactor) --- -->
            <p class="text-xs text-gray-500 mt-4 sidebar-text">版本 v4.14.0 (Table2 Refactor)</p>
            <p class="text-xs text-gray-500 sidebar-text">資料庫狀態: <span id="db-status" class="font-semibold text-gray-400">未連接</span></p>
        </div>
    </aside>

    <!-- 右側主內容區 -->
    <main id="mainContent" class="flex-1 p-6 lg:p-8 overflow-y-auto">
        <header class="mb-8">
            <h2 id="main-title" class="text-3xl font-bold text-gray-900">出版社母體管理</h2>
        </header>

        <div class="relative">
            <!-- 模組一：出版社母體管理 -->
            <section id="content-publisher-master" class="content-section">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold text-gray-800">目標出版社清單</h3>
                        <div class="flex flex-wrap items-center gap-2">
                             <button id="delete-selected-btn" class="admin-only bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition-all duration-200 inline-flex items-center text-sm" style="display: none;">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                刪除選取
                            </button>
                            <button id="download-template-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-700 transition-all duration-200 inline-flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                下載範本
                            </button>
                            <button id="import-data-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 transition-all duration-200 inline-flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                匯入資料
                            </button>
                            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <!-- --- 修改：搜尋與篩選區域 --- -->
                    <div class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b">
                        <input type="text" id="search-input" placeholder="搜尋出版社、合約編號..." class="w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">

                        <!-- Staff Filter -->
                        <div class="multi-select-container">
                          <button id="staff-filter-button" type="button" class="multi-select-button">
                            <span class="placeholder">選擇同仁</span>
                          </button>
                          <div id="staff-filter-dropdown" class="multi-select-dropdown">
                            <!-- Checkboxes will be inserted here by JS -->
                          </div>
                        </div>

                        <!-- Tier Filter -->
                        <div class="multi-select-container">
                          <button id="tier-filter-button" type="button" class="multi-select-button">
                            <span class="placeholder">選擇分級</span>
                          </button>
                          <div id="tier-filter-dropdown" class="multi-select-dropdown">
                            <!-- Checkboxes will be inserted here by JS -->
                          </div>
                        </div>

                        <!-- Status Filter -->
                        <div class="multi-select-container" style="min-width: 150px;"> <!-- 加寬一點 -->
                          <button id="status-filter-button" type="button" class="multi-select-button">
                            <span class="placeholder">選擇狀態</span>
                          </button>
                          <div id="status-filter-dropdown" class="multi-select-dropdown">
                            <!-- Checkboxes will be inserted here by JS -->
                          </div>
                        </div>

                        <button id="clear-filters-btn" class="text-sm text-gray-600 hover:text-indigo-600">清除篩選</button>
                    </div>
                    <!-- --- 結束修改 --- -->
                    <div class="flex justify-between items-center mb-2">
                        <!-- --- 修改：表一 -> 表1 --- -->
                        <h4 class="text-sm font-semibold text-gray-500 ">&lt;表1&gt;</h4>
                        <p id="publisher-count-info" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="overflow-x-auto max-h-[65vh] table-container">
                        <table class="w-full text-sm text-left text-gray-600 border-collapse">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase sticky top-0 z-10 shadow-sm">
                                <tr id="col-letter-header" class="col-letter-header">
                                    <!-- Placeholder cell(s) for checkbox and row number -->
                                </tr>
                                <tr>
                                    <th class="px-3 py-3 border-b border-gray-200 checkbox-col admin-only" style="display: none;">
                                      <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </th>
                                     <th class="px-3 py-3 border-b border-gray-200 row-number-col">#</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-publisher-name" data-sort="name">出版社名稱</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-contract-id" data-sort="contractId">合約編號</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-staff" data-sort="staff">負責同仁</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-tier" data-sort="tier">分級</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header" data-sort="contactStatus">聯繫狀態</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-mission-tags" data-sort="missionTags">任務標籤</th>
                                    <!-- G欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-new" data-task-header="task_new_ebook">取得:電子書合作</th>
                                    <!-- H欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2c">取得:B2C銷售權利</th>
                                    <!-- I欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_gvm">取得:[灰熊]</th>
                                    <!-- J欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_trms">取得:電子教科書TRMS</th>
                                    <!-- K欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_kingstone">取得:[書紐]金石堂</th>
                                    <!-- L欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_sanmin">取得:[書紐]三民</th>
                                    <!-- M欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2c_3rd">取得:B2C經銷第三方</th>
                                    <!-- N欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b">取得:B2B銷售權利</th>
                                    <!-- O欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b_union">取得:B2B_聯盟</th>
                                    <!-- P欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b_public">取得:B2B_公圖</th>
                                    <!-- Q欄 -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b_cn">取得:B2B_CN</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 col-action">操作</th>
                                </tr>
                            </thead>
                            <tbody id="master-list-body">
                                <tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-gray-500">正在等待登入...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 模組二：團隊簽約進度 (已重構為 2-1 ~ 2-4) -->
            <section id="content-team-signing" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-8">
                    
                    <!-- 表 2-1: 總體目標進度 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">2025年8~12月＿中文電子書徵集團體總目標</h3>
                        <p class="text-xs text-red-600 mb-2">*備註：統計 8~12 月期間，首次完成任一任務(G~Q欄)的「不重複出版社」家數。</p>
                        <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表2-1&gt; 總體目標進度 (單位：家)</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse kpi-table">
                                <thead class="header-sub">
                                    <tr>
                                        <th class="item-col">項目</th>
                                        <th>8月</th>
                                        <th>9月</th>
                                        <th>10月</th>
                                        <th>11月</th>
                                        <th>12月</th>
                                        <th class="highlight">總計</th>
                                    </tr>
                                </thead>
                                <tbody id="kpi-table-body-main">
                                    <!-- JS 會渲染此處 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 表 2-2: 任務完成明細 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">2025年8~12月＿各項任務完成明細</h3>
                        <p class="text-xs text-red-600 mb-2">*備註：統計 8~12 月期間，完成各項指定任務的「出版社家次」。(例：A出版社同月完成2項任務，計為2家次)</p>
                        <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表2-2&gt; 任務完成明細 (單位：家次)</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse kpi-table">
                                <thead class="header-sub">
                                    <tr>
                                        <th class="item-col">任務項目</th>
                                        <th>8月</th>
                                        <th>9月</th>
                                        <th>10月</th>
                                        <th>11月</th>
                                        <th>12月</th>
                                        <th class="highlight">小計</th>
                                    </tr>
                                </thead>
                                <tbody id="kpi-table-body-detail">
                                    <!-- JS 會渲染此處 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- 表 2-3: B2C 任務匯總 -->
                        <div>
                            <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表2-3&gt; B2C 任務匯總 (單位：家次)</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse kpi-table">
                                    <thead class="header-sub">
                                        <tr>
                                            <th class="item-col">B2C 匯總</th>
                                            <th>8月</th>
                                            <th>9月</th>
                                            <th>10月</th>
                                            <th>11月</th>
                                            <th>12月</th>
                                            <th class="highlight">小計</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kpi-table-body-b2c">
                                        <!-- JS 會渲染此處 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 表 2-4: B2B 任務匯總 -->
                        <div>
                            <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表2-4&gt; B2B 任務匯總 (單位：家次)</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse kpi-table">
                                    <thead class="header-sub">
                                        <tr>
                                            <th class="item-col">B2B 匯總</th>
                                            <th>8月</th>
                                            <th>9月</th>
                                            <th>10月</th>
                                            <th>11月</th>
                                            <th>12月</th>
                                            <th class="highlight">小計</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kpi-table-body-b2b">
                                        <!-- JS 會渲染此處 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- 模組三：個人簽約進度 -->
            <section id="content-individual-signing" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">個人簽約率總覽</h3>
                    <!-- --- 修改：表三 -> 表3 --- -->
                    <h4 class="text-sm font-semibold text-gray-500 mb-4">&lt;表3&gt;</h4>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th scope="col" class="px-6 py-3">負責人</th>
                                    <th scope="col" class="px-6 py-3">負責單位數</th>
                                    <th scope="col" class="px-6 py-3">已簽約</th>
                                    <th scope="col" class="px-6 py-3">簽約率</th>
                                </tr>
                            </thead>
                            <tbody id="individual-signing-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 模組四：出版社分級聯繫進度 -->
            <section id="content-publisher-tier" class="content-section hidden">
                <!-- --- 修改：表四 -> 表4 --- -->
                <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表4&gt;</h4>
                <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <label for="progress-filter" class="text-sm font-medium text-gray-700">篩選檢視:</label>
                        <select id="progress-filter" class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                    </div>
                    <div class="text-xs text-gray-600 flex items-center gap-4">
                        <span class="font-bold">分級定義:</span>
                        <span><span class="font-semibold text-red-600">A級:</span> 最重要</span>
                        <span><span class="font-semibold text-yellow-600">B級:</span> 次之</span>
                        <span><span class="font-semibold text-blue-600">C級:</span> 一般</span>
                    </div>
                </div>
                <div id="progress-cards-container" class="grid grid-cols-1 xl:grid-cols-2 gap-8"></div>
            </section>

            <!-- 模組五：個人聯繫進度 -->
            <section id="content-individual-contact" class="content-section hidden">
                <!-- --- 修改：表五 -> 表5 --- -->
                <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表5&gt;</h4>
                <div id="individual-contact-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- 模組六：匯出報表 -->
            <section id="content-export" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">選擇要匯出的報表</h3>
                    <div class="space-y-4" id="export-options-container">
                        <!-- --- 修改：表一 -> 表1 --- -->
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table1" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;表1&gt; 出版社母體管理</span>
                        </label>
                        <!-- --- 修改：表二 -> 表2 --- -->
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table2" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;表2&gt; 團隊簽約進度</span>
                        </label>
                        <!-- --- 修改：表三 -> 表3 --- -->
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table3" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;表3&gt; 個人簽約進度</span>
                        </label>
                        <!-- --- 修改：表四 -> 表4 --- -->
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table4" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;表4&gt; 出版社分級聯繫進度</span>
                        </label>
                        <!-- --- 修改：表五 -> 表5 --- -->
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table5" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;表5&gt; 個人聯繫進度</span>
                        </label>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="export-selected-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 transition-all duration-200 inline-flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            匯出所選報表
                        </button>
                    </div>
                </div>
            </section>

            <!-- 管理員專區：使用者管理 (移除角色變更功能) -->
            <section id="content-admin" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">使用者帳號管理</h3>

                    <div class="overflow-x-auto rounded-lg border">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th scope="col" class="px-6 py-3">使用者 Email</th>
                                    <th scope="col" class="px-6 py-3">目前角色</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                                <tr><td colspan="2" class="text-center py-10 text-gray-500">正在載入使用者清單...</td></tr>
                            </tbody>
                        </table>
                    </div>
                     <p class="text-xs text-gray-500 mt-4">*注意：新增使用者帳號或變更權限，請洽林芝(至 Firebase Authentication 主控台操作。)</p>
                </div>
            </section>

        </div>
    </main>
  </div><!-- /#mainSection -->

  <!-- Modals -->
  <div id="publisher-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div id="publisher-list-modal-content" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 border-b flex justify-between items-center">
              <h3 class="text-lg font-bold text-gray-800" id="publisher-list-title">出版社清單</h3>
              <button id="close-publisher-list-btn" class="text-gray-400 hover:text-gray-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
          </div>
          <div class="p-6 max-h-[60vh] overflow-y-auto"><ul id="publisher-list-body" class="space-y-2 text-sm text-gray-700 list-disc list-inside"></ul></div>
      </div>
  </div>
  <!-- Alert Modal -->
  <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 text-center">
              <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
              <h3 class="mt-4 text-lg font-medium text-gray-900">操作提醒</h3>
              <p id="alert-modal-text" class="mt-2 text-sm text-gray-600"></p>
          </div>
          <div class="p-4 bg-gray-50 rounded-b-xl text-center">
              <button id="close-alert-modal-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">我知道了</button>
          </div>
      </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 text-center">
              <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
              <h3 class="mt-4 text-lg font-medium text-gray-900">確認操作</h3>
              <p id="confirm-modal-text" class="mt-2 text-sm text-gray-600"></p>
          </div>
          <div class="p-4 bg-gray-50 rounded-b-xl text-center space-x-2">
              <button id="cancel-confirm-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
              <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">確認刪除</button>
          </div>
      </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="">
      <div id="toast-content" class="flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-lg" role="alert">
      </div>
  </div>

  <!-- Firebase Config -->
  <script>
    const __app_id = "ebook-dashboard";
    const __firebase_config = JSON.stringify({
      apiKey: "AIzaSyA735uIwaSCjz09KwI0SNXgvmTwmk5kzXA",
      authDomain: "ebook-dashboard-a0148.firebaseapp.com",
      projectId: "ebook-dashboard-a0148",
      storageBucket: "ebook-dashboard-a0148.firebasestorage.app",
      messagingSenderId: "127405787765",
      appId: "1:127405787765:web:72631dc3d362466660c63c"
    });
  </script>

  <!-- 整合後的 Script (V11 Modular SDK) -->
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, writeBatch, setDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      document.addEventListener('DOMContentLoaded', async function () {
          // --- 設定與常數 ---
          const staffList = ["陳玫君", "陳俐吟", "李芷瑄", "李虹儀", "未分配"];
          // --- 修改：移除 X 級 ---
          const tierList = ["A", "B", "C"];
          // --- 結束修改 ---
          const contactStatusList = ["未聯繫", "聯繫中", "已聯繫，無意願洽談", "已聯繫，有意願洽談", "審約中", "用印中", "已簽回，已移交合約"];
          // 欄位代號 G, H, I, J, K, L, M, N, O, P, Q
          const taskColumns = [
              'task_new_ebook', // G
              'task_get_b2c', // H
              'task_get_gvm', // I
              'task_get_trms', // J
              'task_get_kingstone', // K
              'task_get_sanmin', // L
              'task_get_b2c_3rd', // M
              'task_get_b2b', // N
              'task_get_b2b_union', // O
              'task_get_b2b_public', // P
              'task_get_b2b_cn' // Q
            ];

          // --- JS 修改 1: (替換) 更新常數 ---
          // 移除舊的 kpiTargets
          // --- 設定與常數 (表2重構) ---
          const MAIN_KPI_TARGETS = [12, 12, 16, 16, 16]; // 表2-1: 8月-12月固定目標

          // 表2-2: 8個子項目
          const DETAIL_TASK_KEYS = [
              'task_get_gvm',       // [灰熊]
              'task_get_kingstone', // [書紐]金石堂
              'task_get_sanmin',    // [書紐]三民
              'task_get_b2c_3rd', // B2C經銷第三方
              'task_get_trms',      // 電子教科書TRMS
              'task_get_b2b_union', // B2B_聯盟
              'task_get_b2b_public',// B2B_公圖
              'task_get_b2b_cn'     // B2B_CN
          ];
          // 表2-2: 顯示名稱
          const DETAIL_TASK_NAMES = {
              'task_get_gvm': '取得:[灰熊]',
              'task_get_kingstone': '取得:[書紐]金石堂',
              'task_get_sanmin': '取得:[書紐]三民',
              'task_get_b2c_3rd': '取得:B2C經銷第三方',
              'task_get_trms': '取得:電子教科書TRMS',
              'task_get_b2b_union': '取得:B2B_聯盟',
              'task_get_b2b_public': '取得:B2B_公圖',
              'task_get_b2b_cn': '取得:B2B_CN'
          };
          // 表2-3: B2C 匯總
          const B2C_TASK_KEYS = [
              'task_get_gvm',
              'task_get_kingstone',
              'task_get_sanmin',
              'task_get_b2c_3rd',
              'task_get_trms'
          ];
          // 表2-4: B2B 匯總
          const B2B_TASK_KEYS = [
              'task_get_b2b_union',
              'task_get_b2b_public',
              'task_get_b2b_cn'
          ];
          // --- 結束 (表2重構) ---
          // --- 結束 JS 修改 1 ---

          const pageTitles = {
              publisherMaster: '出版社母體管理',
              teamSigning: '團隊簽約進度',
              individualSigning: '個人簽約進度',
              publisherTier: '出版社分級聯繫進度',
              individualContact: '個人聯繫進度',
              export: '匯出報表',
              admin: '管理員專區'
          };
          const initialData = [
              { name: "範例出版社", staff: "未分配", tier: "A", contactStatus: "未聯繫", missionTags: ["範例標籤"], contractId: null, tasks: {} } // 預設改為 A
          ];

          // --- 全域狀態管理 ---
          const state = {
              publishers: [],
              analytics: {},
              // --- 修改：filters 改為儲存陣列 ---
              filters: { search: '', staff: [], tier: [], status: [] },
              // --- 結束修改 ---
              sort: { by: 'name', order: 'asc' },
              db: null,
              auth: null,
              appId: null,
              publishersCollection: null,
              isDashboardInitialized: false,
              selectedPublisherIds: new Set(),
              currentRole: 'user',
              isSidebarCollapsed: true,
          };

          // --- DOM 元素快取 ---
          const dom = {
              navLinks: Object.fromEntries(Object.keys(pageTitles).map(id => [id, document.getElementById(`nav-${id.replace('publisherMaster', 'publisher-master').replace('teamSigning','team-signing').replace('individualSigning','individual-signing').replace('publisherTier','publisher-tier').replace('individualContact','individual-contact')}`)])),
              contentSections: Object.fromEntries(Object.keys(pageTitles).map(id => [id, document.getElementById(`content-${id.replace('publisherMaster', 'publisher-master').replace('teamSigning','team-signing').replace('individualSigning','individual-signing').replace('publisherTier','publisher-tier').replace('individualContact','individual-contact')}`)])),
              mainTitle: document.getElementById('main-title'),
              dbStatus: document.getElementById('db-status'),
              masterListBody: document.getElementById('master-list-body'),
              searchInput: document.getElementById('search-input'),
              // --- 修改：快取新的複選下拉選單元素 ---
              staffFilterButton: document.getElementById('staff-filter-button'),
              staffFilterDropdown: document.getElementById('staff-filter-dropdown'),
              tierFilterButton: document.getElementById('tier-filter-button'),
              tierFilterDropdown: document.getElementById('tier-filter-dropdown'),
              statusFilterButton: document.getElementById('status-filter-button'),
              statusFilterDropdown: document.getElementById('status-filter-dropdown'),
              // --- 結束修改 ---
              publisherListModal: document.getElementById('publisher-list-modal'),
              publisherListModalContent: document.getElementById('publisher-list-modal').querySelector('.modal-content'),
              alertModal: document.getElementById('alert-modal'),
              alertModalContent: document.getElementById('alert-modal').querySelector('.modal-content'),
              alertModalText: document.getElementById('alert-modal-text'),
              confirmModal: document.getElementById('confirm-modal'),
              confirmModalContent: document.getElementById('confirm-modal').querySelector('.modal-content'),
              confirmModalText: document.getElementById('confirm-modal-text'),
              confirmActionBtn: document.getElementById('confirm-action-btn'),
              cancelConfirmBtn: document.getElementById('cancel-confirm-btn'),
              selectAllCheckbox: document.getElementById('select-all-checkbox'),
              deleteSelectedBtn: document.getElementById('delete-selected-btn'),
              colLetterHeader: document.getElementById('col-letter-header'),
              sidebar: document.getElementById('sidebar'),
              sidebarToggle: document.getElementById('sidebar-toggle'),
              mainContent: document.getElementById('mainContent'),
              publisherCountInfo: document.getElementById('publisher-count-info'),
              // --- JS 修改 2: (替換) 更新 DOM 元素快取 ---
              kpiTableBodyMain: document.getElementById('kpi-table-body-main'),
              kpiTableBodyDetail: document.getElementById('kpi-table-body-detail'),
              kpiTableBodyB2C: document.getElementById('kpi-table-body-b2c'),
              kpiTableBodyB2B: document.getElementById('kpi-table-body-b2b'),
              // --- 結束 JS 修改 2 ---
          };
          const loginSection = document.getElementById('loginSection');
          const mainSection = document.getElementById('mainSection');
          const loginBtn = document.getElementById('loginBtn');
          const logoutBtn = document.getElementById('logoutBtn');
          const loginEmail = document.getElementById('loginEmail');
          const loginPassword = document.getElementById('loginPassword');
          const loginError = document.getElementById('loginError');
          const userRoleDisplay = document.getElementById('userRoleDisplay');
          const userListBody = document.getElementById('user-list-body');

          // --- Firebase 核心功能 ---
          try {
              state.appId = typeof __app_id !== 'undefined' ? __app_id : 'ebook-dashboard';
              const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
              if (!firebaseConfig.apiKey) throw new Error("Firebase config is missing.");

              const app = initializeApp(firebaseConfig);
              state.db = getFirestore(app);
              state.auth = getAuth(app);
              if(dom.dbStatus) dom.dbStatus.textContent = '初始化...';

          } catch (error) {
              console.error("Firebase initialization failed:", error);
              if(dom.dbStatus) {
                dom.dbStatus.textContent = '連接失敗';
                dom.dbStatus.className = 'font-semibold text-red-600';
              }
              if(loginError) {
                loginError.textContent = '系統初始化失敗，請重新整理。';
              }
              return;
          }

          // --- 登入/登出/權限邏輯 ---
          onAuthStateChanged(state.auth, async (user) => {
              if (user) {
                  const uid = user.uid;
                  const email = user.email;
                  const userDocRef = doc(state.db, "artifacts", state.appId, "users", uid);
                  const userDoc = await getDoc(userDocRef);

                  if (userDoc.exists()) {
                      state.currentRole = userDoc.data().role;
                      console.log(`%c[偵錯 1/5] 登入成功，權限已確認 (Role: ${state.currentRole})`, "color: blue; font-weight: bold;");

                      loginSection.style.display = 'none';
                      mainSection.style.display = 'flex';
                      userRoleDisplay.textContent = `${email}（${state.currentRole}）`;

                      const displayStyle = state.currentRole === "admin" ? 'list-item' : 'none';
                      const displayStyleBlock = state.currentRole === "admin" ? 'inline-flex' : 'none';
                      const displayStyleTable = state.currentRole === "admin" ? 'table-cell' : 'none';

                      document.querySelectorAll('.admin-only').forEach(el => {
                           if (el.tagName === 'LI') { el.style.display = displayStyle; }
                           else if (el.tagName === 'BUTTON'){ el.style.display = displayStyleBlock; }
                           else if (el.tagName === 'TH' || el.tagName === 'TD') { el.style.display = displayStyleTable; }
                           else { el.style.display = displayStyleBlock; }
                      });

                      updateColLetterHeaderColspan();

                      if (state.isDashboardInitialized) {
                          console.log("[偵錯] 儀表板已初始化，跳過重複設定。");
                          document.querySelectorAll('.admin-only').forEach(el => {
                               if (el.tagName === 'LI') { el.style.display = displayStyle;}
                               else if (el.tagName === 'BUTTON'){ el.style.display = displayStyleBlock; }
                               else if (el.tagName === 'TH' || el.tagName === 'TD') { el.style.display = displayStyleTable; }
                               else { el.style.display = displayStyleBlock; }
                          });
                          updateColLetterHeaderColspan();
                          applySidebarState();
                          setupFilters(); // 確保篩選器選項在重新登入時正確
                          renderAll(); // 重新渲染確保濾鏡選項更新
                          return;
                      }

                      console.log("[偵錯 2/5] 正在初始化儀表板...");
                      dom.dbStatus.textContent = '已連接';
                      dom.dbStatus.className = 'font-semibold text-green-600';

                      state.publishersCollection = collection(state.db, "artifacts", state.appId, "public", "data", "publishers");
                      renderColLetterHeader();
                      listenToPublishers(); // 會觸發 renderAll

                      console.log("[偵錯 3/5] 正在設定儀表板事件監聽器...");
                      setupEventListeners();
                      setupFilters(); // 初始化篩選選項
                      switchContent('publisherMaster');

                      if (state.currentRole === 'admin') {
                          fetchUsers();
                      }

                      applySidebarState();
                      state.isDashboardInitialized = true;

                  } else {
                      await signOut(state.auth);
                      loginError.textContent = "您的帳號尚未授權使用此系統";
                      loginSection.style.display = 'flex';
                      mainSection.style.display = 'none';
                      dom.dbStatus.textContent = '未授權';
                      dom.dbStatus.className = 'font-semibold text-red-600';
                  }
              } else {
                  loginSection.style.display = 'flex';
                  mainSection.style.display = 'none';
                  dom.dbStatus.textContent = '未連接';
                  dom.dbStatus.className = 'font-semibold text-gray-400';
                  state.isDashboardInitialized = false;
                  state.currentRole = 'user';
              }
          });

          loginBtn.addEventListener("click", async () => {
              const email = loginEmail.value.trim();
              const password = loginPassword.value;
              loginError.textContent = "";
              if (!email || !password) {
                  loginError.textContent = "請輸入 Email 和密碼";
                  return;
              }
              try {
                  loginBtn.disabled = true;
                  loginBtn.textContent = "登入中...";
                  await signInWithEmailAndPassword(state.auth, email, password);
              } catch (err) {
                  loginError.textContent = "登入失敗：Email 或密碼錯誤。";
                  console.error("登入錯誤:", err);
              } finally {
                  loginBtn.disabled = false;
                  loginBtn.textContent = "登入";
              }
          });

          logoutBtn.addEventListener("click", () => {
            signOut(state.auth).then(() => location.reload());
          });


          // --- 儀表板核心功能 ---

          function listenToPublishers() {
              console.log(`%c[偵錯 4/5] 正在附加 Snapshot 監聽器至: ${state.publishersCollection.path}`, "color: blue;");
              onSnapshot(state.publishersCollection, async (snapshot) => {
                  console.log(`%c[偵錯 5/5] Snapshot 成功接收! (空集合: ${snapshot.empty}, 文件數: ${snapshot.size})`, "color: green; font-weight: bold;");

                  state.publishers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  state.analytics = calculateAllAnalytics(state.publishers);
                  setupFilters(); // 更新篩選器選項 (特別是 Staff 可能會變)
                  renderAll();
                  updateDeleteSelectedButtonState();
              }, (error) => {
                  console.error("%c[偵錯 失敗] Firebase Snapshot 錯誤:", "color: red; font-weight: bold;", error);
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-red-500">讀取資料時發生錯誤。請檢查 Firestore 安全規則或主控台錯誤訊息。</td></tr>`;
              });
          }

          // --- 核心渲染邏輯 ---
          function renderAll() {
              console.log("%c[偵錯 6/6] renderAll() 啟動. 正在渲染所有模組...", "color: green;");
              try {
                const filteredAndSorted = getFilteredAndSortedData();
                renderMasterList(filteredAndSorted);
                renderTeamSigningProgress(state.analytics.teamSigningStats);
                renderIndividualSigningProgress(state.analytics.individualSigningStats);
                renderPublisherTierProgress(state.analytics.tierProgressStats);
                renderIndividualContactProgress(state.analytics.individualContactStats);
                updateCheckboxesAfterRender();
                console.log("%c[偵錯] 渲染完畢!", "color: green;");
              } catch (error) {
                  console.error("%c[偵錯 失敗] 渲染 (Render) 過程中發生錯誤:", "color: red; font-weight: bold;", error);
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-red-500">渲染資料時發生錯誤: ${error.message}</td></tr>`;
              }
          }

          function renderMasterList(data) {
              if (!dom.masterListBody) return;

              const totalCount = state.publishers.length;
              const filteredCount = data.length;
              const countInfoEl = dom.publisherCountInfo;

              if (data.length === 0) {
                  const message = totalCount > 0 ? "沒有符合篩選條件的結果。" : "資料庫中尚無資料，請匯入。";
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                   if (countInfoEl) {
                        countInfoEl.textContent = totalCount > 0 ? `篩選結果：共 0 筆資料 (總計 ${totalCount} 筆)` : '共 0 筆資料。';
                    }
                  return;
              }

               if (countInfoEl) {
                  const isFiltered = state.filters.search || state.filters.staff.length > 0 || state.filters.tier.length > 0 || state.filters.status.length > 0;
                  if (isFiltered) {
                      countInfoEl.textContent = `篩選結果：共 ${filteredCount} 筆資料 (總計 ${totalCount} 筆)`;
                  } else {
                      countInfoEl.textContent = `共 ${totalCount} 筆資料。`;
                  }
               }

              try {
                dom.masterListBody.innerHTML = data.map((pub, i) => createPublisherRowHtml(pub, i)).join('');
              } catch (error) {
                  console.error("Error rendering master list HTML:", error);
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-red-500">渲染表格時發生嚴重錯誤，請檢查控制台。</td></tr>`;
                  return;
              }

               const checkBoxes = dom.masterListBody.querySelectorAll('.row-checkbox');
               const displayStyleTable = state.currentRole === "admin" ? 'table-cell' : 'none';
               checkBoxes.forEach(cb => {
                   const cell = cb.closest('td');
                   if (cell) cell.style.display = displayStyleTable;
               });
               const rowNumberCells = dom.masterListBody.querySelectorAll('.row-number-col');
               rowNumberCells.forEach(cell => {
                    cell.style.display = 'table-cell';
               });
          }

          // --- 資料分析與計算 ---
           function calculateAllAnalytics(publishers) {
              return {
                  teamSigningStats: calculateTeamSigningStats(publishers),
                  individualSigningStats: calculateIndividualSigningStats(publishers),
                  tierProgressStats: calculateTierProgressStats(publishers),
                  individualContactStats: calculateIndividualContactStats(publishers),
              };
          }

          // --- JS 修改 3: (刪除) 移除舊的輔助函數 ---
          // 移除了舊的 getEarliestDate 函數

          // --- JS 修改 4: (替換) 更新核心計算邏輯 ---
          // --- 修改：(表2重構) 重寫 KPI 統計函數 ---
          function calculateTeamSigningStats(publishers) {
              // 初始化 4 個表格的進度
              const mainProgress = [0, 0, 0, 0, 0]; // 表2-1: 不重複家數
              const detailProgress = {}; // 表2-2: 家次
              const b2cSummary = [0, 0, 0, 0, 0]; // 表2-3
              const b2bSummary = [0, 0, 0, 0, 0]; // 表2-4

              DETAIL_TASK_KEYS.forEach(key => {
                  detailProgress[key] = [0, 0, 0, 0, 0];
              });

              const publisherFirstCompletionMonth = {}; // 儲存 { pubId: earliestMonth }

              for (const pub of publishers) {
                  let earliestMonth = null;

                  // 1. 計算 (表2-1) 的不重複家數
                  // 遍歷所有 G-Q 欄任務
                  for (const taskKey of taskColumns) {
                      const dateStr = pub.tasks ? pub.tasks[taskKey] : null;
                      if (dateStr) {
                          const date = new Date(normalizeDate(dateStr));
                          if (!isNaN(date.getTime())) {
                              const month = date.getMonth() + 1;
                              if (month >= 8 && month <= 12) {
                                  if (earliestMonth === null || month < earliestMonth) {
                                      earliestMonth = month;
                                  }
                              }
                          }
                      }
                  }
                  
                  if (earliestMonth) {
                      publisherFirstCompletionMonth[pub.id] = earliestMonth;
                  }

                  // 2. 計算 (表2-2) 的任務明細 (家次)
                  for (const taskKey of DETAIL_TASK_KEYS) {
                       const dateStr = pub.tasks ? pub.tasks[taskKey] : null;
                       if (dateStr) {
                           const date = new Date(normalizeDate(dateStr));
                           if (!isNaN(date.getTime())) {
                               const month = date.getMonth() + 1;
                               if (month >= 8 && month <= 12) {
                                   detailProgress[taskKey][month - 8]++;
                               }
                           }
                       }
                  }
              }

              // 3. 彙整 (表2-1) 的最終統計
              Object.values(publisherFirstCompletionMonth).forEach(month => {
                  mainProgress[month - 8]++;
              });

              // 4. 彙整 (表2-3) B2C 總和
              B2C_TASK_KEYS.forEach(key => {
                  for (let i = 0; i < 5; i++) {
                      b2cSummary[i] += detailProgress[key][i];
                  }
              });

              // 5. 彙整 (表2-4) B2B 總和
              B2B_TASK_KEYS.forEach(key => {
                  for (let i = 0; i < 5; i++) {
                      b2bSummary[i] += detailProgress[key][i];
                  }
              });

              return { mainProgress, detailProgress, b2cSummary, b2bSummary };
          }
          // --- 結束修改 ---
          // --- 結束 JS 修改 4 ---


          function calculateIndividualSigningStats(publishers) {
                 const stats = {};
                 // --- 修改：動態獲取 staff 列表 ---
                 const currentStaffList = ['未分配', ...Array.from(new Set(publishers.map(p => p.staff).filter(Boolean)))].sort((a,b) => a === '未分配' ? 1 : b === '未分配' ? -1 : a.localeCompare(b, 'zh-Hant'));
                 // --- 結束修改 ---
                 currentStaffList.forEach(s => stats[s] = { total: 0, signed: 0 });
                 publishers.forEach(p => {
                     const staff = p.staff || '未分配';
                     if (!stats[staff]) { // 理論上不會發生，但以防萬一
                         stats[staff] = { total: 0, signed: 0 };
                     }
                     stats[staff].total++;
                     if (p.contactStatus === "已簽回，已移交合約") {
                         stats[staff].signed++;
                     }
                 });
                 // 只回傳有負責單位數的同仁
                 return Object.entries(stats)
                    .filter(([, data]) => data.total > 0)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        rate: data.total > 0 ? (data.signed / data.total * 100) : 0
                    }));
            }


          // --- 修改：移除 X 級的計算 ---
          function calculateTierProgressStats(publishers) {
              const progressData = {};
              // 從 publishers 動態獲取所有出現過的 staff
              const currentStaff = Array.from(new Set(publishers.map(p => p.staff || '未分配'))).sort();

              currentStaff.forEach(staffName => {
                  progressData[staffName] = {};
                  tierList.forEach(tier => { // tierList 已經移除了 'X'
                      progressData[staffName][tier] = { total: 0, stages: {} };
                      contactStatusList.forEach(s => progressData[staffName][tier].stages[s] = 0);
                  });
              });

              publishers.forEach(p => {
                  const staff = p.staff || '未分配';
                  const tier = p.tier;
                  const status = p.contactStatus;

                  // 只處理 A, B, C 級
                  if (progressData[staff] && tier && tierList.includes(tier)) {
                      progressData[staff][tier].total++;
                      if (status && progressData[staff][tier].stages.hasOwnProperty(status)) {
                             progressData[staff][tier].stages[status]++;
                      } else if (status) {
                         console.warn(`發現未知的聯繫狀態: "${status}" for publisher ${p.name}`);
                      }
                  } else {
                      // 忽略 X 級或其他無效 tier
                      if (tier && !tierList.includes(tier)) {
                          // console.log(`忽略非 A, B, C 的 tier: "${tier}" for publisher ${p.name}, Staff: "${staff}"`);
                      }
                  }
              });
              return progressData;
            }
            // --- 結束修改 ---



          function calculateIndividualContactStats(publishers) {
                const stats = {};
                // 從 publishers 動態獲取所有出現過的 staff
                const currentStaff = Array.from(new Set(publishers.map(p => p.staff || '未分配'))).sort();
                currentStaff.forEach(s => stats[s] = { total: 0, contacted: 0 });

                 publishers.forEach(p => {
                     const staff = p.staff || '未分配'; // 將空 staff 歸到未分配
                    // stats[staff] 應該已經存在
                    stats[staff].total++;
                    if (p.contactStatus !== "未聯繫") {
                        stats[staff].contacted++;
                    }
                });
                 // 只回傳有負責單位數的同仁
                 return Object.entries(stats)
                    .filter(([, data]) => data.total > 0)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        rate: data.total > 0 ? (data.contacted / data.total * 100) : 0
                    }));
            }


          // --- 各模組渲染函式 ---
          // --- JS 修改 5: (替換) 更新渲染邏輯 ---
          // --- 修改：(表2重構) 重寫 KPI 渲染函數 ---
          function renderTeamSigningProgress(stats) {
              if (!stats || !dom.kpiTableBodyMain) return; // 檢查 DOM 是否存在

              const { mainProgress, detailProgress, b2cSummary, b2bSummary } = stats;

              // --- 輔助函式：建立可點擊的 span ---
              const createClickableSpan = (count, item, month, taskKey = null) => {
                  const taskKeyAttr = taskKey ? `data-task-key="${taskKey}"` : '';
                  return `<span class="kpi-progress-link" data-kpi-item="${item}" data-month="${month}" data-count="${count}" ${taskKeyAttr}>${count}</span>`;
              };

              // --- 1. 渲染 <表2-1> (總體目標進度) ---
              const targets = MAIN_KPI_TARGETS;
              const targetTotal = targets.reduce((a, b) => a + b, 0);
              const progressTotal = mainProgress.reduce((a, b) => a + b, 0);
              const overallRate = targetTotal > 0 ? (progressTotal / targetTotal * 100).toFixed(1) : 0;
              const gap = targetTotal - progressTotal;
              
              const monthlyRates = mainProgress.map((p, i) => targets[i] > 0 ? (p / targets[i] * 100).toFixed(0) : 0);
              const gapCells = mainProgress.map((p, i) => Math.max(0, targets[i] - p));

              dom.kpiTableBodyMain.innerHTML = `
                  <tr class="total-row">
                      <td class="item-col">目標</td>
                      ${targets.map(t => `<td>${t}</td>`).join('')}
                      <td class="highlight">${targetTotal}</td>
                  </tr>
                  <tr>
                      <td class="item-col">進度</td>
                      ${mainProgress.map((p, i) => `<td>${createClickableSpan(p, 'Main', i + 8)}</td>`).join('')}
                      <td class="highlight">${createClickableSpan(progressTotal, 'Main', 'all')}</td>
                  </tr>
                  <tr>
                      <td class="item-col">達成率</td>
                      ${monthlyRates.map(r => `<td>${r}%</td>`).join('')}
                      <td class="highlight">${overallRate}%</td>
                  </tr>
                  <tr class="gap-col">
                      <td class="item-col" style="color: #dc2626;">缺口</td>
                      ${gapCells.map(g => `<td>${g}</td>`).join('')}
                      <td class="highlight">${Math.max(0, gap)}</td>
                  </tr>`;

              // --- 2. 渲染 <表2-2> (任務完成明細) ---
              let detailHtml = '';
              DETAIL_TASK_KEYS.forEach(key => {
                  const progress = detailProgress[key];
                  const total = progress.reduce((a, b) => a + b, 0);
                  detailHtml += `
                      <tr>
                          <td class="item-col">${DETAIL_TASK_NAMES[key] || key}</td>
                          ${progress.map((p, i) => `<td>${createClickableSpan(p, 'Detail', i + 8, key)}</td>`).join('')}
                          <td class="highlight">${createClickableSpan(total, 'Detail', 'all', key)}</td>
                      </tr>`;
              });
              dom.kpiTableBodyDetail.innerHTML = detailHtml;

              // --- 3. 渲染 <表2-3> (B2C 任務匯總) ---
              const b2cTotal = b2cSummary.reduce((a, b) => a + b, 0);
              dom.kpiTableBodyB2C.innerHTML = `
                  <tr class="total-row">
                      <td class="item-col">B2C 匯總</td>
                      ${b2cSummary.map((p, i) => `<td>${createClickableSpan(p, 'B2C', i + 8)}</td>`).join('')}
                      <td class="highlight">${createClickableSpan(b2cTotal, 'B2C', 'all')}</td>
                  </tr>`;

              // --- 4. 渲染 <表2-4> (B2B 任務匯總) ---
              const b2bTotal = b2bSummary.reduce((a, b) => a + b, 0);
              dom.kpiTableBodyB2B.innerHTML = `
                  <tr class="total-row">
                      <td class="item-col">B2B 匯總</td>
                      ${b2bSummary.map((p, i) => `<td>${createClickableSpan(p, 'B2B', i + 8)}</td>`).join('')}
                      <td class="highlight">${createClickableSpan(b2bTotal, 'B2B', 'all')}</td>
                  </tr>`;
          }
          // --- 結束修改 ---
          // --- 結束 JS 修改 5 ---

          function renderIndividualSigningProgress(stats) {
                 const tableBody = document.getElementById('individual-signing-body');
                 if(!tableBody) return;
                  // --- 修改：根據 total 數值降冪排序 ---
                 stats.sort((a, b) => b.total - a.total);
                 // --- 結束修改 ---
                 tableBody.innerHTML = stats.map((row, index) => {
                     const rate = row.rate.toFixed(1);
                     return `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b">
                         <td class="px-6 py-4 font-medium text-gray-900">${row.name}</td>
                         <td class="px-6 py-4">${row.total}</td>
                         <td class="px-6 py-4">${row.signed}</td>
                         <td class="px-6 py-4"><div class="flex items-center">
                             <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                <div class="${rate >= 80 ? 'bg-green-600' : rate >= 50 ? 'bg-yellow-400' : 'bg-red-500'} h-2.5 rounded-full" style="width: ${rate}%"></div>
                             </div>
                             <span class="font-medium">${rate}%</span>
                         </div></td>
                     </tr>`;
                 }).join('');
          }


          // --- 修改：渲染表4時，只渲染 A, B, C 級 ---
          function renderPublisherTierProgress(progressData) {
              const container = document.getElementById('progress-cards-container');
              const filter = document.getElementById('progress-filter');
              if(!container || !filter) return;

              const staffInFilter = Object.keys(progressData).sort();

              // 只渲染有 A, B, C 級資料的卡片
              container.innerHTML = staffInFilter.map(name => createProgressCardHTML(name, progressData[name])).filter(html => html).join('') || '<p class="text-center text-gray-500 col-span-full">無資料可顯示。</p>';

              const currentFilterValue = filter.value;
              filter.innerHTML = `<option value="all">顯示全部同仁</option>${staffInFilter.map(name => `<option value="${name}">${name}</option>`).join('')}`;
              filter.value = staffInFilter.includes(currentFilterValue) ? currentFilterValue : 'all';
              filter.dispatchEvent(new Event('change'));

              applyHealthCheck();
          }
          // --- 結束修改 ---

          function renderIndividualContactProgress(stats) {
                 const container = document.getElementById('individual-contact-cards-container');
                 if(!container) return;
                  // --- 修改：根據 total 數值降冪排序 ---
                 stats.sort((a, b) => b.total - a.total);
                 // --- 結束修改 ---
                 container.innerHTML = stats.map(row => {
                     const rate = row.rate.toFixed(0);
                     return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
                         <h3 class="font-semibold text-gray-800">${row.name}</h3>
                         <p class="text-sm text-gray-500 mb-4">單位聯繫進度</p>
                         <div class="flex justify-between items-center text-sm mb-1"><span>進度</span><span class="font-bold">${rate}%</span></div>
                         <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${rate}%;"></div></div>
                         <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between text-sm">
                             <span class="text-gray-600">已聯繫: <strong class="text-gray-900">${row.contacted}</strong></span>
                             <span class="text-gray-600">總單位: <strong class="text-gray-900">${row.total}</strong></span>
                         </div>
                     </div>`;
                 }).join('');
            }


          // --- Helper 函式 ---
          function createPublisherRowHtml(pub, index) {
              if (!pub) {
                  console.error("Attempted to render an invalid publisher at index:", index);
                  return "";
              }
              try {
                  const tasks = pub.tasks || {};
                  const taskCells = taskColumns.map(taskKey => {
                      const dateValue = tasks[taskKey] || '';
                      return `<td class="px-3 py-2 border-b border-gray-200 align-top">
                                  <span class="date-display ${dateValue ? '' : 'empty'}">${dateValue || '---'}</span>
                              </td>`;
                  }).join('');
                  const isSelected = state.selectedPublisherIds.has(pub.id);

                  let missionTagsHtml = '---';
                  if (Array.isArray(pub.missionTags) && pub.missionTags.length > 0) {
                      missionTagsHtml = pub.missionTags.join(', ');
                  }

                  return `
                  <tr class="bg-white hover:bg-gray-50 ${isSelected ? 'bg-indigo-50' : ''}" data-id="${pub.id}">
                      <td class="px-3 py-2 border-b border-gray-200 checkbox-col admin-only align-top" style="display: ${state.currentRole === 'admin' ? 'table-cell' : 'none'};">
                        <input type="checkbox" class="row-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-id="${pub.id}" ${isSelected ? 'checked' : ''}>
                      </td>
                      <td class="px-3 py-2 border-b border-gray-200 row-number-col align-top">${index + 1}</td>
                      <td class="px-3 py-3 font-medium text-gray-900 border-b border-gray-200 align-top col-publisher-name">${pub.name || 'N/A'}</td>
                      <td class="px-3 py-3 border-b border-gray-200 align-top col-contract-id">${pub.contractId || '---'}</td>
                      <td class="px-3 py-3 border-b border-gray-200 align-top col-staff">${pub.staff || 'N/A'}</td>
                      <td class="px-3 py-3 border-b border-gray-200 align-top col-tier">${pub.tier || 'N/A'}</td>
                      <td class="px-3 py-3 border-b border-gray-200 align-top">${pub.contactStatus || 'N/A'}</td>
                      <td class="px-3 py-2 border-b border-gray-200 align-top col-mission-tags">${missionTagsHtml}</td>
                      ${taskCells}
                      <td class="px-3 py-2 border-b border-gray-200 align-top col-action">
                          <button class="delete-row-btn admin-only text-sm bg-red-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-red-600" style="display: ${state.currentRole === 'admin' ? 'inline-block' : 'none'};">刪除</button>
                      </td>
                  </tr>`;
              } catch (error) {
                  console.error("Error in createPublisherRowHtml for publisher:", pub, error);
                  return `<tr><td colspan="20" class="text-center py-4 text-red-600">渲染此列時發生錯誤</td></tr>`;
              }
          }


          // --- 修改：篩選邏輯更新 ---
          function getFilteredAndSortedData() {
              let data = [...state.publishers];
              // Search Filter
              if (state.filters.search) {
                  const searchTerm = state.filters.search.toLowerCase();
                  data = data.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.contractId && p.contractId.toLowerCase().includes(searchTerm)));
              }
              // Multi-Select Filters
              if (state.filters.staff.length > 0) {
                  data = data.filter(p => state.filters.staff.includes(p.staff || '未分配')); // 考慮 '未分配'
              }
              if (state.filters.tier.length > 0) {
                  data = data.filter(p => state.filters.tier.includes(p.tier));
              }
              if (state.filters.status.length > 0) {
                  data = data.filter(p => state.filters.status.includes(p.contactStatus));
              }
              // --- 結束修改 ---

              // Sort
              data.sort((a, b) => {
                  let valA = a[state.sort.by] || '';
                  let valB = b[state.sort.by] || '';
                  if (Array.isArray(valA)) valA = valA.join(', ');
                  if (Array.isArray(valB)) valB = valB.join(', ');

                  if (valA < valB) return state.sort.order === 'asc' ? -1 : 1;
                  if (valA > valB) return state.sort.order === 'asc' ? 1 : -1;
                  return 0;
              });
              return data;
          }


          function updateCheckboxesAfterRender() {
              if (state.currentRole !== 'admin') return;

              const allCheckboxes = dom.masterListBody.querySelectorAll('.row-checkbox');
              const allVisibleIds = Array.from(allCheckboxes).map(cb => cb.dataset.id);
              const allVisibleSelected = allVisibleIds.length > 0 && allVisibleIds.every(id => state.selectedPublisherIds.has(id));
              dom.selectAllCheckbox.checked = allVisibleSelected;
              dom.selectAllCheckbox.indeterminate = !allVisibleSelected && allVisibleIds.some(id => state.selectedPublisherIds.has(id));

              allCheckboxes.forEach(checkbox => {
                 checkbox.checked = state.selectedPublisherIds.has(checkbox.dataset.id);
                 checkbox.closest('tr').classList.toggle('bg-indigo-50', checkbox.checked);
              });

              updateDeleteSelectedButtonState();
          }

          function columnIndexToLetter(index) {
                let letter = '';
                let tempIndex = index;
                while (tempIndex >= 0) {
                    letter = String.fromCharCode((tempIndex % 26) + 65) + letter;
                    tempIndex = Math.floor(tempIndex / 26) - 1;
                }
                return letter;
          }

          function renderColLetterHeader() {
               if (!dom.colLetterHeader) return;
               const headerCells = document.querySelector('#content-publisher-master thead tr:last-child').cells;
               let letterHtml = '';
               // G 欄之前的欄位數: Checkbox(1) + #(1) + A(1) + B(1) + C(1) + D(1) + E(1) + F(1) = 8
               // 但 A-F 才是我們要算的
               const fixedColCount = 6; // A-F
               const firstColspan = (state.currentRole === 'admin' ? 1 : 0) + 1; // Checkbox + #
               letterHtml += `<th colspan="${firstColspan}" class="px-3 py-2 border-b border-gray-200"></th>`;

               let letterIndex = 0;
               // A-F (固定欄)
               for (let i = 0; i < fixedColCount; i++) {
                   letterHtml += `<th class="px-3 py-2 border-b border-gray-200">${columnIndexToLetter(letterIndex)}</th>`;
                   letterIndex++;
               }
               // G-Q (動態任務欄)
               for (let i = 0; i < taskColumns.length; i++) {
                   letterHtml += `<th class="px-3 py-2 border-b border-gray-200">${columnIndexToLetter(letterIndex)}</th>`;
                   letterIndex++;
               }
               // 操作欄
               letterHtml += `<th class="px-3 py-2 border-b border-gray-200"></th>`;

               dom.colLetterHeader.innerHTML = letterHtml;
          }
           function updateColLetterHeaderColspan() {
               if (!dom.colLetterHeader) return;
               const firstCell = dom.colLetterHeader.cells[0];
               if (firstCell) {
                  const firstColspan = (state.currentRole === 'admin' ? 1 : 0) + 1;
                  firstCell.colSpan = firstColspan;
               }
          }

          // --- 事件監聽器設定 ---
          function setupEventListeners() {
              // Navigation Links
              Object.keys(dom.navLinks).forEach(key => {
                  if(dom.navLinks[key]) {
                      dom.navLinks[key].addEventListener('click', (e) => { e.preventDefault(); switchContent(key); });
                  }
              });

              // Search Filter
              dom.searchInput.addEventListener('input', e => { state.filters.search = e.target.value; renderAll(); });

              // --- 修改：複選下拉選單事件 ---
              // Staff Filter Events
              dom.staffFilterButton.addEventListener('click', (e) => {
                  e.stopPropagation();
                  toggleDropdown('staff');
              });
              dom.staffFilterDropdown.addEventListener('change', (e) => {
                  if (e.target.type === 'checkbox') {
                      updateMultiSelectState('staff', e.target.value, e.target.checked);
                      renderAll();
                  }
              });

              // Tier Filter Events
              dom.tierFilterButton.addEventListener('click', (e) => {
                  e.stopPropagation();
                  toggleDropdown('tier');
              });
              dom.tierFilterDropdown.addEventListener('change', (e) => {
                  if (e.target.type === 'checkbox') {
                      updateMultiSelectState('tier', e.target.value, e.target.checked);
                      renderAll();
                  }
              });

              // Status Filter Events
              dom.statusFilterButton.addEventListener('click', (e) => {
                  e.stopPropagation();
                  toggleDropdown('status');
              });
              dom.statusFilterDropdown.addEventListener('change', (e) => {
                  if (e.target.type === 'checkbox') {
                      updateMultiSelectState('status', e.target.value, e.target.checked);
                      renderAll();
                  }
              });

              // Click outside to close dropdowns
              document.addEventListener('click', closeAllDropdowns);
              // --- 結束修改 ---

              // Clear Filters Button
              document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);

              // Table Header Sorting
              document.querySelector('#content-publisher-master thead').addEventListener('click', handleSort);
              // Table Body Actions (Checkbox, Delete)
              dom.masterListBody.addEventListener('change', handleRowChange); // Handles checkbox changes
              dom.masterListBody.addEventListener('click', handleRowClick); // Handles delete button clicks

              // Select All Checkbox
              dom.selectAllCheckbox.addEventListener('change', handleSelectAllChange);
              // Delete Selected Button
              dom.deleteSelectedBtn.addEventListener('click', handleDeleteSelectedClick);

              // Import/Export Buttons
              document.getElementById('download-template-btn').addEventListener('click', downloadTemplate);
              document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('file-input').click());
              document.getElementById('file-input').addEventListener('change', handleFileImport);

              // Modals Closing
              document.getElementById('close-publisher-list-btn').addEventListener('click', () => closeModal(dom.publisherListModal, dom.publisherListModalContent));
              dom.publisherListModal.addEventListener('click', e => { if (e.target === dom.publisherListModal) closeModal(dom.publisherListModal, dom.publisherListModalContent); });
              document.getElementById('close-alert-modal-btn').addEventListener('click', () => closeModal(dom.alertModal, dom.alertModalContent));
              dom.alertModal.addEventListener('click', e => { if (e.target === dom.alertModal) closeModal(dom.alertModal, dom.alertModalContent); });
              dom.cancelConfirmBtn.addEventListener('click', closeConfirmModal);
              dom.confirmModal.addEventListener('click', e => { if (e.target === dom.confirmModal) closeConfirmModal(); });

              // Tier Progress Card Filter/Click
              document.getElementById('progress-filter').addEventListener('change', handleTierProgressFilter);
              document.getElementById('progress-cards-container').addEventListener('click', handleTierCardClick);

              // --- JS 修改 6: (替換) 更新點擊事件處理 ---
              // KPI Progress Click (Table 2-1 to 2-4)
              document.getElementById('content-team-signing').addEventListener('click', handleKpiProgressClick);
              // --- 結束 JS 修改 6 ---

              // Export Selected Button
              document.getElementById('export-selected-btn').addEventListener('click', handleExport);

              // Sidebar Toggle
              dom.sidebarToggle.addEventListener('click', toggleSidebar);
          }


          // --- 事件處理函式 ---
          function switchContent(targetId) {
              dom.mainTitle.textContent = pageTitles[targetId];
              Object.values(dom.navLinks).forEach(link => {
                  if (link) link.classList.remove('bg-indigo-600', 'text-white', 'shadow-sm');
              });
              if(dom.navLinks[targetId]) {
                dom.navLinks[targetId].classList.add('bg-indigo-600', 'text-white', 'shadow-sm');
              }
              Object.values(dom.contentSections).forEach(section => {
                  if (section) section.classList.add('hidden');
              });
              if(dom.contentSections[targetId]) {
                dom.contentSections[targetId].classList.remove('hidden');
                if (targetId === 'admin') {
                   fetchUsers();
                }
              } else {
                  console.warn(`Content section for "${targetId}" not found.`);
              }
          }

          // --- 修改：清除篩選邏輯 ---
          function clearFilters() {
              state.filters = { search: '', staff: [], tier: [], status: [] };
              dom.searchInput.value = '';
              // Uncheck all checkboxes
              const filterCheckboxes = document.querySelectorAll('.multi-select-dropdown input[type="checkbox"]');
              filterCheckboxes.forEach(cb => cb.checked = false);
              // Reset button texts
              updateFilterButtonText('staff');
              updateFilterButtonText('tier');
              updateFilterButtonText('status');
              state.selectedPublisherIds.clear(); // 清除表格選取
              renderAll();
          }
          // --- 結束修改 ---

          function handleSort(e) {
              const header = e.target.closest('.sortable-header');
              if (!header) return;

              const sortBy = header.dataset.sort;
              if (state.sort.by === sortBy) {
                  state.sort.order = state.sort.order === 'asc' ? 'desc' : 'asc';
              } else {
                  state.sort.by = sortBy;
                  state.sort.order = 'asc';
              }
              document.querySelectorAll('.sortable-header').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
              header.classList.add(state.sort.order === 'asc' ? 'sort-asc' : 'sort-desc');
              renderAll();
          }

          function handleRowChange(e) {
              const row = e.target.closest('tr');
              if (!row || !row.dataset.id) return;

              if (e.target.classList.contains('row-checkbox')) {
                  const checkbox = e.target;
                  const docId = checkbox.dataset.id;
                  if (checkbox.checked) {
                      state.selectedPublisherIds.add(docId);
                      row.classList.add('bg-indigo-50');
                  } else {
                      state.selectedPublisherIds.delete(docId);
                      row.classList.remove('bg-indigo-50');
                  }
                  updateCheckboxesAfterRender();
              }
          }

          async function handleRowClick(e) {
              const target = e.target;
              const row = target.closest('tr');
              if (!row || !row.dataset.id) return;
              const docId = row.dataset.id;
              
              if (target.classList.contains('delete-row-btn')) {
                  const publisherNameCell = row.querySelector('.col-publisher-name');
                  const publisherName = publisherNameCell ? publisherNameCell.textContent : '該出版社';
                  openConfirmModal(`您確定要刪除出版社「${publisherName}」嗎？此操作無法復原。`, () => {
                      deleteSinglePublisher(docId);
                  });
              }
          }

          // --- JS 修改 7: (替換) 更新點擊事件處理 ---
          // --- 修改：(表2重構) 重寫 KPI 點擊事件處理 ---

          // 輔助函數：取得 publisher 在 8-12 月的首次完成月份
          function getPublisherFirstCompletionMonth(pub, taskKeys) {
              let earliestMonth = null;
              if (!pub.tasks) return null;
              
              for (const taskKey of taskKeys) {
                  const dateStr = pub.tasks[taskKey];
                  if (dateStr) {
                      const date = new Date(normalizeDate(dateStr));
                      if (!isNaN(date.getTime())) {
                          const month = date.getMonth() + 1;
                          if (month >= 8 && month <= 12) {
                              if (earliestMonth === null || month < earliestMonth) {
                                  earliestMonth = month;
                              }
                          }
                      }
                  }
              }
              return earliestMonth;
          }

          // 輔助函數：檢查 publisher 是否在指定月份完成了特定任務
          function checkTaskCompletionInMonth(pub, taskKey, targetMonth) {
              if (!pub.tasks || !pub.tasks[taskKey]) return false;
              const date = new Date(normalizeDate(pub.tasks[taskKey]));
              if (isNaN(date.getTime())) return false;
              
              const month = date.getMonth() + 1;
              if (targetMonth === 'all') {
                  return month >= 8 && month <= 12;
              }
              return month === parseInt(targetMonth, 10);
          }


          function handleKpiProgressClick(e) {
              const target = e.target.closest('.kpi-progress-link');
              if (!target || target.dataset.count === '0') {
                  return;
              }

              const kpiItem = target.dataset.kpiItem; // Main, Detail, B2C, B2B
              const month = target.dataset.month; // 8-12, or 'all'
              const taskKey = target.dataset.taskKey; // Only for 'Detail'

              if (!kpiItem || !month) return;

              let filteredPublishers = [];
              let title = '';
              const monthStr = (month === 'all') ? '8-12月' : `${month}月`;

              switch (kpiItem) {
                  case 'Main':
                      // 表2-1: 尋找 "不重複" 且 "首次完成" 在該月的 publisher
                      const targetMonthInt = (month === 'all') ? null : parseInt(month, 10);
                      const uniquePubsMain = new Map();
                      
                      state.publishers.forEach(pub => {
                          const firstMonth = getPublisherFirstCompletionMonth(pub, taskColumns);
                          if (firstMonth) {
                              if (month === 'all' || firstMonth === targetMonthInt) {
                                  uniquePubsMain.set(pub.id, pub);
                              }
                          }
                      });
                      filteredPublishers = Array.from(uniquePubsMain.values());
                      title = `${monthStr} - 總體進度 (不重複 ${filteredPublishers.length} 家)`;
                      break;

                  case 'Detail':
                      // 表2-2: 尋找 "家次"，但清單顯示不重複的 publisher
                      if (!taskKey) return;
                      const uniquePubsDetail = new Map();
                      
                      state.publishers.forEach(pub => {
                          if (checkTaskCompletionInMonth(pub, taskKey, month)) {
                              uniquePubsDetail.set(pub.id, pub);
                          }
                      });
                      filteredPublishers = Array.from(uniquePubsDetail.values());
                      const taskName = DETAIL_TASK_NAMES[taskKey] || '任務';
                      title = `${monthStr} - ${taskName} ( ${filteredPublishers.length} 家)`;
                      break;

                  case 'B2C':
                  case 'B2B':
                      // 表2-3/2-4: 尋找 "家次" 對應的 "不重複" publisher
                      const keysToSearch = (kpiItem === 'B2C') ? B2C_TASK_KEYS : B2B_TASK_KEYS;
                      const uniquePubsSummary = new Map();

                      state.publishers.forEach(pub => {
                          for (const key of keysToSearch) {
                              if (checkTaskCompletionInMonth(pub, key, month)) {
                                  uniquePubsSummary.set(pub.id, pub);
                                  break; // 找到一個就跳出，確保 publisher 不重複
                              }
                          }
                      });
                      filteredPublishers = Array.from(uniquePubsSummary.values());
                      title = `${monthStr} - ${kpiItem} 任務匯總 ( ${filteredPublishers.length} 家)`;
                      break;
              }

              // --- 更新並顯示 Modal ---
              const listTitleEl = document.getElementById('publisher-list-title');
              if(listTitleEl) listTitleEl.textContent = title;

              const listBody = document.getElementById('publisher-list-body');
              if(listBody) {
                  // 依照要求，顯示出版社清單 (含同仁)
                  listBody.innerHTML = filteredPublishers.length > 0
                      ? filteredPublishers.map(p => `<li>${p.name} (${p.contractId || '無編號'}), <strong>${p.staff || '未分配'}</strong></li>`).join('')
                      : '<li>無符合條件的出版社</li>';
              }
              openModal(dom.publisherListModal, dom.publisherListModalContent);
          }
          // --- 結束修改 ---
          // --- 結束 JS 修改 7 ---


          // --- 刪除與選取相關函數 ---
          function handleSelectAllChange(e) {
              const isChecked = e.target.checked;
              const allVisibleCheckboxes = dom.masterListBody.querySelectorAll('.row-checkbox');

              allVisibleCheckboxes.forEach(checkbox => {
                  const docId = checkbox.dataset.id;
                  checkbox.checked = isChecked;
                  const row = checkbox.closest('tr');
                  if (isChecked) {
                      state.selectedPublisherIds.add(docId);
                      row.classList.add('bg-indigo-50');
                  } else {
                      state.selectedPublisherIds.delete(docId);
                       row.classList.remove('bg-indigo-50');
                  }
              });
               updateDeleteSelectedButtonState();
          }

          function updateDeleteSelectedButtonState() {
               dom.deleteSelectedBtn.disabled = state.selectedPublisherIds.size === 0;
               dom.deleteSelectedBtn.classList.toggle('opacity-50', state.selectedPublisherIds.size === 0);
               dom.deleteSelectedBtn.classList.toggle('cursor-not-allowed', state.selectedPublisherIds.size === 0);
          }

          function handleDeleteSelectedClick() {
               if (state.selectedPublisherIds.size === 0) return;

               openConfirmModal(`您確定要刪除選取的 ${state.selectedPublisherIds.size} 個出版社嗎？此操作無法復原。`, () => {
                   deleteSelectedPublishers();
               });
          }

          async function deleteSinglePublisher(docId) {
              if (!docId) return;
              const docRef = doc(state.publishersCollection, docId);
              try {
                  await deleteDoc(docRef);
                  state.selectedPublisherIds.delete(docId);
                  showToast("出版社刪除成功！", "success");
                  updateDeleteSelectedButtonState();
              } catch (error) {
                  console.error("刪除單一出版社失敗:", error);
                  showToast("刪除失敗", "error");
                  if (error.code === 'permission-denied') {
                     showAlert("權限不足，無法刪除。請確認 Firestore 安全規則。");
                  }
              }
          }

          async function deleteSelectedPublishers() {
              if (state.selectedPublisherIds.size === 0) return;

              const batch = writeBatch(state.db);
              state.selectedPublisherIds.forEach(id => {
                  const docRef = doc(state.publishersCollection, id);
                  batch.delete(docRef);
              });

              try {
                  await batch.commit();
                  showToast(`已成功刪除 ${state.selectedPublisherIds.size} 個出版社。`, "success");
                  state.selectedPublisherIds.clear();
                  updateCheckboxesAfterRender();
                  updateDeleteSelectedButtonState();
              } catch (error) {
                  console.error("批次刪除出版社失敗:", error);
                  showToast("批次刪除失敗", "error");
                   if (error.code === 'permission-denied') {
                     showAlert("權限不足，無法刪除。請確認 Firestore 安全規則。");
                  }
              }
          }


          // --- 使用者管理相關函數 ---
          async function fetchUsers() {
              if (state.auth.currentUser) {
                 const currentUserDocRef = doc(state.db, "artifacts", state.appId, "users", state.auth.currentUser.uid);
                 const currentUserDoc = await getDoc(currentUserDocRef);
                 if (!currentUserDoc.exists() || currentUserDoc.data().role !== 'admin') {
                    userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-red-500">權限不足，無法載入使用者清單。</td></tr>';
                    return;
                 }
                 userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-gray-500">正在載入使用者清單...</td></tr>';
                 try {
                     const usersCollectionRef = collection(state.db, "artifacts", state.appId, "users");
                     const querySnapshot = await getDocs(usersCollectionRef);
                     const users = [];
                     querySnapshot.forEach((doc) => {
                         users.push({
                             id: doc.id,
                             email: doc.data().email || `未知 Email (UID: ${doc.id})`,
                             role: doc.data().role
                         });
                     });
                     renderUserList(users);
                 } catch (error) {
                     console.error("載入使用者列表時發生錯誤:", error);
                     userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-red-500">載入使用者清單失敗，請檢查主控台錯誤訊息與 Firestore 安全規則。</td></tr>';
                     if (error.code === 'permission-denied') {
                         showAlert("權限不足，無法讀取使用者清單。請確認 Firestore 安全規則是否已更新並允許管理員讀取 users 集合。");
                     }
                 }
              }
          }

          function renderUserList(users) {
              if (!userListBody) return;
              if (users.length === 0) {
                 userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-gray-500">目前沒有其他使用者。</td></tr>';
                 return;
              }
              userListBody.innerHTML = users.map((user, index) => {
                 const isCurrentUser = user.id === state.auth.currentUser.uid;
                 return `
                 <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b" data-userid="${user.id}">
                     <td class="px-6 py-4 font-medium text-gray-900">${user.email} ${isCurrentUser ? '(您)' : ''}</td>
                     <td class="px-6 py-4">${user.role}</td>
                 </tr>`;
              }).join('');
          }

          // --- Modal & UI Helpers ---
          function openModal(modal, content) {
            if (modal && content) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => content.classList.add('open'), 10);
            } else { console.error("Modal or content element not found for openModal"); }
          }
          function closeModal(modal, content) {
            if (modal && content) {
                content.classList.remove('open');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
            } else { console.error("Modal or content element not found for closeModal"); }
          }
          function showAlert(message) {
            if(dom.alertModalText && dom.alertModal && dom.alertModalContent) {
                dom.alertModalText.textContent = message;
                openModal(dom.alertModal, dom.alertModalContent);
            } else { console.error("Alert modal elements not found for showAlert"); }
          }
          
          let confirmCallback = null;
          function openConfirmModal(message, onConfirm) {
              if(dom.confirmModalText && dom.confirmModal && dom.confirmModalContent) {
                  dom.confirmModalText.textContent = message;
                  confirmCallback = onConfirm;
                  dom.confirmActionBtn.removeEventListener('click', handleConfirmAction);
                  dom.confirmActionBtn.addEventListener('click', handleConfirmAction);
                  openModal(dom.confirmModal, dom.confirmModalContent);
              } else { console.error("Confirm modal elements not found for openConfirmModal"); }
          }
          function closeConfirmModal() {
              if(dom.confirmModal && dom.confirmModalContent) {
                 closeModal(dom.confirmModal, dom.confirmModalContent);
                 confirmCallback = null;
              }
          }
          function handleConfirmAction() {
              if (typeof confirmCallback === 'function') {
                  confirmCallback();
              }
              closeConfirmModal();
          }


          function showToast(message, type = "info") {
              const toast = document.getElementById('toast');
              const toastContent = document.getElementById('toast-content');
              if (!toast || !toastContent) return;
              const icons = {
                  success: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>`,
                  error: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>`,
                  warning: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-orange-500 bg-orange-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.22 3.001-1.742 3.001H4.42c-1.522 0-2.492-1.667-1.742-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></div>`
              };
              toastContent.innerHTML = `${icons[type] || ''}<div class="ml-3 text-sm font-normal">${message}</div>`;
              toast.classList.add('show');
              setTimeout(() => { toast.classList.remove('show'); }, 3000);
          }

          // --- 修改：複選下拉選單相關函數 ---
          function setupFilters() {
              // Populate Staff Filter
              // 從 publishers 動態獲取 staff 列表並排序
              const currentStaffList = ['未分配', ...Array.from(new Set(state.publishers.map(p => p.staff).filter(Boolean)))].sort((a,b) => a === '未分配' ? 1 : b === '未分配' ? -1 : a.localeCompare(b, 'zh-Hant'));
              if(dom.staffFilterDropdown) {
                  dom.staffFilterDropdown.innerHTML = currentStaffList.map(s => `
                      <label>
                          <input type="checkbox" value="${s}" ${state.filters.staff.includes(s) ? 'checked' : ''}>
                          <span>${s}</span>
                      </label>`).join('');
              }

              // Populate Tier Filter
              if(dom.tierFilterDropdown) {
                  dom.tierFilterDropdown.innerHTML = tierList.map(t => `
                      <label>
                          <input type="checkbox" value="${t}" ${state.filters.tier.includes(t) ? 'checked' : ''}>
                          <span>${t}級</span>
                      </label>`).join('');
              }

              // Populate Status Filter
              if(dom.statusFilterDropdown) {
                  dom.statusFilterDropdown.innerHTML = contactStatusList.map(s => `
                      <label>
                          <input type="checkbox" value="${s}" ${state.filters.status.includes(s) ? 'checked' : ''}>
                          <span>${s}</span>
                      </label>`).join('');
              }

              // Update button texts initially
              updateFilterButtonText('staff');
              updateFilterButtonText('tier');
              updateFilterButtonText('status');
          }

          function toggleDropdown(filterType) {
              const dropdown = dom[`${filterType}FilterDropdown`];
              if (!dropdown) return;
              const isOpen = dropdown.classList.contains('open');
              closeAllDropdowns(); // Close others first
              if (!isOpen) {
                  dropdown.classList.add('open');
              }
          }

          function closeAllDropdowns() {
              if (dom.staffFilterDropdown) dom.staffFilterDropdown.classList.remove('open');
              if (dom.tierFilterDropdown) dom.tierFilterDropdown.classList.remove('open');
              if (dom.statusFilterDropdown) dom.statusFilterDropdown.classList.remove('open');
          }

          function updateMultiSelectState(filterType, value, isChecked) {
              const filterArray = state.filters[filterType];
              if (isChecked) {
                  if (!filterArray.includes(value)) {
                      filterArray.push(value);
                  }
              } else {
                  const index = filterArray.indexOf(value);
                  if (index > -1) {
                      filterArray.splice(index, 1);
                  }
              }
              updateFilterButtonText(filterType);
          }

          function updateFilterButtonText(filterType) {
              const button = dom[`${filterType}FilterButton`];
              const filterArray = state.filters[filterType];
              const placeholder = button.querySelector('.placeholder');
              const countSpan = button.querySelector('.count'); // 可能需要新增這個 span
              const baseTextMap = {
                  staff: '同仁',
                  tier: '分級',
                  status: '狀態'
              };
              const baseText = baseTextMap[filterType] || '選項';

              if (!placeholder) return; // Basic check

              if (filterArray.length === 0) {
                  placeholder.textContent = `選擇${baseText}`;
                  placeholder.style.display = 'inline';
                  if (countSpan) countSpan.textContent = ''; // Clear count if exists
              } else {
                  placeholder.style.display = 'none';
                  // Dynamically create count span if it doesn't exist
                  let currentCountSpan = button.querySelector('.count');
                  if (!currentCountSpan) {
                      currentCountSpan = document.createElement('span');
                      currentCountSpan.className = 'count';
                      button.appendChild(currentCountSpan);
                  }
                  currentCountSpan.textContent = `${baseText} (${filterArray.length})`;
              }
          }
          // --- 結束修改 ---


          // --- XLSX Import/Export ---
          function downloadTemplate() {
                const baseHeaders = ["出版社名稱", "合約編號", "負責同仁", "分級", "聯繫狀態", "徵集組指定任務"];
                const taskHeaders = taskColumns.map(key => {
                   const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                   return headerEl ? headerEl.textContent : key;
                });
                const allHeaders = [...baseHeaders, ...taskHeaders];
                const exampleRow = [ "範例出版社", "EBK00001-1", "陳玫君", "A", "聯繫中", "未合作<書>,B2B重點", "2025-08-15", ...Array(taskColumns.length - 1).fill("") ];
                const worksheet = window.XLSX.utils.aoa_to_sheet([allHeaders, exampleRow]);
                const workbook = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(workbook, worksheet, "出版社");
                window.XLSX.writeFile(workbook, "匯入範本.xlsx");
          }

          function handleFileImport(event) {
              const file = event.target.files[0]; if (!file) return;
              const reader = new FileReader();
              reader.onload = async (e) => {
                  try {
                      const data = new Uint8Array(e.target.result);
                      const workbook = window.XLSX.read(data, { type: 'array' });
                      const sheetName = workbook.SheetNames[0];
                      const worksheet = workbook.Sheets[sheetName];
                      const records = window.XLSX.utils.sheet_to_json(worksheet);
                      if (!records || records.length === 0) { showToast("檔案為空或格式錯誤", "error"); return; }

                      const batch = writeBatch(state.db);
                      let createdCount = 0, updatedCount = 0;

                      for (const record of records) {
                          const publisherName = record["出版社名稱"];
                          if (!publisherName) continue;

                          const missionTag = record["徵集組指定任務"];
                          const missionTags = (missionTag && missionTag !== "不在指定任務範圍") ? missionTag.toString().split(',').map(t => t.trim()).filter(Boolean) : [];

                          const publisherData = {
                              name: publisherName,
                              contractId: record["合約編號"] || null,
                              staff: record["徵集"] || record["負責同仁"] || '未分配',
                              // --- 修改：匯入時若為 X 級，改存為 null 或 A (根據需求選擇) ---
                              tier: tierList.includes(record["分級"]) ? record["分級"] : 'A', // 如果不是 A, B, C，則預設為 A
                              // tier: tierList.includes(record["分級"]) ? record["分級"] : null, // 或者設為 null
                              // --- 結束修改 ---
                              contactStatus: record["聯繫狀態"] || '未聯繫',
                              missionTags: missionTags,
                              tasks: {}
                          };
                          taskColumns.forEach(key => {
                              const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                              const headerText = headerEl ? headerEl.textContent : key;
                              if (record[headerText] !== undefined) {
                                  publisherData.tasks[key] = normalizeDate(record[headerText]);
                              } else {
                                  publisherData.tasks[key] = null;
                              }
                          });

                          const existingPub = state.publishers.find(p => p.name === publisherName);
                          
                          if (existingPub) {
                              const docRef = doc(state.publishersCollection, existingPub.id);
                              // 合併 tasks，但確保匯入檔案中的 null/空值 會覆蓋掉舊資料
                              const mergedTasks = { ...existingPub.tasks }; // 複製一份舊的
                              taskColumns.forEach(key => {
                                  const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                                  const headerText = headerEl ? headerEl.textContent : key;
                                  // 只有當匯入檔案中有定義此欄位時才更新 (允許用空值覆蓋)
                                  if (record.hasOwnProperty(headerText)) {
                                     mergedTasks[key] = normalizeDate(record[headerText]);
                                  }
                              });
                              publisherData.tasks = mergedTasks;
                              batch.set(docRef, publisherData);
                              updatedCount++;
                          } else {
                              const docRef = doc(state.publishersCollection);
                              batch.set(docRef, publisherData);
                              createdCount++;
                          }
                      }
                      await batch.commit();
                      showToast(`匯入完成：${createdCount} 筆新增，${updatedCount} 筆更新`, "success");
                  } catch (error) {
                      showToast("檔案處理失敗，請確認格式", "error");
                      console.error("Error processing XLSX:", error);
                  } finally {
                      event.target.value = '';
                  }
              };
              reader.readAsArrayBuffer(file);
          }

          function normalizeDate(value) {
              if (value === null || typeof value === 'undefined' || value === '') return null; // 空字串也視為 null
              if (typeof value === 'string') {
                  value = value.trim().replace(/\//g, '-');
                   if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                       const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                           return value;
                       }
                   }
                   // 嘗試更寬鬆的解析 (但不保證準確性，特別是 M-D-Y vs D-M-Y)
                   const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                       const year = date.getFullYear();
                       // 基本的年份檢查，防止 Excel 誤判
                       if (year < 1900 || year > 2100) {
                           console.warn(`日期字串 "${value}" 解析出的年份 (${year}) 不合理，已忽略。`);
                           return null;
                       }
                       const month = (date.getMonth() + 1).toString().padStart(2, '0');
                       const day = date.getDate().toString().padStart(2, '0');
                       return `${year}-${month}-${day}`;
                    }
              }
              if (typeof value === 'number') {
                   if (value > 25569 && Number.isInteger(value)) { // Excel 日期數字
                       if (value > 60) value--;
                       const excelEpoch = new Date(1899, 11, 30);
                       const date = new Date(excelEpoch.getTime() + value * 24 * 60 * 60 * 1000);
                       if (!isNaN(date.getTime())) {
                           const year = date.getFullYear();
                           const month = (date.getMonth() + 1).toString().padStart(2, '0');
                           const day = date.getDate().toString().padStart(2, '0');
                           return `${year}-${month}-${day}`;
                       }
                   } else {
                       console.warn(`數字 ${value} 不像有效的 Excel 日期序列號，已忽略。`);
                       return null;
                   }
              }
               if (value instanceof Date) {
                  if (!isNaN(value.getTime())) {
                      const year = value.getFullYear();
                      const month = (value.getMonth() + 1).toString().padStart(2, '0');
                      const day = value.getDate().toString().padStart(2, '0');
                      return `${year}-${month}-${day}`;
                  }
               }
                console.warn(`無法將值 "${value}" (類型: ${typeof value}) 正常化為 YYYY-MM-DD 日期格式。`);
               return null;
            }

          // --- 表四 & 表五 Card 相關函式 ---
          function handleTierProgressFilter(e) {
              const selectedValue = e.target.value;
              document.querySelectorAll('.progress-card').forEach(card => {
                  card.style.display = (selectedValue === 'all' || card.dataset.name === selectedValue) ? '' : 'none';
              });
          }

          function handleTierCardClick(e) {
              const statEl = e.target.closest('.clickable-stat');
              if (!statEl) return;

              const cell = statEl.closest('td');
              const row = statEl.closest('tr');
              const card = statEl.closest('.progress-card');

              const staff = card.dataset.name;
              const tier = row.dataset.tier;
              const status = cell.dataset.stage;

              const filtered = state.publishers.filter(p => (p.staff || '未分配') === staff && p.tier === tier && p.contactStatus === status);

              const listTitleEl = document.getElementById('publisher-list-title');
              if(listTitleEl) listTitleEl.textContent = `${staff} - ${tier}級 - ${status}`;

              const listBody = document.getElementById('publisher-list-body');
              if(listBody) {
                  listBody.innerHTML = filtered.length > 0
                      ? filtered.map(p => `<li>${p.name} (${p.contractId || '無編號'})</li>`).join('')
                      : '<li>無符合條件的出版社</li>';
              }

              openModal(dom.publisherListModal, dom.publisherListModalContent);
          }


          // --- 修改：createProgressCardHTML 只處理 A, B, C ---
          function createProgressCardHTML(name, data) {
                 let totalRow = { "母體數": 0 };
                 contactStatusList.forEach(s => totalRow[s] = 0);

                 // 只迭代 A, B, C
                 let tableBody = tierList.map(tier => {
                     const tierData = data[tier];
                     // 如果沒有該級別資料或總數為0，直接返回空字串
                     if (!tierData || tierData.total === 0) return '';

                     let stageHtml = '';
                     contactStatusList.forEach(stage => {
                         const value = tierData.stages[stage] || 0;
                         const percentage = tierData.total > 0 ? (value / tierData.total * 100).toFixed(0) : 0;
                         stageHtml += `<td data-stage="${stage}" data-value="${value}"><span class="clickable-stat">${value}</span><span class="percentage">(${percentage}%)</span></td>`;
                         totalRow[stage] += value;
                     });
                     totalRow["母體數"] += tierData.total;
                     return `<tr class="border-b" data-tier="${tier}"><td class="px-3 py-3 font-medium text-gray-900 text-left">${tier}級</td>${stageHtml}<td class="font-bold bg-gray-50 text-gray-800">${tierData.total}</td></tr>`;
                 }).join('');

                 // 如果 A, B, C 都沒有資料，則不顯示此卡片
                 if (totalRow["母體數"] === 0) return '';

                 return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 progress-card" data-name="${name}"><h3 class="text-xl font-bold text-gray-800 mb-4">${name}</h3><div class="overflow-x-auto"><table class="w-full text-xs text-center text-gray-600"><thead class="bg-gray-100 text-gray-700 uppercase"><tr><th class="px-3 py-3 text-left">分級</th>${contactStatusList.map(s => `<th class="px-3 py-3">${s.replace('已聯繫，','')}</th>`).join('')}<th class="px-3 py-3 bg-gray-200 font-bold">母體數</th></tr></thead><tbody>${tableBody}<tr class="bg-gray-100 font-bold"><td class="px-3 py-4 text-gray-900 text-left">總計</td>${contactStatusList.map(s => `<td>${totalRow[s]}</td>`).join('')}<td class="bg-indigo-100 text-indigo-800">${totalRow["母體數"]}</td></tr></tbody></table></div></div>`;
            }
            // --- 結束修改 ---


          function applyHealthCheck() {
              document.querySelectorAll('.progress-card').forEach(card => {
                  const aTierRow = card.querySelector('tr[data-tier="A"]');
                  if (aTierRow) {
                      const notContactedCell = aTierRow.querySelector('td[data-stage="未聯繫"]');
                      if(!notContactedCell) return;
                      const totalCell = aTierRow.cells[aTierRow.cells.length - 1];
                      if(!totalCell) return;

                      const total = parseInt(totalCell.textContent);
                      const notContactedCount = parseInt(notContactedCell.dataset.value);
                      const percentage = total > 0 ? (notContactedCount / total) * 100 : 0;

                      notContactedCell.classList.remove('health-warning', 'health-critical');
                      if (percentage >= 50) notContactedCell.classList.add('health-critical');
                      else if (percentage >= 25) notContactedCell.classList.add('health-warning');
                  }
              });
          }

          // --- Export Handler ---
           function handleExport() {
                 const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="export-option"]:checked'));
                 if(selectedCheckboxes.length === 0) {
                     showToast("請至少選擇一個要匯出的報表", "warning");
                     return;
                 }

                 const workbook = window.XLSX.utils.book_new();

                 const infoSheetData = [
                    ["報表匯出資訊"],
                    ["匯出日期", new Date().toLocaleString()],
                    [""],
                    ["篩選條件"],
                    ["搜尋關鍵字", state.filters.search || "(無)"],
                    // --- 修改：匯出時顯示複選內容 ---
                    ["負責同仁", state.filters.staff.length > 0 ? state.filters.staff.join(', ') : "(全部)"],
                    ["分級", state.filters.tier.length > 0 ? state.filters.tier.join(', ') : "(全部)"],
                    ["聯繫狀態", state.filters.status.length > 0 ? state.filters.status.join(', ') : "(全部)"],
                    // --- 結束修改 ---
                    [""],
                    ["匯出的報表"],
                    ...selectedCheckboxes.map(cb => [cb.nextElementSibling.textContent.trim()])
                 ];
                 const infoSheet = window.XLSX.utils.aoa_to_sheet(infoSheetData);
                 infoSheet['!cols'] = [{ wch: 30 }, { wch: 30 }];
                 window.XLSX.utils.book_append_sheet(workbook, infoSheet, "匯出資訊");

                const exportFunctions = {
                    table1: getPublisherMasterDataForExport,
                    table2: getTeamSigningDataForExport,
                    table3: getIndividualSigningDataForExport,
                    table4: getPublisherTierDataForExport,
                    table5: getIndividualContactDataForExport,
                };
                // --- 修改：sheetNames 物件中的表名 ---
                const sheetNames = {
                    table1: "表1_出版社母體管理",
                    table2: "表2_團隊簽約進度",
                    table3: "表3_個人簽約進度",
                    table4: "表4_分級聯繫進度",
                    table5: "表5_個人聯繫進度",
                };
                // --- 結束修改 ---

                selectedCheckboxes.forEach(checkbox => {
                    const optionValue = checkbox.value;
                    if(exportFunctions[optionValue]) {
                        const data = exportFunctions[optionValue]();
                        if (data && data.length > 0) {
                            const worksheet = window.XLSX.utils.json_to_sheet(data);
                            const cols = [];
                            if (data.length > 0) {
                                Object.keys(data[0]).forEach(key => {
                                    let maxLen = key.toString().length;
                                    data.forEach(row => {
                                        const cellValue = row[key] ? row[key].toString() : '';
                                        const charWidth = /[^\x00-\xff]/.test(cellValue) ? 1.8 : 1;
                                        maxLen = Math.max(maxLen, cellValue.length * charWidth);
                                    });
                                    cols.push({ wch: Math.min(maxLen + 2, 50) });
                                });
                            }
                            worksheet['!cols'] = cols;
                            window.XLSX.utils.book_append_sheet(workbook, worksheet, sheetNames[optionValue]);
                        } else {
                            const emptySheet = window.XLSX.utils.aoa_to_sheet([["此報表目前無資料可匯出"]]);
                             window.XLSX.utils.book_append_sheet(workbook, emptySheet, sheetNames[optionValue]);
                        }
                    }
                });

                 window.XLSX.writeFile(workbook, `徵集進度報表_${new Date().toISOString().slice(0,10)}.xlsx`);
                 showToast("報表匯出成功！", "success");
            }

            // --- Export Data Formatting ---
             function getPublisherMasterDataForExport() {
                 const fixedCols = 6;
                return getFilteredAndSortedData().map((pub, index) => {
                    let row = {
                        "#": index + 1,
                        "出版社名稱": pub.name,
                        "合約編號": pub.contractId || '',
                        "負責同仁": pub.staff,
                        "分級": pub.tier,
                        "聯繫狀態": pub.contactStatus,
                        "任務標籤": Array.isArray(pub.missionTags) ? pub.missionTags.join(', ') : ''
                    };
                    taskColumns.forEach((key, colIndex) => {
                        const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                        const headerText = headerEl ? headerEl.textContent : key;
                        const letterHeader = `${columnIndexToLetter(colIndex + fixedCols)}_${headerText}`;
                        row[letterHeader] = (pub.tasks && pub.tasks[key]) ? pub.tasks[key] : '';
                    });
                     row[`A_出版社名稱`] = row['出版社名稱']; delete row['出版社名稱'];
                     row[`B_合約編號`] = row['合約編號']; delete row['合約編號'];
                     row[`C_負責同仁`] = row['負責同仁']; delete row['負責同仁'];
                     row[`D_分級`] = row['分級']; delete row['分級'];
                     row[`E_聯繫狀態`] = row['聯繫狀態']; delete row['聯繫狀態'];
                     row[`F_任務標籤`] = row['任務標籤']; delete row['任務標籤'];

                     const orderedRow = { '#': row['#'] };
                     delete row['#'];

                     const colOrder = ['#', 'A_出版社名稱', 'B_合約編號', 'C_負責同仁', 'D_分級', 'E_聯繫狀態', 'F_任務標籤'];
                     taskColumns.forEach((key, colIndex) => {
                         const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                         const headerText = headerEl ? headerEl.textContent : key;
                         const letterHeader = `${columnIndexToLetter(colIndex + fixedCols)}_${headerText}`;
                         colOrder.push(letterHeader);
                     });

                     const finalRow = {};
                     colOrder.forEach(colKey => {
                         if (row.hasOwnProperty(colKey) || orderedRow.hasOwnProperty(colKey)) {
                            finalRow[colKey] = row[colKey] ?? orderedRow[colKey];
                         }
                     });

                    return finalRow;
                });
            }

            // --- (額外修正) 修正匯出邏輯 ---
            function getTeamSigningDataForExport() {
                // (表2重構) 匯出功能暫時只匯出 <表2-1>
                const header = ["項目", "8月", "9月", "10月", "11月", "12月", "總計"];
                const tableData = [];
                const bodyEl = document.getElementById('kpi-table-body-main');
                if (!bodyEl) return [{ "錯誤": "找不到表2-1的資料" }];

                // 讀取 <表2-1> 的 HTML 內容
                try {
                    const rows = bodyEl.rows;
                    if (rows.length < 4) return [{ "錯誤": "表2-1 資料不完整" }];

                    // 1. 目標
                    const targetData = { "項目": "目標" };
                    Array.from(rows[0].cells).slice(1).forEach((cell, i) => {
                        targetData[header[i+1]] = cell.textContent;
                    });
                    tableData.push(targetData);

                    // 2. 進度
                    const progressData = { "項目": "進度" };
                    Array.from(rows[1].cells).slice(1).forEach((cell, i) => {
                        progressData[header[i+1]] = cell.textContent;
                    });
                    tableData.push(progressData);

                    // 3. 達成率
                    const rateData = { "項目": "達成率" };
                    Array.from(rows[2].cells).slice(1).forEach((cell, i) => {
                        rateData[header[i+1]] = cell.textContent;
                    });
                    tableData.push(rateData);
                    
                    // 4. 缺口
                    const gapData = { "項目": "缺口" };
                    Array.from(rows[3].cells).slice(1).forEach((cell, i) => {
                        gapData[header[i+1]] = cell.textContent;
                    });
                    tableData.push(gapData);

                } catch (e) {
                    console.error("匯出 表2-1 失敗:", e);
                    return [{ "錯誤": "匯出 表2-1 失敗" }];
                }
                
                return tableData;
            }
            // --- 結束 (額外修正) ---


            function getIndividualSigningDataForExport() {
                // 先計算，再排序
                 const stats = state.analytics.individualSigningStats;
                 stats.sort((a, b) => b.total - a.total);
                return stats.map(row => ({
                    "負責人": row.name,
                    "負責單位數": row.total,
                    "已簽約": row.signed,
                    "簽約率(%)": Number(row.rate.toFixed(1)),
                }));
            }


            // --- 修改：移除 X 級的匯出 ---
            function getPublisherTierDataForExport() {
                 const flatData = [];
                 const progressData = state.analytics.tierProgressStats;
                 // 確保先排序 staff 再處理
                 Object.keys(progressData).sort().forEach(staffName => {
                     // 確保先排序 tier (A, B, C) 再處理
                     tierList.forEach(tier => { // tierList 已經移除了 'X'
                         if (progressData[staffName][tier]) {
                             const tierData = progressData[staffName][tier];
                             if (tierData.total > 0) {
                                 contactStatusList.forEach(stage => { // 使用預定義的 contactStatusList 確保順序
                                     const count = tierData.stages[stage] || 0;
                                     if (count > 0) {
                                         flatData.push({ "負責同仁": staffName, "分級": tier, "聯繫狀態": stage, "出版社數量": count });
                                     }
                                 });
                             }
                         }
                     });
                 });
                 return flatData;
            }
            // --- 結束修改 ---


            function getIndividualContactDataForExport(){
                 // 先計算，再排序
                 const stats = state.analytics.individualContactStats;
                 stats.sort((a, b) => b.total - a.total);
                return stats.map(row => ({
                    "負責人": row.name,
                    "總單位": row.total,
                    "已聯繫": row.contacted,
                    "聯繫率(%)": Number(row.rate.toFixed(0))
                }));
            }



           // --- 側邊欄切換函數 ---
           function toggleSidebar() {
               state.isSidebarCollapsed = !state.isSidebarCollapsed;
               applySidebarState();
           }

           function applySidebarState() {
                if (state.isSidebarCollapsed) {
                   dom.sidebar.classList.add('collapsed');
                   document.body.classList.add('sidebar-collapsed');
                } else {
                   dom.sidebar.classList.remove('collapsed');
                   document.body.classList.remove('sidebar-collapsed');
                }
           }
      });
  </script>
<script id="nx-boot">
(()=>{
  const apply = () => {
    const sidebar = document.getElementById('sidebar');
    const togglers = Array.from(document.querySelectorAll('#sidebarToggle,.sidebar-toggle,[data-action="toggle-sidebar"]'));
    if (sidebar) {
      const KEY = 'sidebarCollapsed';
      const saved = localStorage.getItem(KEY);
      if (saved === '1') sidebar.classList.add('collapsed');
      togglers.forEach(btn => {
        btn.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          localStorage.setItem(KEY, sidebar.classList.contains('collapsed') ? '1' : '0');
        });
      });
    }
    try {
      if (window.state) {
        if (!state.filters || typeof state.filters !== 'object') state.filters = {};
        for (const k of ['staff','tier','status']) {
          if (!Array.isArray(state.filters[k])) state.filters[k] = [];
        }
      }
    } catch (
