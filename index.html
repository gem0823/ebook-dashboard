<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖服部 中文電子書徵集進度儀表板</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 SheetJS 用於處理 XLSX (Excel) 檔案 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 使用 Inter 和 Noto Sans TC 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* 用於平滑切換的高度過渡效果 */
        .content-section {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            /* Ensure sections are positioned correctly for transitions */
            position: relative; /* Changed from absolute in original attempt */
            width: 100%;
        }
        .content-section.hidden {
            opacity: 0;
            transform: translateY(10px);
            /* Keep it in the layout flow but invisible and non-interactive */
            position: absolute; /* Keep absolute to allow stacking */
            visibility: hidden; /* Use visibility instead of display:none */
            pointer-events: none;
            width: 100%; /* Ensure it takes full width even when hidden */
        }
        /* Modal 動畫 */
        .modal-content.open {
            transform: scale(1);
            opacity: 1;
        }
        /* 表格滾動條樣式 */
        .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .table-container::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 3px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #818cf8; }

        /* 表頭任務類型顏色 */
        .task-header-new { background-color: #e0f2fe; color: #0c4a6e; } /* light-blue */
        .task-header-expand { background-color: #dcfce7; color: #166534; } /* light-green */

        /* 自定義日期輸入框 */
        input[type="date"] {
            border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem;
            font-size: 0.875rem; line-height: 1.25rem; min-width: 130px;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }
        input[type="date"]:invalid { color: #9ca3af; }

        /* KPI 表格樣式 */
        .kpi-table th, .kpi-table td { text-align: center; padding: 0.75rem 0.5rem; border: 1px solid #e5e7eb; }
        .kpi-table .header-group { background-color: #f3f4f6; font-weight: bold; }
        .kpi-table .header-sub { background-color: #f9fafb; font-size: 0.75rem; }
        .kpi-table .item-col { text-align: left; font-weight: bold; background-color: #f9fafb; }
        .kpi-table .total-row { font-weight: bold; background-color: #f3f4f6; }
        .kpi-table .highlight { background-color: #e0f2fe; }
        .kpi-table .gap-col { color: #dc2626; font-weight: bold; }

        /* 其他輔助樣式 */
        .percentage { color: #6b7280; font-size: 0.75rem; margin-left: 4px; }
        .clickable-stat { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; text-decoration-color: #9ca3af; transition: all 0.2s; }
        .clickable-stat:hover { color: #4f46e5; text-decoration-color: #4f46e5; }
        .health-warning { background-color: #fef9c3; color: #a16207; }
        .health-critical { background-color: #fee2e2; color: #b91c1c; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #f3f4f6; }
        .sort-asc::after { content: ' ▲'; font-size: 0.6em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.6em; }

        /* 任務標籤樣式 */
        .tag-badge {
            display: inline-block;
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            margin: 2px;
            white-space: nowrap;
        }

        /* Toast 提示框 */
        #toast {
            position: fixed; top: 20px; right: 20px;
            transform: translateX(200%); transition: transform 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show { transform: translateX(0); }

        /* Sidebar collapse styles */
        #sidebar.collapsed {
            width: 0;
            padding-left: 0;
            padding-right: 0;
            overflow: hidden;
        }
        #sidebar.collapsed > * {
            opacity: 0;
        }
        #sidebar > * {
            transition: opacity 0.2s ease-in-out;
            white-space: nowrap;
        }

        /* Task column collapse styles */
        #master-table.tasks-collapsed .task-col {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="w-full max-w-md">
            <div class="bg-white shadow-lg rounded-xl p-8">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">儀表板登入</h1>
                    <p class="text-sm text-gray-500 mt-2">請輸入您的帳號密碼</p>
                </div>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">帳號</label>
                            <input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                            <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden"></p>
                    <div class="mt-6">
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            登入
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Container (Initially hidden) -->
    <div id="dashboard-container" class="flex h-screen bg-gray-100 hidden">
        <!-- Collapsible Left Navigation -->
        <aside id="sidebar" class="w-64 bg-white shadow-md flex flex-col shrink-0 transition-all duration-300 ease-in-out">
            <div class="p-6 border-b">
                <h1 class="text-xl font-bold text-indigo-700">出版社管理</h1>
            </div>
            <nav id="main-nav" class="flex-1 px-4 py-6 space-y-2">
                <!-- Nav links will be populated by JS -->
            </nav>
            <div class="p-4 border-t mt-auto">
                <p class="text-xs text-gray-500">版本 v5.4.1 (Bug Fix)</p>
                <p class="text-xs text-gray-500">資料庫狀態: <span id="db-status" class="font-semibold text-gray-400">未連接</span></p>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 focus:outline-none mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 id="main-title" class="text-2xl font-bold text-gray-900">出版社母體管理</h2>
                </div>
                <div id="user-info" class="text-sm text-gray-600 flex items-center"></div>
            </header>

            <main class="flex-1 overflow-y-auto p-6 lg:p-8">
                <div class="relative"> <!-- Make this relative for absolute positioning of children -->
                    <!-- 模組一：出版社母體管理 -->
                    <section id="content-publisher-master" class="content-section">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h3 class="text-lg font-semibold text-gray-800">目標出版社清單</h3>
                                <div class="flex flex-wrap items-center gap-2">
                                    <button id="add-publisher-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 inline-flex items-center text-sm">
                                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                        新增出版社
                                    </button>
                                    <button id="download-template-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-700 transition-all duration-200 inline-flex items-center text-sm">
                                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                        下載範本
                                    </button>
                                    <button id="import-data-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 transition-all duration-200 inline-flex items-center text-sm">
                                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                        匯入資料
                                    </button>
                                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                                </div>
                            </div>
                            <!-- 搜尋與篩選 -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:flex-wrap items-end gap-4 mb-4 pb-4 border-b">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="search-input" class="block text-sm font-medium text-gray-700">關鍵字搜尋</label>
                                    <input type="text" id="search-input" placeholder="搜尋出版社、合約編號..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <label for="staff-filter" class="block text-sm font-medium text-gray-700">負責同仁</label>
                                    <select id="staff-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                                </div>
                                <div class="flex-1 min-w-[120px]">
                                    <label for="tier-filter" class="block text-sm font-medium text-gray-700">分級</label>
                                    <select id="tier-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                                </div>
                                <div class="flex-1 min-w-[180px]">
                                    <label for="status-filter" class="block text-sm font-medium text-gray-700">聯繫狀態</label>
                                    <select id="status-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                                </div>
                                <button id="clear-filters-btn" class="text-sm text-gray-600 hover:text-indigo-600 whitespace-nowrap">清除篩選</button>
                            </div>
                            <div class="flex items-center mb-2">
                                <h4 class="text-sm font-semibold text-gray-500">&lt;表一&gt;</h4>
                                <p class="ml-4 text-sm text-red-600 font-semibold">填寫規則：當「聯繫狀態」為「已簽回，已移交合約」時，必須至少填寫一項任務的完成日期。日期定義為【電子書合約正式移交日】：徵集同仁將該合約正本完成移交給後勤的日期（建議有合約移交信EMAIL佐證）。</p>
                            </div>
                            <div class="overflow-x-auto max-h-[65vh] table-container">
                                <table id="master-table" class="w-full text-sm text-left text-gray-600 border-collapse">
                                    <thead class="bg-gray-50 text-xs text-gray-700 uppercase sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle">Notion 紀錄</th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle sortable-header" data-sort="name">出版社名稱</th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle sortable-header" data-sort="contractId">合約編號</th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle sortable-header" data-sort="staff">負責同仁</th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle sortable-header" data-sort="tier">分級</th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle sortable-header" data-sort="contactStatus">聯繫狀態</th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle sortable-header" data-sort="missionTags">任務標籤</th>
                                            <th colspan="11" class="text-center p-2 border-b border-gray-200">
                                                任務完成日期
                                                <button id="task-toggle-btn" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs font-semibold">[ 展開 ]</button>
                                            </th>
                                            <th rowspan="2" class="px-3 py-3 whitespace-nowrap border-b border-gray-200 align-middle">操作</th>
                                        </tr>
                                        <tr>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-new task-col" data-task-header="task_new_ebook">取得:電子書合作</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_b2c">取得:B2C銷售權利</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_gvm">取得:[灰熊]</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_trms">取得:電子教科書TRMS</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_kingstone">取得:[書紐]金石堂</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_sanmin">取得:[書紐]三民</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_b2c_3rd">取得:B2C經銷第三方</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_b2b">取得:B2B銷售權利</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_b2b_union">取得:B2B_聯盟</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_b2b_public">取得:B2B_公圖</th>
                                            <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand task-col" data-task-header="task_get_b2b_cn">取得:B2B_CN</th>
                                        </tr>
                                    </thead>
                                    <tbody id="master-list-body">
                                        <tr class="bg-white border-b"><td colspan="19" class="text-center py-10 text-gray-500">正在從資料庫載入資料...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
<!-- ... (rest of the sections remain the same) ... -->
                    <!-- 模組二：團隊簽約進度 -->
                    <section id="content-team-signing" class="content-section hidden">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">2025年8~12月＿徵集團體目標(中文電子書)</h3>
                            <p class="text-xs text-gray-500 mb-4">備註：本表中的數量為出版社品牌家數。統計時同一出版社，於此表只會被計算至一個項目，不重複計算。</p>
                            <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表二&gt;</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse kpi-table">
                                    <thead>
                                        <tr class="header-group">
                                            <th rowspan="2" class="item-col">項目</th>
                                            <th colspan="6">目標</th>
                                            <th colspan="13">進度</th>
                                        </tr>
                                        <tr class="header-sub">
                                            <th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th><th class="highlight">家數合計</th>
                                            <th>8月</th><th>8月達成率</th>
                                            <th>9月</th><th>9月達成率</th>
                                            <th>10月</th><th>10月達成率</th>
                                            <th>11月</th><th>11月達成率</th>
                                            <th>12月</th><th>12月達成率</th>
                                            <th class="highlight">家數合計</th><th class="highlight">各項目達成率</th><th class="gap-col">缺口家數</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kpi-table-body"></tbody>
                                    <tfoot id="kpi-table-footer"></tfoot>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- 模組三：個人簽約進度 -->
                    <section id="content-individual-signing" class="content-section hidden">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">個人簽約率總覽</h3>
                            <h4 class="text-sm font-semibold text-gray-500 mb-4">&lt;表三&gt;</h4>
                            <div class="overflow-x-auto rounded-lg border">
                                <table class="w-full text-sm text-left text-gray-600">
                                    <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">負責人</th>
                                            <th scope="col" class="px-6 py-3">負責單位數</th>
                                            <th scope="col" class="px-6 py-3">已簽約</th>
                                            <th scope="col" class="px-6 py-3">簽約率</th>
                                        </tr>
                                    </thead>
                                    <tbody id="individual-signing-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- 模組四：出版社分級聯繫進度 -->
                    <section id="content-publisher-tier" class="content-section hidden">
                        <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表四&gt;</h4>
                        <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <label for="progress-filter" class="text-sm font-medium text-gray-700">篩選檢視:</label>
                                <select id="progress-filter" class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                            </div>
                            <div class="text-xs text-gray-600 flex items-center gap-4">
                                <span class="font-bold">分級定義:</span>
                                <span><span class="font-semibold text-red-600">A級:</span> 最重要</span>
                                <span><span class="font-semibold text-yellow-600">B級:</span> 次之</span>
                                <span><span class="font-semibold text-blue-600">C級:</span> 一般</span>
                            </div>
                        </div>
                        <div id="progress-cards-container" class="grid grid-cols-1 xl:grid-cols-2 gap-8"></div>
                    </section>

                    <!-- 模組五：個人聯繫進度 -->
                    <section id="content-individual-contact" class="content-section hidden">
                        <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;表五&gt;</h4>
                        <div id="individual-contact-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>
                    
                    <!-- 模組七：標籤管理 -->
                    <section id="content-tag-management" class="content-section hidden">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-2xl mx-auto">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">任務標籤管理</h3>
                            <div class="flex items-center gap-2 mb-4 pb-4 border-b">
                                <input type="text" id="new-tag-input" placeholder="輸入新標籤名稱..." class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <button id="add-tag-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 inline-flex items-center text-sm">新增</button>
                            </div>
                            <div class="space-y-2" id="tag-list-container">
                                <p class="text-center text-gray-500 py-4">正在載入標籤...</p>
                            </div>
                        </div>
                    </section>

                    <!-- NEW: User Management Section -->
                    <section id="content-user-management" class="content-section hidden">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-4xl mx-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">使用者管理</h3>
                                 <button id="add-user-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 inline-flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    新增使用者
                                </button>
                            </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-600">
                                    <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                        <tr>
                                            <th class="px-6 py-3">使用者名稱</th>
                                            <th class="px-6 py-3">角色</th>
                                            <th class="px-6 py-3">權限</th>
                                            <th class="px-6 py-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-list-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- 模組六：匯出報表 -->
                    <section id="content-export" class="content-section hidden">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">選擇要匯出的報表</h3>
                            <div class="space-y-4" id="export-options-container">
                                <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="export-option" value="table1" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-800">&lt;表一&gt; 出版社母體管理</span>
                                </label>
                                <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="export-option" value="table2" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-800">&lt;表二&gt; 團隊簽約進度</span>
                                </label>
                                <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="export-option" value="table3" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-800">&lt;表三&gt; 個人簽約進度</span>
                                </label>
                                <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="export-option" value="table4" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-800">&lt;表四&gt; 出版社分級聯繫進度</span>
                                </label>
                                <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="export-option" value="table5" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm font-medium text-gray-800">&lt;表五&gt; 個人聯繫進度</span>
                                </label>
                            </div>
                            <div class="mt-6 text-right">
                                <button id="export-selected-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 transition-all duration-200 inline-flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    匯出所選報表
                                </button>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-publisher-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">新增出版社</h3>
                <button id="close-add-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="add-publisher-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-publisher-id">
                <div>
                    <label for="publisher-name" class="block text-sm font-medium text-gray-700">出版社名稱</label>
                    <input type="text" id="publisher-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="publisher-notion-url" class="block text-sm font-medium text-gray-700">Notion 紀錄連結</label>
                    <input type="url" id="publisher-notion-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="貼上 Notion 頁面連結">
                </div>
                <div>
                    <label for="publisher-contract-id" class="block text-sm font-medium text-gray-700">合約編號</label>
                    <input type="text" id="publisher-contract-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="例如: EBK00001 (若無則留空)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">任務標籤</label>
                    <div id="publisher-mission-tags-container" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2 border rounded-md p-3 max-h-32 overflow-y-auto">
                        <!-- Checkboxes will be inserted here by JS -->
                    </div>
                </div>
                <div>
                    <label for="publisher-staff" class="block text-sm font-medium text-gray-700">負責同仁</label>
                    <select id="publisher-staff" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                </div>
                <div>
                    <label for="publisher-tier" class="block text-sm font-medium text-gray-700">分級</label>
                    <select id="publisher-tier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                </div>
                <div>
                    <label for="publisher-status" class="block text-sm font-medium text-gray-700">聯繫狀態</label>
                    <select id="publisher-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                </div>
                <!-- NEW SECTION FOR TASK DATES -->
                <div id="modal-task-dates-section" class="hidden space-y-4 pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700">任務完成日期 (至少填寫一項)</label>
                    <div id="modal-task-dates-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-40 overflow-y-auto">
                        <!-- Task date inputs will be inserted here by JS -->
                    </div>
                </div>
            </form>
            <div class="p-4 bg-gray-50 rounded-b-xl text-right space-x-2">
                <button id="cancel-add-btn" type="button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                <button id="save-add-btn" type="submit" form="add-publisher-form" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存</button>
            </div>
        </div>
    </div>
    <div id="publisher-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="publisher-list-modal-content" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800" id="publisher-list-title">出版社清單</h3>
                <button id="close-publisher-list-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto"><ul id="publisher-list-body" class="space-y-2 text-sm text-gray-700 list-disc list-inside"></ul></div>
        </div>
    </div>
     <!-- NEW: User Modal -->
    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800" id="user-modal-title">新增使用者</h3>
                <button id="close-user-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="user-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label for="user-username" class="block text-sm font-medium text-gray-700">使用者名稱</label>
                    <input type="text" id="user-username" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="user-password" class="block text-sm font-medium text-gray-700">密碼</label>
                    <input type="password" id="user-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500" id="password-hint">新增使用者時，此欄位為必填。</p>
                </div>
                <div>
                    <label for="user-role" class="block text-sm font-medium text-gray-700">角色</label>
                    <select id="user-role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="user">一般使用者</option>
                        <option value="admin">管理者</option>
                    </select>
                </div>
                <div id="permissions-section" class="space-y-4 pt-4 border-t">
                     <label class="block text-sm font-medium text-gray-700">模組權限</label>
                     <div id="permissions-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                         <!-- Permissions checkboxes will be inserted here -->
                     </div>
                </div>
            </form>
            <div class="p-4 bg-gray-50 rounded-b-xl text-right space-x-2">
                <button id="cancel-user-btn" type="button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                <button id="save-user-btn" type="submit" form="user-form" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存</button>
            </div>
        </div>
    </div>


    <!-- Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 text-center">
                <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900" id="alert-title">操作提醒</h3>
                <p id="alert-modal-text" class="mt-2 text-sm text-gray-600"></p>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl text-center" id="alert-buttons">
                <button id="close-alert-modal-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">我知道了</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="">
        <div id="toast-content" class="flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-lg" role="alert">
        </div>
    </div>
    
    <script>
      const __app_id = "ebook-dashboard";
      const __firebase_config = JSON.stringify({
        apiKey: "AIzaSyA735uIwaSCjz09KwI0SNXgvmTwmk5kzXA",
        authDomain: "ebook-dashboard-a0148.firebaseapp.com",
        projectId: "ebook-dashboard-a0148",
        storageBucket: "ebook-dashboard-a0148.appspot.com",
        messagingSenderId: "127405787765",
        appId: "1:127405787765:web:72631dc3d362466660c63c"
      });
    </script>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Removed signInWithCustomToken
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, writeBatch, setDoc, getDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function () {
            
            // --- 全域狀態管理 (Global State) ---
            const state = {
                publishers: [],
                missionTags: [],
                users: [],
                currentUser: null,
                analytics: {}, 
                filters: { search: '', staff: 'all', tier: 'all', status: 'all' },
                sort: { by: 'name', order: 'asc' },
                db: null,
                appId: null,
                publishersCollection: null,
                settingsCollection: null,
                usersCollection: null,
            };

            // --- LOGIN LOGIC ---
            const loginScreen = document.getElementById('login-screen');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const dashboardContainer = document.getElementById('dashboard-container');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = loginForm.username.value;
                const password = loginForm.password.value;

                // For the very first run, allow the default user to log in before Firebase is initialized.
                if (username === 'admin' && password === 'password123') {
                     await proceedToDashboard({
                        username: 'admin',
                        role: 'admin',
                        permissions: {} // Admin has all permissions by default
                    });
                    return;
                }

                if (state.db) {
                     const usersRef = collection(state.db, `/artifacts/${state.appId}/public/data/users`);
                     const q = query(usersRef, where("username", "==", username), where("password", "==", password));
                     
                     try {
                         const querySnapshot = await getDocs(q);
                         if (querySnapshot.empty) {
                             loginError.textContent = '帳號或密碼錯誤。';
                             loginError.classList.remove('hidden');
                         } else {
                             const userData = querySnapshot.docs[0].data();
                             const userId = querySnapshot.docs[0].id;
                             await proceedToDashboard({ id: userId, ...userData });
                         }
                     } catch(err) {
                         console.error("Login query failed:", err);
                         loginError.textContent = '登入時發生錯誤，請稍後再試。';
                         loginError.classList.remove('hidden');
                     }
                } else {
                     loginError.textContent = '資料庫尚未連接，請稍候...';
                     loginError.classList.remove('hidden');
                }
            });

            async function proceedToDashboard(userData) {
                state.currentUser = userData;
                loginError.classList.add('hidden');
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    dashboardContainer.classList.remove('hidden');
                    initDashboard();
                }, 500); 
            }
            
            async function preInitFirebase() {
                 try {
                     const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                     const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                     state.appId = appId;
                     const app = initializeApp(firebaseConfig);
                     state.db = getFirestore(app);
                 } catch (e) {
                     console.error("Pre-initialization of Firebase failed", e);
                 }
            }
            preInitFirebase();


            // --- DASHBOARD INITIALIZATION FUNCTION ---
            async function initDashboard() {

                // --- 設定與常數 ---
                const staffList = ["陳玫君", "陳俐吟", "李芷瑄", "李虹儀", "未分配"];
                const tierList = ["A", "B", "C", "X"];
                const contactStatusList = ["未聯繫", "聯繫中", "已聯繫，無意願洽談", "已聯繫，有意願洽談", "審約中", "用印中", "已簽回，已移交合約"];
                const initialMissionTagList = ["徵集組指定任務", "未合作，取得合作", "取B2C", "擴增B2C", "取TRMS", "取B2B", "擴增B2B（公圖）", "擴增B2B（聯盟）", "擴增B2B（聯盟、公圖）"];
                const taskColumns = [ 'task_new_ebook', 'task_get_b2c', 'task_get_gvm', 'task_get_trms', 'task_get_kingstone', 'task_get_sanmin', 'task_get_b2c_3rd', 'task_get_b2b', 'task_get_b2b_union', 'task_get_b2b_public', 'task_get_b2b_cn' ];
                const kpiTargets = {
                    'B2C':    { months: [4, 6, 6, 5, 3], taskKey: 'task_get_b2c' },
                    'B2B':    { months: [2, 3, 3, 2, 2], taskKey: 'task_get_b2b' },
                    '未合作': { months: [2, 3, 3, 3, 3], taskKey: 'task_new_ebook' },
                    'TRMS':   { months: [2, 2, 2, 2, 0], taskKey: 'task_get_trms' }
                };
                const pageTitles = { publisherMaster: '出版社母體管理', teamSigning: '團隊簽約進度', individualSigning: '個人簽約進度', publisherTier: '出版社分級聯繫進度', individualContact: '個人聯繫進度', tagManagement: '標籤管理', userManagement: '使用者管理', export: '匯出報表' };
                const initialData = [
                    { name: "悅文社", staff: "陳玫君", tier: "A", contactStatus: "已聯繫，有意願洽談", missionTags: ["未合作，取得合作"], contractId: null, tasks: {}, notionUrl: null },
                    { name: "東立出版社", staff: "陳玫君", tier: "A", contactStatus: "已聯繫，有意願洽談", missionTags: ["未合作，取得合作"], contractId: null, tasks: { task_new_ebook: '2025-08-01' }, notionUrl: null },
                ];
                
                // --- DOM 元素快取 ---
                const dom = {
                    navLinks: Object.fromEntries(Object.keys(pageTitles).map(id => [id, document.getElementById(`nav-${id.replace(/([A-Z])/g, '-$1').toLowerCase()}`)])),
                    contentSections: Object.fromEntries(Object.keys(pageTitles).map(id => [id, document.getElementById(`content-${id.replace(/([A-Z])/g, '-$1').toLowerCase()}`)])),
                    mainTitle: document.getElementById('main-title'),
                    dbStatus: document.getElementById('db-status'),
                    masterListBody: document.getElementById('master-list-body'),
                    searchInput: document.getElementById('search-input'),
                    staffFilter: document.getElementById('staff-filter'),
                    tierFilter: document.getElementById('tier-filter'),
                    statusFilter: document.getElementById('status-filter'),
                    tagListContainer: document.getElementById('tag-list-container'),
                    userListBody: document.getElementById('user-list-body'),
                    // Modals
                    addPublisherModal: document.getElementById('add-publisher-modal'),
                    addPublisherModalContent: document.getElementById('add-publisher-modal').querySelector('.modal-content'),
                    addPublisherForm: document.getElementById('add-publisher-form'),
                    userModal: document.getElementById('user-modal'),
                    userModalContent: document.getElementById('user-modal').querySelector('.modal-content'),
                    userForm: document.getElementById('user-form'),
                    publisherListModal: document.getElementById('publisher-list-modal'),
                    publisherListModalContent: document.getElementById('publisher-list-modal').querySelector('.modal-content'),
                    alertModal: document.getElementById('alert-modal'),
                    alertModalContent: document.getElementById('alert-modal').querySelector('.modal-content'),
                    alertModalText: document.getElementById('alert-modal-text'),
                    alertTitle: document.getElementById('alert-title'),
                    alertButtons: document.getElementById('alert-buttons'),
                };

                // --- Firebase 核心功能 ---
                async function initializeFirebase() {
                    try {
                        const auth = getAuth();
                        // Listen for auth state changes (primarily for anonymous sign-in completion)
                        onAuthStateChanged(auth, user => {
                            if (user) {
                                console.log("Firebase Auth (Anonymous) User ID:", user.uid);
                                dom.dbStatus.textContent = '已連接';
                                dom.dbStatus.className = 'font-semibold text-green-600';

                                // Set up Firestore collections *after* auth confirms connection
                                state.publishersCollection = collection(state.db, `/artifacts/${state.appId}/public/data/publishers`);
                                state.settingsCollection = collection(state.db, `/artifacts/${state.appId}/public/data/settings`);
                                state.usersCollection = collection(state.db, `/artifacts/${state.appId}/public/data/users`);

                                // Start listening to data
                                listenToPublishers();
                                listenToTags();
                                if(state.currentUser && state.currentUser.role === 'admin') { // Check if currentUser exists
                                    listenToUsers();
                                }
                            } else {
                                console.log("Firebase Auth: No user signed in.");
                                dom.dbStatus.textContent = '未連接'; // Or '未授權' if preferred
                                dom.dbStatus.className = 'font-semibold text-red-600';
                            }
                        });
                        
                        // Attempt anonymous sign-in directly
                        try {
                            await signInAnonymously(auth);
                            console.log("Firebase Anonymous sign-in successful.");
                        } catch (authError) {
                            console.error("Firebase anonymous sign-in failed:", authError);
                             dom.dbStatus.textContent = '認證失敗';
                             dom.dbStatus.className = 'font-semibold text-red-600';
                        }

                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        dom.dbStatus.textContent = '連接失敗';
                        dom.dbStatus.className = 'font-semibold text-red-600';
                        dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-red-500">資料庫連接失敗，請檢查設定或重新整理。</td></tr>`;
                    }
                }
                
                function listenToUsers() {
                     if (!state.usersCollection) {
                         console.error("Users collection not initialized.");
                         return;
                     }
                     onSnapshot(state.usersCollection, async (snapshot) => {
                         if (snapshot.empty && state.currentUser.username === 'admin') { // Seed only if the first admin logs in
                             // Check if admin user already exists to prevent duplicates if seeding happens late
                             const q = query(state.usersCollection, where("username", "==", "admin"));
                             const existingAdmin = await getDocs(q);
                             if (existingAdmin.empty) {
                                 await seedInitialUser();
                             } else {
                                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                renderUserManagementUI();
                             }
                             return; // Seeding or finding existing admin might trigger another snapshot
                         }
                         state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         renderUserManagementUI();
                     }, (error) => {
                         console.error("Error listening to users collection:", error);
                         dom.userListBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-red-500">讀取使用者資料時發生錯誤。</td></tr>`;
                     });
                }

                async function seedInitialUser() {
                    console.log("Seeding initial admin user...");
                    const adminUser = {
                        username: 'admin',
                        password: 'password123', // Note: Storing plain passwords is not secure for real applications
                        role: 'admin',
                        permissions: {}
                    };
                    try {
                       await addDoc(state.usersCollection, adminUser);
                       console.log("Initial admin user seeded.");
                    } catch (error) {
                       console.error("Failed to seed initial admin user:", error);
                    }
                }


                function listenToPublishers() {
                    if (!state.publishersCollection) {
                        console.error("Publishers collection not initialized.");
                        return;
                    }
                    onSnapshot(state.publishersCollection, async (snapshot) => {
                        if (snapshot.empty && initialData.length > 0) {
                            await seedInitialData();
                            return; // Seeding triggers another snapshot
                        }
                        state.publishers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        state.analytics = calculateAllAnalytics(state.publishers);
                        renderAll();
                    }, (error) => {
                        console.error("Error listening to publishers collection:", error);
                        dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="20" class="text-center py-10 text-red-500">讀取資料時發生錯誤。</td></tr>`;
                    });
                }

                function listenToTags() {
                    if (!state.settingsCollection) {
                         console.error("Settings collection not initialized.");
                         return;
                    }
                    const docRef = doc(state.settingsCollection, 'missionTags');
                    onSnapshot(docRef, async (docSnap) => {
                        if (!docSnap.exists()) {
                            await setDoc(docRef, { list: initialMissionTagList });
                            // The snapshot will re-trigger with the new data
                        } else {
                            state.missionTags = docSnap.data().list || [];
                            renderTagManagementUI();
                        }
                    }, (error) => {
                        console.error("Error listening to tags:", error);
                        dom.tagListContainer.innerHTML = `<p class="text-center text-red-500 py-4">讀取標籤失敗</p>`;
                    });
                }

                async function seedInitialData() {
                     if (!state.publishersCollection) {
                         console.error("Cannot seed initial data: Publishers collection not initialized.");
                         return;
                     }
                    console.log("Seeding initial publisher data...");
                    const batch = writeBatch(state.db);
                    initialData.forEach(pubData => {
                        const completeData = { ...pubData, tasks: pubData.tasks || {} };
                        taskColumns.forEach(key => {
                            if (!completeData.tasks.hasOwnProperty(key)) {
                                completeData.tasks[key] = null;
                            }
                        });
                        const newDocRef = doc(state.publishersCollection);
                        batch.set(newDocRef, completeData);
                    });
                    try {
                        await batch.commit();
                        console.log("Initial publisher data seeded.");
                        showToast("已載入初始範例資料", "success");
                    } catch(error) {
                        console.error("Failed to seed initial publisher data:", error);
                        showToast("載入初始資料失敗", "error");
                    }
                }

                // --- 核心渲染邏輯 ---
                function renderAll() {
                    // Check if analytics data is ready before rendering components that depend on it
                    if (!state.analytics || Object.keys(state.analytics).length === 0) {
                        // Optionally show a loading state or just wait for analytics
                         console.log("Analytics not ready, delaying render.");
                        return;
                    }
                     console.log("Rendering all components...");
                    const filteredAndSorted = getFilteredAndSortedData();
                    renderMasterList(filteredAndSorted);
                    renderTeamSigningProgress(state.analytics.teamSigningStats);
                    renderIndividualSigningProgress(state.analytics.individualSigningStats);
                    renderPublisherTierProgress(state.analytics.tierProgressStats);
                    renderIndividualContactProgress(state.analytics.individualContactStats);
                    // Ensure admin-only UIs are also rendered if needed
                     if (state.currentUser && state.currentUser.role === 'admin') {
                         renderUserManagementUI();
                     }
                     renderTagManagementUI(); // Tags are needed for the add/edit modal
                }
                
                function renderMasterList(data) {
                    if (data.length === 0) {
                        const message = state.publishers.length > 0 ? "沒有符合篩選條件的結果。" : "資料庫中尚無資料，請新增或匯入。";
                        dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="19" class="text-center py-10 text-gray-500">${message}</td></tr>`; // Corrected colspan
                        return;
                    }
                    dom.masterListBody.innerHTML = data.map(pub => createPublisherRowHtml(pub)).join('');
                }
                
                // --- 資料分析與計算 (集中處理) ---
                function calculateAllAnalytics(publishers) {
                     console.log("Calculating analytics...");
                     if (!publishers || publishers.length === 0) {
                         // Return default structure if no publishers data yet
                         return {
                             teamSigningStats: calculateTeamSigningStats([]),
                             individualSigningStats: calculateIndividualSigningStats([]),
                             tierProgressStats: calculateTierProgressStats([]),
                             individualContactStats: calculateIndividualContactStats([]),
                         };
                     }
                    return {
                        teamSigningStats: calculateTeamSigningStats(publishers),
                        individualSigningStats: calculateIndividualSigningStats(publishers),
                        tierProgressStats: calculateTierProgressStats(publishers),
                        individualContactStats: calculateIndividualContactStats(publishers),
                    };
                }

                function calculateTeamSigningStats(publishers) {
                    const stats = {};
                    Object.keys(kpiTargets).forEach(item => {
                        const targetData = kpiTargets[item];
                        const progressCounts = { 8: 0, 9: 0, 10: 0, 11: 0, 12: 0 };
                        if (publishers && publishers.length > 0) { // Check if publishers is not empty
                            publishers.forEach(pub => {
                                const dateStr = pub.tasks && pub.tasks[targetData.taskKey];
                                if (dateStr) {
                                    try {
                                        const date = new Date(dateStr);
                                        // Basic validation: Check if year seems reasonable (e.g., after 2000)
                                        if (!isNaN(date.getTime()) && date.getFullYear() > 2000) {
                                            const month = date.getMonth() + 1;
                                            if (progressCounts.hasOwnProperty(month)) {
                                                progressCounts[month]++;
                                            }
                                        } else {
                                           // console.warn(`Invalid date format found for ${pub.name}, task ${targetData.taskKey}: ${dateStr}`);
                                        }
                                    } catch (e) {
                                        // console.warn(`Error parsing date for ${pub.name}, task ${targetData.taskKey}: ${dateStr}`, e);
                                     }
                                }
                            });
                        }
                        stats[item] = {
                            targets: targetData.months,
                            progress: [progressCounts[8], progressCounts[9], progressCounts[10], progressCounts[11], progressCounts[12]]
                        };
                    });
                    return stats;
                }

                function calculateIndividualSigningStats(publishers) {
                    const stats = {};
                    // Use actual staff list from data if available, fallback to default
                    const currentStaffList = publishers && publishers.length > 0
                        ? Array.from(new Set(publishers.map(p => p.staff))).sort()
                        : staffList;

                    currentStaffList.forEach(s => stats[s] = { total: 0, signed: 0 });

                    if (publishers && publishers.length > 0) {
                        publishers.forEach(p => {
                            if (!stats[p.staff]) stats[p.staff] = { total: 0, signed: 0 }; // Handle staff not in default list
                            stats[p.staff].total++;
                            if (p.contactStatus === "已簽回，已移交合約") {
                                stats[p.staff].signed++;
                            }
                        });
                    }
                    return Object.entries(stats)
                        .filter(([, data]) => data.total > 0)
                        .map(([name, data]) => ({
                            name,
                            ...data,
                            rate: data.total > 0 ? (data.signed / data.total * 100) : 0
                        }));
                }

                function calculateTierProgressStats(publishers) {
                    const progressData = {};
                     if (!publishers || publishers.length === 0) return progressData; // Return empty if no data

                    const currentStaff = Array.from(new Set(publishers.map(p => p.staff))).sort();

                    currentStaff.forEach(staffName => {
                        progressData[staffName] = {};
                        tierList.forEach(tier => {
                            progressData[staffName][tier] = { total: 0, stages: {} };
                            contactStatusList.forEach(s => progressData[staffName][tier].stages[s] = 0);
                        });
                    });

                    publishers.forEach(p => {
                        // Ensure staff and tier exist in progressData before trying to access
                        if (progressData[p.staff] && progressData[p.staff][p.tier]) {
                            progressData[p.staff][p.tier].total++;
                            if (progressData[p.staff][p.tier].stages.hasOwnProperty(p.contactStatus)) {
                                progressData[p.staff][p.tier].stages[p.contactStatus]++;
                            } else {
                                // Handle case where contactStatus might be unexpected, log or ignore
                               // console.warn(`Unexpected contact status '${p.contactStatus}' for publisher ${p.name}`);
                            }
                        } else {
                           // console.warn(`Staff '${p.staff}' or Tier '${p.tier}' not found in progress data structure for publisher ${p.name}`);
                        }
                    });
                    return progressData;
                }
                
                function calculateIndividualContactStats(publishers) {
                     const stats = {};
                     // Use actual staff list from data if available, fallback to default
                     const currentStaffList = publishers && publishers.length > 0
                         ? Array.from(new Set(publishers.map(p => p.staff))).sort()
                         : staffList;

                     currentStaffList.forEach(s => stats[s] = { total: 0, contacted: 0 });

                     if (publishers && publishers.length > 0) {
                         publishers.forEach(p => {
                             if (!stats[p.staff]) stats[p.staff] = { total: 0, contacted: 0 };
                             stats[p.staff].total++;
                             if (p.contactStatus !== "未聯繫") {
                                 stats[p.staff].contacted++;
                             }
                         });
                     }
                     return Object.entries(stats)
                         .filter(([, data]) => data.total > 0)
                         .map(([name, data]) => ({
                             name,
                             ...data,
                             rate: data.total > 0 ? (data.contacted / data.total * 100) : 0
                         }));
                }
                
                // --- 各模組渲染函式 (使用計算好的 analytics) ---
                function renderTeamSigningProgress(stats) {
                    const kpiTableBody = document.getElementById('kpi-table-body');
                    const kpiTableFooter = document.getElementById('kpi-table-footer');
                     if (!kpiTableBody || !kpiTableFooter) return; // Add checks for elements

                    let bodyHtml = '';
                    const progressTotals = {
                        target: { months: [0, 0, 0, 0, 0], total: 0 },
                        progress: { months: [0, 0, 0, 0, 0], total: 0 }
                    };

                     // Check if stats is defined and has keys
                     if (!stats || Object.keys(stats).length === 0) {
                         kpiTableBody.innerHTML = `<tr><td colspan="20" class="text-center py-4 text-gray-500">尚無資料</td></tr>`; // Adjust colspan
                         kpiTableFooter.innerHTML = ''; // Clear footer
                         return;
                     }


                    Object.keys(kpiTargets).forEach(item => {
                        const itemStats = stats[item];
                         // Add checks for itemStats and its properties
                         if (!itemStats || !itemStats.targets || !itemStats.progress) {
                            // console.warn(`Missing stats data for KPI item: ${item}`);
                             return; // Skip rendering this row if data is incomplete
                         }
                        const targetData = itemStats.targets;
                        const progressMonths = itemStats.progress;
                        const targetTotal = targetData.reduce((a, b) => a + b, 0);
                        const progressTotal = progressMonths.reduce((a, b) => a + b, 0);
                        const overallRate = targetTotal > 0 ? (progressTotal / targetTotal * 100).toFixed(1) : '0.0'; // Ensure string for %
                        const gap = targetTotal - progressTotal;
                        
                        targetData.forEach((m, i) => progressTotals.target.months[i] += m);
                        progressTotals.target.total += targetTotal;
                        progressMonths.forEach((m, i) => progressTotals.progress.months[i] += m);
                        progressTotals.progress.total += progressTotal;

                        const progressCells = progressMonths.map((p, i) =>
                            `<td>${p}</td><td>${targetData[i] > 0 ? (p / targetData[i] * 100).toFixed(0) : 0}%</td>`
                        ).join('');
                        
                        bodyHtml += `<tr>
                            <td class="item-col">${item}</td>
                            ${targetData.map(m => `<td>${m}</td>`).join('')}
                            <td class="highlight">${targetTotal}</td>
                            ${progressCells}
                            <td class="highlight">${progressTotal}</td>
                            <td class="highlight"><div class="flex items-center justify-center"><span>${overallRate}%</span><div class="w-16 bg-gray-200 rounded-full h-2.5 ml-2"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${overallRate}%"></div></div></div></td>
                            <td class="gap-col">${gap}</td>
                        </tr>`;
                    });
                     if (!bodyHtml) { // Handle case where no items had valid stats
                         kpiTableBody.innerHTML = `<tr><td colspan="20" class="text-center py-4 text-gray-500">尚無資料</td></tr>`;
                         kpiTableFooter.innerHTML = '';
                         return;
                     }
                    kpiTableBody.innerHTML = bodyHtml;

                    const footerOverallRate = progressTotals.target.total > 0 ? (progressTotals.progress.total / progressTotals.target.total * 100).toFixed(1) : '0.0';
                    const footerGap = progressTotals.target.total - progressTotals.progress.total;
                    const footerProgressCells = progressTotals.progress.months.map((p, i) =>
                        `<td>${p}</td><td>${progressTotals.target.months[i] > 0 ? (p / progressTotals.target.months[i] * 100).toFixed(0) : 0}%</td>`
                    ).join('');

                    kpiTableFooter.innerHTML = `<tr class="total-row">
                        <td class="item-col">總計</td>
                        ${progressTotals.target.months.map(m => `<td>${m}</td>`).join('')}
                        <td class="highlight">${progressTotals.target.total}</td>
                        ${footerProgressCells}
                        <td class="highlight">${progressTotals.progress.total}</td>
                        <td class="highlight">${footerOverallRate}%</td>
                        <td class="gap-col">${footerGap}</td>
                    </tr>`;
                }

                function renderIndividualSigningProgress(stats) {
                    const tableBody = document.getElementById('individual-signing-body');
                    if (!tableBody) return;
                     if (!stats || stats.length === 0) {
                         tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">尚無資料</td></tr>`;
                         return;
                     }
                    tableBody.innerHTML = stats.map((row, index) => {
                        const rate = row.rate.toFixed(1);
                        return `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${row.name}</td>
                            <td class="px-6 py-4">${row.total}</td>
                            <td class="px-6 py-4">${row.signed}</td>
                            <td class="px-6 py-4"><div class="flex items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                    <div class="${rate >= 80 ? 'bg-green-600' : rate >= 50 ? 'bg-yellow-400' : 'bg-red-500'} h-2.5 rounded-full" style="width: ${rate}%"></div>
                                </div>
                                <span class="font-medium">${rate}%</span>
                            </div></td>
                        </tr>`;
                    }).join('');
                }
                
                function renderPublisherTierProgress(progressData) {
                    const container = document.getElementById('progress-cards-container');
                    const filter = document.getElementById('progress-filter');
                    if (!container || !filter) return;

                     const staffInFilter = progressData ? Object.keys(progressData).sort() : [];

                    container.innerHTML = staffInFilter.length > 0
                        ? staffInFilter.map(name => createProgressCardHTML(name, progressData[name])).join('')
                        : '<p class="text-center text-gray-500 col-span-full">無資料可顯示。</p>';
                    
                    // Update and preserve filter selection
                    const currentFilterValue = filter.value;
                    filter.innerHTML = `<option value="all">顯示全部同仁</option>${staffInFilter.map(name => `<option value="${name}">${name}</option>`).join('')}`;
                    filter.value = staffInFilter.includes(currentFilterValue) ? currentFilterValue : 'all';
                    filter.dispatchEvent(new Event('change')); // Trigger filter change to show/hide cards
                    
                    applyHealthCheck();
                }

                function renderIndividualContactProgress(stats) {
                    const container = document.getElementById('individual-contact-cards-container');
                    if (!container) return;
                     if (!stats || stats.length === 0) {
                         container.innerHTML = `<p class="text-center text-gray-500 col-span-full">尚無資料</p>`; // Adjusted for grid
                         return;
                     }
                    container.innerHTML = stats.map(row => {
                        const rate = row.rate.toFixed(0);
                        return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
                            <h3 class="font-semibold text-gray-800">${row.name}</h3>
                            <p class="text-sm text-gray-500 mb-4">單位聯繫進度</p>
                            <div class="flex justify-between items-center text-sm mb-1"><span>進度</span><span class="font-bold">${rate}%</span></div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${rate}%;"></div></div>
                            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between text-sm">
                                <span class="text-gray-600">已聯繫: <strong class="text-gray-900">${row.contacted}</strong></span>
                                <span class="text-gray-600">總單位: <strong class="text-gray-900">${row.total}</strong></span>
                            </div>
                        </div>`;
                    }).join('');
                }
                
                // --- Helper 函式 ---
                function createPublisherRowHtml(pub) {
                    // Ensure pub.tasks is an object, default to empty if not
                    const tasks = typeof pub.tasks === 'object' && pub.tasks !== null ? pub.tasks : {};
                    const taskCells = taskColumns.map(taskKey => `<td class="px-3 py-3 border-b border-gray-200 task-col">${tasks[taskKey] || ''}</td>`).join('');

                    const tagBadges = Array.isArray(pub.missionTags) && pub.missionTags.length > 0
                        ? pub.missionTags.map(tag => `<span class="tag-badge">${tag}</span>`).join('')
                        : '<span class="text-gray-400">無</span>';

                    return `
                    <tr class="bg-white hover:bg-gray-50" data-id="${pub.id}">
                        <td class="px-3 py-2 border-b border-gray-200">
                            <a href="${pub.notionUrl || '#'}" target="_blank" rel="noopener noreferrer" class="p-2 inline-block rounded-md ${pub.notionUrl ? 'bg-gray-200 text-gray-600 hover:bg-gray-300' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" title="打開 Notion 連結">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </a>
                        </td>
                        <td class="px-3 py-3 font-medium text-gray-900 border-b border-gray-200 whitespace-nowrap">${pub.name || ''}</td>
                        <td class="px-3 py-3 border-b border-gray-200">${pub.contractId || ''}</td>
                        <td class="px-3 py-3 border-b border-gray-200">${pub.staff || ''}</td>
                        <td class="px-3 py-3 border-b border-gray-200 text-center">${pub.tier || ''}</td>
                        <td class="px-3 py-3 border-b border-gray-200 whitespace-nowrap">${pub.contactStatus || ''}</td>
                        <td class="px-3 py-2 border-b border-gray-200 min-w-[200px]">${tagBadges}</td>
                        ${taskCells}
                        <td class="px-3 py-2 border-b border-gray-200">
                            <button class="edit-row-btn p-2 rounded-md text-gray-500 hover:bg-gray-200 hover:text-gray-800" title="編輯此筆資料">
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                            </button>
                        </td>
                    </tr>`;
                }

                function getFilteredAndSortedData() {
                    let data = [...state.publishers];
                    // Filter
                    if (state.filters.search) {
                        const searchTerm = state.filters.search.toLowerCase();
                        data = data.filter(p => (p.name && p.name.toLowerCase().includes(searchTerm)) || (p.contractId && p.contractId.toLowerCase().includes(searchTerm)));
                    }
                    if (state.filters.staff !== 'all') data = data.filter(p => p.staff === state.filters.staff);
                    if (state.filters.tier !== 'all') data = data.filter(p => p.tier === state.filters.tier);
                    if (state.filters.status !== 'all') data = data.filter(p => p.contactStatus === state.filters.status);
                    
                    // Sort
                    data.sort((a, b) => {
                        let valA = a[state.sort.by] || '';
                        let valB = b[state.sort.by] || '';
                        // Handle array sorting (e.g., missionTags)
                        if (Array.isArray(valA)) valA = valA.join(', ');
                        if (Array.isArray(valB)) valB = valB.join(', ');
                        // Ensure values are comparable strings
                        valA = String(valA);
                        valB = String(valB);


                        if (valA < valB) return state.sort.order === 'asc' ? -1 : 1;
                        if (valA > valB) return state.sort.order === 'asc' ? 1 : -1;
                        return 0;
                    });
                    return data;
                }

                // --- 事件監聽器設定 ---
                function setupEventListeners() {
                    // Sidebar Toggle
                    document.getElementById('sidebar-toggle').addEventListener('click', () => {
                        document.getElementById('sidebar').classList.toggle('collapsed');
                    });

                    // Navigation
                    document.getElementById('main-nav').addEventListener('click', (e) => {
                        const link = e.target.closest('.nav-link');
                        if (link) {
                            e.preventDefault();
                            const targetId = link.id.replace('nav-', '').replace(/-(\w)/g, (match, letter) => letter.toUpperCase());
                            switchContent(targetId);
                        }
                    });

                    // Master List Filters
                    dom.searchInput.addEventListener('input', e => { state.filters.search = e.target.value; renderAll(); });
                    dom.staffFilter.addEventListener('change', e => { state.filters.staff = e.target.value; renderAll(); });
                    dom.tierFilter.addEventListener('change', e => { state.filters.tier = e.target.value; renderAll(); });
                    dom.statusFilter.addEventListener('change', e => { state.filters.status = e.target.value; renderAll(); });
                    document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);

                    // Master List Table Actions (Sorting, Editing)
                    document.getElementById('task-toggle-btn').addEventListener('click', (e) => {
                        const table = document.getElementById('master-table');
                        const isCollapsed = table.classList.toggle('tasks-collapsed');
                        e.target.textContent = isCollapsed ? '[ 展開 ]' : '[ 收合 ]';
                    });
                    document.querySelector('#content-publisher-master thead').addEventListener('click', handleSort);
                    dom.masterListBody.addEventListener('click', handleRowClick);
                    
                    // Main Buttons
                    document.getElementById('add-publisher-btn').addEventListener('click', () => openAddEditModal());
                    document.getElementById('download-template-btn').addEventListener('click', downloadTemplate);
                    document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('file-input').click());
                    document.getElementById('file-input').addEventListener('change', handleFileImport);
                    
                    // Add/Edit Modal
                    dom.addPublisherForm.addEventListener('submit', handleSavePublisher);
                    document.getElementById('close-add-modal-btn').addEventListener('click', () => closeModal(dom.addPublisherModal, dom.addPublisherModalContent));
                    document.getElementById('cancel-add-btn').addEventListener('click', () => closeModal(dom.addPublisherModal, dom.addPublisherModalContent));
                    dom.addPublisherModal.addEventListener('click', e => { if (e.target === dom.addPublisherModal) closeModal(dom.addPublisherModal, dom.addPublisherModalContent); });
                    document.getElementById('publisher-status').addEventListener('change', (e) => {
                        const tasksSection = document.getElementById('modal-task-dates-section');
                        tasksSection.classList.toggle('hidden', e.target.value !== '已簽回，已移交合約');
                    });
                    
                    // Publisher List Modal
                    document.getElementById('close-publisher-list-btn').addEventListener('click', () => closeModal(dom.publisherListModal, dom.publisherListModalContent));
                    dom.publisherListModal.addEventListener('click', e => { if (e.target === dom.publisherListModal) closeModal(dom.publisherListModal, dom.publisherListModalContent); });

                    // Alert Modal Buttons Setup
                     // Remove previous listeners if any to prevent multiple fires
                    const oldCloseBtn = document.getElementById('close-alert-modal-btn');
                    if (oldCloseBtn) {
                         const newCloseBtn = oldCloseBtn.cloneNode(true);
                         oldCloseBtn.parentNode.replaceChild(newCloseBtn, oldCloseBtn);
                         newCloseBtn.addEventListener('click', () => closeModal(dom.alertModal, dom.alertModalContent));
                    }
                    dom.alertModal.addEventListener('click', e => {
                         if (e.target === dom.alertModal) closeModal(dom.alertModal, dom.alertModalContent);
                     });

                    // Tier Progress View
                    document.getElementById('progress-filter').addEventListener('change', handleTierProgressFilter);
                    document.getElementById('progress-cards-container').addEventListener('click', handleTierCardClick);

                    // Tag Management
                    document.getElementById('add-tag-btn').addEventListener('click', handleAddTag);
                    dom.tagListContainer.addEventListener('click', handleTagAction);
                    
                    // User Management
                    document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
                    dom.userListBody.addEventListener('click', handleUserAction);
                    document.getElementById('close-user-modal-btn').addEventListener('click', () => closeModal(dom.userModal, dom.userModalContent));
                    document.getElementById('cancel-user-btn').addEventListener('click', () => closeModal(dom.userModal, dom.userModalContent));
                    dom.userModal.addEventListener('click', e => { if (e.target === dom.userModal) closeModal(dom.userModal, dom.userModalContent); });
                    dom.userForm.addEventListener('submit', handleSaveUser);
                    document.getElementById('user-role').addEventListener('change', e => {
                        document.getElementById('permissions-section').style.display = e.target.value === 'user' ? 'block' : 'none';
                    });


                    // Export
                    document.getElementById('export-selected-btn').addEventListener('click', handleExport);
                }

                // --- 事件處理函式 ---
                function switchContent(targetId) {
                     // Check if targetId is valid
                     if (!pageTitles[targetId]) {
                         console.error(`Invalid targetId for switchContent: ${targetId}`);
                         targetId = 'publisherMaster'; // Default to master list
                     }
                    dom.mainTitle.textContent = pageTitles[targetId];

                    // Update active link styling
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('bg-indigo-600', 'text-white', 'shadow');
                        link.classList.add('text-gray-600', 'hover:bg-indigo-50');
                    });
                    const activeLinkId = `nav-${targetId.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                    const activeLink = document.getElementById(activeLinkId);
                    if (activeLink) {
                        activeLink.classList.add('bg-indigo-600', 'text-white', 'shadow');
                        activeLink.classList.remove('text-gray-600', 'hover:bg-indigo-50');
                    }

                     // Hide all sections first using the 'hidden' class
                     Object.values(dom.contentSections).forEach(section => {
                         if(section) section.classList.add('hidden');
                     });
                    
                    // Show the target section by removing the 'hidden' class
                    const sectionId = `content-${targetId.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                    const sectionToShow = document.getElementById(sectionId);
                    if (sectionToShow) {
                        sectionToShow.classList.remove('hidden');
                         // Optionally re-render if needed, though data updates should handle this
                         // if (targetId === 'publisherMaster') renderMasterList(getFilteredAndSortedData());
                    } else {
                         console.error(`Content section not found for ID: ${sectionId}`);
                         // Fallback to default section
                         const defaultSection = document.getElementById('content-publisher-master');
                         if (defaultSection) defaultSection.classList.remove('hidden');
                    }
                }



                function clearFilters() {
                    state.filters = { search: '', staff: 'all', tier: 'all', status: 'all' };
                    dom.searchInput.value = '';
                    dom.staffFilter.value = 'all';
                    dom.tierFilter.value = 'all';
                    dom.statusFilter.value = 'all';
                    renderAll();
                }

                function handleSort(e) {
                    const header = e.target.closest('.sortable-header');
                    if (!header) return;
                    
                    const sortBy = header.dataset.sort;
                    if (state.sort.by === sortBy) {
                        state.sort.order = state.sort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.sort.by = sortBy;
                        state.sort.order = 'asc';
                    }
                    document.querySelectorAll('.sortable-header').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                    header.classList.add(state.sort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                    renderAll();
                }

                async function handleRowClick(e) {
                    const editBtn = e.target.closest('.edit-row-btn');
                    const row = e.target.closest('tr');
                    if (!row) return;

                    if (editBtn) {
                        const docId = row.dataset.id;
                        openAddEditModal(docId);
                    }
                }
                
                // --- 初始載入 ---
                
                initializeFirebase(); // Firebase init will trigger data loading via onAuthStateChanged
                // Apply permissions and setup UI elements that don't depend on data first
                applyPermissions();
                setupFilters();
                setupEventListeners();
                switchContent('publisherMaster'); // Show default section
                document.getElementById('master-table').classList.add('tasks-collapsed'); // Collapse tasks initially

                
                // --- Modal, UI, & Tag Management Helpers ---
                function openModal(modal, content) { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => content.classList.add('open'), 10); }
                function closeModal(modal, content) { content.classList.remove('open'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300); }
                
                 function showConfirmation(title, message, onConfirm) {
                     dom.alertTitle.textContent = title;
                     dom.alertModalText.textContent = message;

                     // Ensure buttons are freshly added with listeners
                     dom.alertButtons.innerHTML = `
                         <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                         <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">確認</button>
                     `;

                     openModal(dom.alertModal, dom.alertModalContent);

                     // Add listeners directly to the new buttons
                     document.getElementById('confirm-action-btn').onclick = () => {
                         onConfirm();
                         closeModal(dom.alertModal, dom.alertModalContent);
                     };
                     document.getElementById('confirm-cancel-btn').onclick = () => {
                         closeModal(dom.alertModal, dom.alertModalContent);
                     };
                 }


                 function showAlert(message) {
                    dom.alertTitle.textContent = '操作提醒';
                    dom.alertModalText.textContent = message;

                     // Ensure the button is freshly added with a listener
                    dom.alertButtons.innerHTML = `<button id="alert-close-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">我知道了</button>`;

                    openModal(dom.alertModal, dom.alertModalContent);

                    // Add listener directly to the new button
                    document.getElementById('alert-close-btn').onclick = () => {
                         closeModal(dom.alertModal, dom.alertModalContent);
                    };
                }



                function showToast(message, type = "info") {
                    const toast = document.getElementById('toast');
                    const toastContent = document.getElementById('toast-content');
                     if (!toast || !toastContent) return; // Add null check
                    const icons = {
                        success: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>`,
                        error: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>`,
                        warning: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-orange-500 bg-orange-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.22 3.001-1.742 3.001H4.42c-1.522 0-2.492-1.667-1.742-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></div>`
                    };
                    toastContent.innerHTML = `${icons[type] || ''}<div class="ml-3 text-sm font-normal">${message}</div>`;
                    toast.classList.add('show');
                    setTimeout(() => { toast.classList.remove('show'); }, 3000);
                }

                function setupFilters() {
                    dom.staffFilter.innerHTML = `<option value="all">所有同仁</option>${staffList.map(s => `<option value="${s}">${s}</option>`).join('')}`;
                    dom.tierFilter.innerHTML = `<option value="all">所有分級</option>${tierList.map(t => `<option value="${t}">${t}級</option>`).join('')}`;
                    dom.statusFilter.innerHTML = `<option value="all">所有狀態</option>${contactStatusList.map(s => `<option value="${s}">${s}</option>`).join('')}`;
                }

                // --- 新增/編輯 Modal ---
                function openAddEditModal(docId = null) {
                    dom.addPublisherForm.reset();
                    document.getElementById('edit-publisher-id').value = '';
                    
                    document.getElementById('publisher-staff').innerHTML = staffList.map(s => `<option value="${s}">${s}</option>`).join('');
                    document.getElementById('publisher-tier').innerHTML = tierList.map(t => `<option value="${t}">${t}</option>`).join('');
                    document.getElementById('publisher-status').innerHTML = contactStatusList.map(s => `<option value="${s}">${s}</option>`).join('');
                    
                    const tagsContainer = document.getElementById('publisher-mission-tags-container');
                    // Ensure state.missionTags is available before rendering
                    tagsContainer.innerHTML = state.missionTags && state.missionTags.length > 0 ? state.missionTags.map(tag => `
                        <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
                            <input type="checkbox" name="mission-tag" value="${tag}" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500">
                            <span>${tag}</span>
                        </label>
                    `).join('') : '<p class="text-xs text-gray-500">尚無標籤</p>';


                    const tasksSection = document.getElementById('modal-task-dates-section');
                    const tasksContainer = document.getElementById('modal-task-dates-container');
                    tasksContainer.innerHTML = taskColumns.map(key => {
                        // Safely get header text, provide fallback if element not found
                         const headerElement = document.querySelector(`th[data-task-header="${key}"]`);
                         const headerText = headerElement ? headerElement.textContent : key; // Fallback to key if header not found
                        return `
                            <div>
                                <label for="modal-task-${key}" class="block text-xs font-medium text-gray-500">${headerText}</label>
                                <input type="date" id="modal-task-${key}" data-task-key="${key}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        `;
                    }).join('');
                    tasksSection.classList.add('hidden'); 

                    if (docId) { // Edit mode
                        document.getElementById('modal-title').textContent = '編輯出版社';
                        const pub = state.publishers.find(p => p.id === docId);
                        if (pub) {
                            document.getElementById('edit-publisher-id').value = pub.id;
                            document.getElementById('publisher-name').value = pub.name || ''; // Add fallbacks
                            document.getElementById('publisher-notion-url').value = pub.notionUrl || '';
                            document.getElementById('publisher-contract-id').value = pub.contractId || '';
                            document.getElementById('publisher-staff').value = pub.staff || staffList[0]; // Default to first staff if missing
                            document.getElementById('publisher-tier').value = pub.tier || tierList[0]; // Default to first tier if missing
                            document.getElementById('publisher-status').value = pub.contactStatus || contactStatusList[0]; // Default to first status if missing

                            if (Array.isArray(pub.missionTags)) {
                                pub.missionTags.forEach(tag => {
                                     // Safely query selector for tags that might contain special characters
                                    try {
                                        const checkbox = tagsContainer.querySelector(`input[value="${CSS.escape(tag)}"]`);
                                        if (checkbox) checkbox.checked = true;
                                    } catch (e) {
                                       // console.error(`Error selecting checkbox for tag: ${tag}`, e);
                                    }
                                });
                            }
                            if (pub.tasks) {
                                taskColumns.forEach(key => {
                                    const input = tasksContainer.querySelector(`[data-task-key="${key}"]`);
                                    if (input && pub.tasks[key]) {
                                        // Basic date validation before setting value
                                         const dateValue = String(pub.tasks[key]);
                                         if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) { // Check YYYY-MM-DD format
                                             input.value = dateValue;
                                         } else {
                                             // console.warn(`Invalid date format for task ${key} in publisher ${pub.id}: ${dateValue}`);
                                             input.value = ''; // Clear invalid date
                                         }
                                    } else if (input) {
                                         input.value = ''; // Ensure empty if no task date
                                    }
                                });
                            }
                            if (pub.contactStatus === "已簽回，已移交合約") {
                                tasksSection.classList.remove('hidden');
                            }
                        } else {
                             console.error(`Publisher with ID ${docId} not found for editing.`);
                             showToast("找不到要編輯的資料", "error");
                             return; // Exit if publisher not found
                        }
                    } else { // Add mode
                        document.getElementById('modal-title').textContent = '新增出版社';
                         // Set default values for add mode if desired
                         document.getElementById('publisher-staff').value = staffList[staffList.length -1]; // Default to '未分配'
                         document.getElementById('publisher-tier').value = tierList[tierList.length -1]; // Default to 'X'
                         document.getElementById('publisher-status').value = contactStatusList[0]; // Default to '未聯繫'
                    }
                    
                    openModal(dom.addPublisherModal, dom.addPublisherModalContent);
                }
                
                async function handleSavePublisher(e) {
                    e.preventDefault();
                    const docId = document.getElementById('edit-publisher-id').value;
                    const selectedTags = Array.from(document.querySelectorAll('#publisher-mission-tags-container input:checked')).map(cb => cb.value);
                    const contactStatus = document.getElementById('publisher-status').value;

                    // Validation: Check if name is provided
                     const publisherName = document.getElementById('publisher-name').value.trim();
                     if (!publisherName) {
                         showAlert('出版社名稱為必填欄位。');
                         return;
                     }


                    if (contactStatus === '已簽回，已移交合約') {
                        const taskDateInputs = document.querySelectorAll('#modal-task-dates-container input[type="date"]');
                        const hasAtLeastOneDate = Array.from(taskDateInputs).some(input => input.value !== '');
                        if (!hasAtLeastOneDate) {
                            showAlert('當狀態為「已簽回，已移交合約」時，請至少填寫一項任務的完成日期。');
                            return;
                        }
                    }

                     // Ensure tasks object exists, initialize if needed
                     let currentTasks = {};
                     if (docId) {
                         const existingPub = state.publishers.find(p => p.id === docId);
                         currentTasks = (existingPub && typeof existingPub.tasks === 'object' && existingPub.tasks !== null) ? { ...existingPub.tasks } : {};
                     } else {
                         // For new entries, initialize all task keys to null
                         taskColumns.forEach(key => currentTasks[key] = null);
                     }


                    document.querySelectorAll('#modal-task-dates-container input[type="date"]').forEach(input => {
                        const key = input.dataset.taskKey;
                        currentTasks[key] = input.value || null; // Store empty string as null
                    });

                    const publisherData = {
                        name: publisherName,
                        notionUrl: document.getElementById('publisher-notion-url').value.trim() || null,
                        contractId: document.getElementById('publisher-contract-id').value.trim() || null,
                        staff: document.getElementById('publisher-staff').value,
                        tier: document.getElementById('publisher-tier').value,
                        contactStatus: contactStatus,
                        missionTags: selectedTags,
                        tasks: currentTasks // Use the potentially updated tasks object
                    };
                    
                    try {
                        if (docId) { // Update
                            const docRef = doc(state.publishersCollection, docId);
                            await updateDoc(docRef, publisherData);
                            showToast("出版社更新成功", "success");
                        } else { // Add
                            await addDoc(state.publishersCollection, publisherData);
                            showToast("出版社新增成功", "success");
                        }
                    } catch (error) {
                        console.error("Error saving document: ", error);
                        showToast("儲存失敗: " + error.message, "error"); // Show more error details
                    }
                    closeModal(dom.addPublisherModal, dom.addPublisherModalContent);
                }

                // --- 標籤管理 ---
                function renderTagManagementUI() {
                     // Check if missionTags is defined and is an array
                    const tagsHtml = Array.isArray(state.missionTags) ? state.missionTags.map((tag, index) => `
                        <div class="flex items-center justify-between p-2 border-b">
                            <span class="text-gray-800">${tag}</span>
                            <div class="space-x-2">
                                <button class="edit-tag-btn p-1 text-gray-400 hover:text-indigo-600" data-index="${index}" title="編輯">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                                </button>
                                <button class="delete-tag-btn p-1 text-gray-400 hover:text-red-600" data-index="${index}" title="刪除">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    `).join('') : ''; // Provide an empty string if not an array

                    dom.tagListContainer.innerHTML = tagsHtml || `<p class="text-center text-gray-500 py-4">目前沒有任何標籤</p>`;
                }


                async function updateTagsInFirestore(newTags) {
                     if (!state.settingsCollection) {
                        console.error("Settings collection not initialized.");
                        showToast("無法更新標籤：資料庫未連接", "error");
                        return;
                     }
                    const docRef = doc(state.settingsCollection, 'missionTags');
                    try {
                        await setDoc(docRef, { list: newTags });
                        showToast("標籤列表已更新", "success");
                    } catch (error) {
                        console.error("Error updating tags:", error);
                        showToast("標籤更新失敗", "error");
                    }
                }

                function handleAddTag() {
                    const input = document.getElementById('new-tag-input');
                    const newTag = input.value.trim();
                    if (!newTag) return;
                    // Ensure state.missionTags is an array before checking includes
                     const currentTags = Array.isArray(state.missionTags) ? state.missionTags : [];
                    if (currentTags.includes(newTag)) {
                        showToast("此標籤已存在", "warning");
                        return;
                    }
                    const newTags = [...currentTags, newTag];
                    updateTagsInFirestore(newTags);
                    input.value = '';
                }
                
                function handleTagAction(e) {
                    const editBtn = e.target.closest('.edit-tag-btn');
                    const deleteBtn = e.target.closest('.delete-tag-btn');
                    // Ensure state.missionTags is an array
                     const currentTags = Array.isArray(state.missionTags) ? state.missionTags : [];
                    
                    if (editBtn) {
                        const index = parseInt(editBtn.dataset.index);
                         if (isNaN(index) || index < 0 || index >= currentTags.length) return; // Validate index
                        const oldTag = currentTags[index];
                        const newTag = prompt("請輸入新的標籤名稱：", oldTag);
                        if (newTag && newTag.trim() !== '' && newTag !== oldTag) {
                             // Check for duplicates before updating
                             if (currentTags.includes(newTag.trim())) {
                                showToast("此標籤名稱已存在", "warning");
                                return;
                             }
                            const newTags = [...currentTags];
                            newTags[index] = newTag.trim();
                            updateTagsInFirestore(newTags);
                        }
                    }

                    if (deleteBtn) {
                        const index = parseInt(deleteBtn.dataset.index);
                         if (isNaN(index) || index < 0 || index >= currentTags.length) return; // Validate index
                        const tagToDelete = currentTags[index];
                        showConfirmation('確認刪除', `您確定要刪除標籤 "${tagToDelete}" 嗎？此操作無法復原。`, () => {
                            const newTags = currentTags.filter((_, i) => i !== index);
                            updateTagsInFirestore(newTags);
                        });
                    }
                }
                
                // --- XLSX Import/Export ---
                // (The import/export functions are quite long, keeping them as is, since their logic is mostly self-contained and correct)
                function downloadTemplate() {
                    const baseHeaders = ["出版社名稱", "Notion 紀錄連結", "合約編號", "負責同仁", "分級", "聯繫狀態", "任務標籤"]; // Corrected header name
                    // Safely get task headers
                    const taskHeaders = taskColumns.map(key => {
                        const headerElement = document.querySelector(`th[data-task-header="${key}"]`);
                        return headerElement ? headerElement.textContent : key; // Fallback to key
                    });

                    const allHeaders = [...baseHeaders, ...taskHeaders];
                    // Provide clearer example data
                     const exampleRow = [ "範例出版社", "https://notion.so/...", "EBK-EX-001", "陳玫君", "A", "聯繫中", "未合作，取得合作, 取B2C", "", "2025-08-15", "", "", "", "", "", "", "", "", "" ]; // Match header count
                    const worksheet = window.XLSX.utils.aoa_to_sheet([allHeaders, exampleRow]);
                     // Set column widths (optional but helpful)
                     worksheet['!cols'] = allHeaders.map((_, i) => ({ wch: i < 7 ? 20 : 15 })); // Adjust widths as needed
                    const workbook = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(workbook, worksheet, "出版社");
                    window.XLSX.writeFile(workbook, "出版社匯入範本.xlsx");
                }


                function handleFileImport(event) {
                    const file = event.target.files[0]; if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                         if (!state.db || !state.publishersCollection) {
                             showToast("資料庫未連接，無法匯入", "error");
                             return;
                         }
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = window.XLSX.read(data, { type: 'array', cellDates: true }); // Enable cellDates for better date parsing
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            // Use header option 1 to get array of arrays, easier header mapping
                             const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: 'yyyy-mm-dd' });

                             if (!jsonData || jsonData.length < 2) { // Need header + at least one data row
                                showToast("檔案為空或格式不符（需要標題列）", "error");
                                return;
                            }

                            const headers = jsonData[0].map(h => String(h).trim()); // Get headers from first row
                             const dataRows = jsonData.slice(1); // Get data rows

                             // --- Map headers to expected keys ---
                            const headerMap = {};
                            const expectedBaseHeaders = ["出版社名稱", "Notion 紀錄連結", "合約編號", "負責同仁", "分級", "聯繫狀態", "任務標籤"]; // Match template
                            expectedBaseHeaders.forEach(eh => {
                                const index = headers.findIndex(h => h === eh);
                                if (index !== -1) headerMap[eh] = index;
                            });

                             const taskHeaderMap = {};
                             taskColumns.forEach(key => {
                                 const headerElement = document.querySelector(`th[data-task-header="${key}"]`);
                                 const expectedHeader = headerElement ? headerElement.textContent : key;
                                 const index = headers.findIndex(h => h === expectedHeader);
                                 if (index !== -1) taskHeaderMap[key] = index;
                             });
                            // --- End Header Mapping ---


                            const batch = writeBatch(state.db);
                            let createdCount = 0, updatedCount = 0, skippedCount = 0;
                            const importErrors = [];
                            
                             for (let i = 0; i < dataRows.length; i++) {
                                 const row = dataRows[i];
                                 const rowIndex = i + 2; // Excel row number (1-based + header)

                                 const publisherNameIndex = headerMap["出版社名稱"];
                                 const publisherName = (publisherNameIndex !== undefined && row[publisherNameIndex]) ? String(row[publisherNameIndex]).trim() : null;

                                if (!publisherName) {
                                     // Skip row if publisher name is missing
                                     skippedCount++;
                                     importErrors.push(`第 ${rowIndex} 行：缺少出版社名稱，已跳過。`);
                                    continue;
                                }
                                
                                const missionTagIndex = headerMap["任務標籤"];
                                 const missionTagString = (missionTagIndex !== undefined && row[missionTagIndex]) ? String(row[missionTagIndex]) : '';
                                 const missionTags = missionTagString ? missionTagString.split(',').map(t => t.trim()).filter(t => t) : []; // Filter empty tags

                                const getVal = (headerKey) => {
                                     const index = headerMap[headerKey];
                                     return (index !== undefined && row[index] !== null && row[index] !== undefined) ? String(row[index]).trim() : null;
                                 };

                                const publisherData = {
                                    name: publisherName,
                                    notionUrl: getVal("Notion 紀錄連結"),
                                    contractId: getVal("合約編號"),
                                    staff: getVal("負責同仁") || '未分配', // Default if empty
                                    tier: getVal("分級") || 'X', // Default if empty
                                    contactStatus: getVal("聯繫狀態") || '未聯繫', // Default if empty
                                    missionTags: missionTags,
                                    tasks: {}
                                };
                                Object.keys(taskHeaderMap).forEach(key => {
                                     const index = taskHeaderMap[key];
                                     const rawValue = row[index];
                                    publisherData.tasks[key] = normalizeDate(rawValue); // Use normalizeDate for consistency
                                });

                                // Check for existing publisher (case-insensitive check might be better)
                                const existingPub = state.publishers.find(p => p.name.toLowerCase() === publisherName.toLowerCase());
                                const docRef = existingPub ? doc(state.publishersCollection, existingPub.id) : doc(state.publishersCollection);

                                try {
                                    batch.set(docRef, publisherData, { merge: true }); // Use merge to avoid overwriting unrelated fields if structure changes
                                    existingPub ? updatedCount++ : createdCount++;
                                } catch (batchError) {
                                     skippedCount++;
                                     importErrors.push(`第 ${rowIndex} 行 (${publisherName})：寫入資料庫時出錯 - ${batchError.message}`);
                                }

                                 // Commit batch periodically to avoid exceeding limits
                                 if ((createdCount + updatedCount) % 400 === 0) {
                                     await batch.commit();
                                     batch = writeBatch(state.db); // Start a new batch
                                 }
                            }
                             await batch.commit(); // Commit any remaining changes

                             let message = `匯入完成：${createdCount} 筆新增，${updatedCount} 筆更新。`;
                            if (skippedCount > 0) {
                                message += ` ${skippedCount} 筆資料因缺少名稱或其他錯誤而被跳過。`;
                                console.warn("匯入錯誤:\n" + importErrors.join("\n"));
                                // Consider showing errors in a modal for the user
                                showAlert(`部分資料匯入失敗 (${skippedCount} 筆)，請檢查主控台(Console)獲取詳細資訊。`);
                             } else {
                                showToast(message, "success");
                             }

                        } catch (error) {
                            showToast("檔案處理失敗，請確認格式或內容", "error");
                            console.error("Error processing XLSX:", error);
                        } finally {
                            event.target.value = ''; // Clear file input
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
                
                 function normalizeDate(value) {
                     if (value === null || typeof value === 'undefined' || String(value).trim() === '') return null;

                     let date;
                     if (typeof value === 'number') {
                         // Handle Excel date serial number (adjust epoch difference)
                         // Excel epoch starts Dec 30, 1899; JS epoch Jan 1, 1970
                         // There's also a leap year bug in Excel for 1900
                         const excelEpochDiff = 25569; // Days between 1970-01-01 and 1900-01-01 (adjusting for leap year bug)
                         const correctValue = value > 60 ? value - 1 : value; // Adjust for 1900 leap year bug
                         date = new Date((correctValue - excelEpochDiff) * 86400 * 1000);
                     } else {
                         // Try parsing strings, including common formats like MM/DD/YYYY or YYYY.MM.DD
                         let dateString = String(value).replace(/\./g, '-').replace(/\//g, '-');
                         // Attempt to parse various formats, prioritize YYYY-MM-DD
                         date = new Date(dateString);
                         // If initial parsing fails or results in an invalid date, try swapping month/day for MM-DD-YYYY
                         if (isNaN(date.getTime())) {
                            const parts = dateString.split('-');
                            if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2) {
                               // Assume MM-DD-YYYY or M-D-YYYY format, try swapping
                               date = new Date(`${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`);
                            }
                         }
                     }

                     // Final validation and formatting
                     if (date instanceof Date && !isNaN(date.getTime()) && date.getFullYear() > 1900) { // Check validity and reasonable year
                         const year = date.getFullYear();
                         const month = (date.getMonth() + 1).toString().padStart(2, '0');
                         const day = date.getDate().toString().padStart(2, '0');
                         return `${year}-${month}-${day}`;
                     }
                    // console.warn("Could not normalize date:", value);
                     return null; // Return null if parsing/validation fails
                 }

                
                // --- 表四 & 表五 Card 相關函式 ---
                function handleTierProgressFilter(e) {
                    const selectedValue = e.target.value;
                    document.querySelectorAll('.progress-card').forEach(card => {
                        card.style.display = (selectedValue === 'all' || card.dataset.name === selectedValue) ? '' : 'none';
                    });
                }

                function handleTierCardClick(e) {
                    const statEl = e.target.closest('.clickable-stat');
                    if (!statEl) return;

                    const cell = statEl.closest('td');
                    const row = statEl.closest('tr');
                    const card = statEl.closest('.progress-card');
                    
                     // Add checks to ensure elements were found
                    if (!cell || !row || !card || !cell.dataset.stage || !row.dataset.tier || !card.dataset.name) {
                        console.warn("Could not determine filter criteria from clicked element.");
                        return;
                    }


                    const staff = card.dataset.name;
                    const tier = row.dataset.tier;
                    const status = cell.dataset.stage;

                    const filtered = state.publishers.filter(p => p.staff === staff && p.tier === tier && p.contactStatus === status);

                    document.getElementById('publisher-list-title').textContent = `${staff} - ${tier}級 - ${status}`;
                    const listBody = document.getElementById('publisher-list-body');
                     if (!listBody) return; // Check element exists
                    listBody.innerHTML = filtered.length > 0 
                        ? filtered.map(p => `<li>${p.name} (${p.contractId || '無編號'})</li>`).join('') 
                        : '<li>無符合條件的出版社</li>';
                    
                    openModal(dom.publisherListModal, dom.publisherListModalContent);
                }
                
                function createProgressCardHTML(name, data) {
                    let totalRow = { "母體數": 0 };
                    contactStatusList.forEach(s => totalRow[s] = 0);
                    
                    let tableBody = tierList.map(tier => {
                        const tierData = data[tier];
                         // Skip if tierData is missing or total is 0
                         if (!tierData || !tierData.total || tierData.total === 0) return '';
                        let stageHtml = '';
                        contactStatusList.forEach(stage => {
                             // Use hasOwnProperty for safer access and default to 0
                            const value = tierData.stages.hasOwnProperty(stage) ? tierData.stages[stage] : 0;
                            const percentage = tierData.total > 0 ? (value / tierData.total * 100).toFixed(0) : 0;
                            stageHtml += `<td data-stage="${stage}" data-value="${value}"><span class="clickable-stat">${value}</span><span class="percentage">(${percentage}%)</span></td>`;
                            totalRow[stage] += value;
                        });
                        totalRow["母體數"] += tierData.total;
                        return `<tr class="border-b" data-tier="${tier}"><td class="px-3 py-3 font-medium text-gray-900 text-left">${tier}級</td>${stageHtml}<td class="font-bold bg-gray-50 text-gray-800">${tierData.total}</td></tr>`;
                    }).join('');

                     // Only return card if there's data to show
                    if (totalRow["母體數"] === 0) return '';
                    return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 progress-card" data-name="${name}"><h3 class="text-xl font-bold text-gray-800 mb-4">${name}</h3><div class="overflow-x-auto"><table class="w-full text-xs text-center text-gray-600"><thead class="bg-gray-100 text-gray-700 uppercase"><tr><th class="px-3 py-3 text-left">分級</th>${contactStatusList.map(s => `<th class="px-3 py-3">${s.replace('已聯繫，','')}</th>`).join('')}<th class="px-3 py-3 bg-gray-200 font-bold">母體數</th></tr></thead><tbody>${tableBody}<tr class="bg-gray-100 font-bold"><td class="px-3 py-4 text-gray-900 text-left">總計</td>${contactStatusList.map(s => `<td>${totalRow[s]}</td>`).join('')}<td class="bg-indigo-100 text-indigo-800">${totalRow["母體數"]}</td></tr></tbody></table></div></div>`;
                }


                function applyHealthCheck() {
                    document.querySelectorAll('.progress-card').forEach(card => {
                        const aTierRow = card.querySelector('tr[data-tier="A"]');
                        if (aTierRow) {
                             const notContactedCell = aTierRow.querySelector('td[data-stage="未聯繫"]');
                             const totalCell = aTierRow.cells[aTierRow.cells.length - 1]; // Last cell for total

                             // Ensure cells and data attributes exist
                            if (notContactedCell && notContactedCell.dataset.value && totalCell) {
                                const total = parseInt(totalCell.textContent || '0'); // Get total from cell text
                                const notContactedCount = parseInt(notContactedCell.dataset.value);
                                const percentage = total > 0 ? (notContactedCount / total) * 100 : 0;
                                
                                notContactedCell.classList.remove('health-warning', 'health-critical');
                                if (percentage >= 50) notContactedCell.classList.add('health-critical');
                                else if (percentage >= 25) notContactedCell.classList.add('health-warning');
                            }
                        }
                    });
                }


                // --- Export Handler ---
                function handleExport() {
                    const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="export-option"]:checked'));
                    if(selectedCheckboxes.length === 0) {
                        showToast("請至少選擇一個要匯出的報表", "warning");
                        return;
                    }
                    
                    const workbook = window.XLSX.utils.book_new();
                    
                    // Info Sheet
                    const infoSheetData = [
                        ["報表匯出資訊"],
                        ["匯出日期", new Date().toLocaleString()],
                        [""],
                        ["篩選條件"],
                        ["搜尋關鍵字", state.filters.search || "(無)"],
                        ["負責同仁", state.filters.staff === 'all' ? "(全部)" : state.filters.staff],
                        ["分級", state.filters.tier === 'all' ? "(全部)" : state.filters.tier],
                        ["聯繫狀態", state.filters.status === 'all' ? "(全部)" : state.filters.status],
                        [""],
                        ["匯出的報表"],
                        ...selectedCheckboxes.map(cb => [cb.nextElementSibling.textContent.trim()])
                    ];
                    const infoSheet = window.XLSX.utils.aoa_to_sheet(infoSheetData);
                    infoSheet['!cols'] = [{ wch: 30 }, { wch: 30 }];
                    window.XLSX.utils.book_append_sheet(workbook, infoSheet, "匯出資訊");

                    // Data Sheets
                    const exportFunctions = {
                        table1: getPublisherMasterDataForExport,
                        table2: getTeamSigningDataForExport,
                        table3: getIndividualSigningDataForExport,
                        table4: getPublisherTierDataForExport,
                        table5: getIndividualContactDataForExport,
                    };
                    const sheetNames = {
                        table1: "表一_出版社母體管理",
                        table2: "表二_團隊簽約進度",
                        table3: "表三_個人簽約進度",
                        table4: "表四_分級聯繫進度",
                        table5: "表五_個人聯繫進度",
                    };

                    selectedCheckboxes.forEach(checkbox => {
                        const optionValue = checkbox.value;
                         if (exportFunctions[optionValue]) { // Check if function exists
                             try {
                                const data = exportFunctions[optionValue]();
                                if (data && data.length > 0) {
                                    const worksheet = window.XLSX.utils.json_to_sheet(data);
                                    window.XLSX.utils.book_append_sheet(workbook, worksheet, sheetNames[optionValue]);
                                } else {
                                     console.warn(`No data generated for export option: ${optionValue}`);
                                     // Optionally add an empty sheet or skip
                                }
                             } catch (error) {
                                 console.error(`Error generating data for export option ${optionValue}:`, error);
                                 showToast(`匯出 ${sheetNames[optionValue]} 時發生錯誤`, "error");
                             }
                         } else {
                            console.warn(`Export function not found for option: ${optionValue}`);
                         }
                    });
                    
                     // Only attempt to write file if there are data sheets (or at least the info sheet)
                    if (workbook.SheetNames.length > 1) {
                         try {
                            window.XLSX.writeFile(workbook, `徵集進度報表_${new Date().toISOString().slice(0,10)}.xlsx`);
                            showToast("報表匯出成功！", "success");
                         } catch (writeError) {
                             console.error("Error writing XLSX file:", writeError);
                             showToast("匯出檔案失敗", "error");
                         }
                    } else if (workbook.SheetNames.length === 1) {
                         showToast("沒有選擇任何包含資料的報表來匯出", "warning");
                    } else {
                         showToast("無法產生匯出檔案", "error");
                    }
                }
                
                // --- Export Data Formatting ---
                 function getPublisherMasterDataForExport() {
                     return getFilteredAndSortedData().map(pub => {
                         let row = {
                             "出版社名稱": pub.name || '',
                             "Notion 紀錄連結": pub.notionUrl || '',
                             "合約編號": pub.contractId || '',
                             "負責同仁": pub.staff || '',
                             "分級": pub.tier || '',
                             "聯繫狀態": pub.contactStatus || '',
                             "任務標籤": Array.isArray(pub.missionTags) ? pub.missionTags.join(', ') : ''
                         };
                         // Ensure tasks exist before iterating
                         const tasks = pub.tasks || {};
                         taskColumns.forEach(key => {
                             const headerElement = document.querySelector(`th[data-task-header="${key}"]`);
                             const headerText = headerElement ? headerElement.textContent : key;
                             row[headerText] = tasks[key] || ''; // Use empty string for null/undefined dates
                         });
                         return row;
                     });
                 }


                 function getTeamSigningDataForExport() {
                    const headerRow = ["項目", "目標_8月", "目標_9月", "目標_10月", "目標_11月", "目標_12月", "目標_家數合計", "進度_8月", "達成率_8月", "進度_9月", "達成率_9月", "進度_10月", "達成率_10月", "進度_11月", "達成率_11月", "進度_12月", "達成率_12月", "進度_家數合計", "各項目達成率", "缺口家數"];
                     const tableData = [Object.fromEntries(headerRow.map(h => [h, h]))]; // Header row as first object

                    const kpiTableBody = document.getElementById('kpi-table-body');
                    const kpiTableFooter = document.getElementById('kpi-table-footer');
                     if (!kpiTableBody || !kpiTableFooter) return tableData; // Return headers only if table not found

                     const bodyRows = kpiTableBody.rows;
                     const footerRow = kpiTableFooter.rows[0];

                     Array.from(bodyRows).forEach(row => {
                         const rowData = {};
                         Array.from(row.cells).forEach((cell, i) => {
                             // Clean up percentage values if needed
                             let text = cell.textContent || '';
                             if (headerRow[i].includes('達成率') || headerRow[i].includes('各項目達成率')) {
                                text = text.replace('%', ''); // Remove % sign for number format
                             }
                              // Basic number conversion attempt
                              const num = parseFloat(text);
                              rowData[headerRow[i]] = isNaN(num) ? text : num; // Store as number if possible
                         });
                         tableData.push(rowData);
                     });

                     if (footerRow) {
                        const footerData = {};
                        Array.from(footerRow.cells).forEach((cell, i) => {
                             let text = cell.textContent || '';
                             if (headerRow[i].includes('達成率') || headerRow[i].includes('各項目達成率')) {
                                text = text.replace('%', '');
                             }
                             const num = parseFloat(text);
                             footerData[headerRow[i]] = isNaN(num) ? text : num;
                         });
                        tableData.push(footerData);
                     }
                     return tableData.slice(1); // Return data without the header object
                 }


                function getIndividualSigningDataForExport() {
                     // Ensure stats are available
                    const stats = state.analytics.individualSigningStats || [];
                    return stats.map(row => ({
                        "負責人": row.name,
                        "負責單位數": row.total,
                        "已簽約": row.signed,
                        "簽約率(%)": parseFloat(row.rate.toFixed(1)), // Store as number
                    }));
                }

                 function getPublisherTierDataForExport() {
                     const flatData = [];
                     const progressData = state.analytics.tierProgressStats || {}; // Default to empty object
                     Object.keys(progressData).sort().forEach(staffName => {
                         const staffTiers = progressData[staffName] || {};
                         Object.keys(staffTiers).sort().forEach(tier => {
                             const tierData = staffTiers[tier];
                             if (tierData && tierData.total > 0) {
                                const stages = tierData.stages || {};
                                 contactStatusList.forEach(stage => {
                                     const count = stages[stage] || 0;
                                     if (count > 0) {
                                         flatData.push({
                                             "負責同仁": staffName,
                                             "分級": tier,
                                             "聯繫狀態": stage,
                                             "出版社數量": count
                                         });
                                     }
                                 });
                             }
                         });
                     });
                     return flatData;
                 }


                function getIndividualContactDataForExport(){
                     const stats = state.analytics.individualContactStats || [];
                    return stats.map(row => ({
                        "負責人": row.name,
                        "總單位": row.total,
                        "已聯繫": row.contacted,
                        "聯繫率(%)": parseFloat(row.rate.toFixed(0)) // Store as number
                    }));
                }

                // --- NEWLY ADDED/FIXED FUNCTIONS ---
                
                function applyPermissions() {
                    const user = state.currentUser;
                    const nav = document.getElementById('main-nav');
                    const userInfo = document.getElementById('user-info');
                     if (!user || !nav || !userInfo) {
                        console.error("Cannot apply permissions: User, nav, or userInfo element not found.");
                        return; // Exit if essential elements aren't ready
                     }

                    const navItems = [
                        { id: 'publisher-master', icon: 'M4 6h16M4 12h16M4 18h7', text: '出版社母體管理' },
                        { id: 'team-signing', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 01-2.732 2.732M11 16V7a3 3 0 016 0v9', text: '團隊簽約進度' },
                        { id: 'individual-signing', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z', text: '個人簽約進度' },
                        { id: 'publisher-tier', icon: 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z', text: '分級聯繫進度' },
                        { id: 'individual-contact', icon: 'M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z', text: '個人聯繫進度' },
                        { id: 'tag-management', icon: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z', text: '標籤管理', adminOnly: true },
                        { id: 'user-management', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', text: '使用者管理', adminOnly: true },
                        { id: 'export', icon: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12', text: '匯出報表' }
                    ];

                    let navHtml = '';
                    navItems.forEach(item => {
                         // Check user role OR specific permission for non-admin users
                        const hasPermission = user.role === 'admin' || (user.permissions && user.permissions[item.id]);
                        const isVisible = !item.adminOnly || hasPermission; // Admins see adminOnly, users need explicit permission

                        if (isVisible) {
                             navHtml += `
                                <a href="#" id="nav-${item.id.replace(/([A-Z])/g, '-$1').toLowerCase()}" class="nav-link flex items-center px-4 py-2.5 text-sm font-semibold text-gray-600 rounded-lg hover:bg-indigo-50 transition-colors duration-200">
                                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"></path></svg>
                                    ${item.text}
                                </a>
                            `;
                        }
                    });
                    nav.innerHTML = navHtml;

                    userInfo.innerHTML = `<span>歡迎，<strong>${user.username}</strong> (${user.role === 'admin' ? '管理者' : '使用者'})</span>`;

                     // Hide/Show elements based on role (e.g., User Management button)
                     const addUserBtn = document.getElementById('add-user-btn');
                     if (addUserBtn) addUserBtn.style.display = user.role === 'admin' ? 'inline-flex' : 'none';
                     // Add similar logic for other admin-only controls if needed
                }


                 function renderUserManagementUI() {
                     if (!state.currentUser || state.currentUser.role !== 'admin' || !dom.userListBody) return; // Add checks
                     dom.userListBody.innerHTML = state.users.map(user => {
                        // Safely access permissions and format them
                        let permissionsText = '無';
                         if (user.role === 'admin') {
                            permissionsText = '所有權限';
                         } else if (user.permissions && Object.keys(user.permissions).length > 0) {
                            permissionsText = Object.keys(user.permissions)
                                .map(key => pageTitles[key] || key) // Use readable names
                                .join(', ');
                         }

                         return `
                             <tr class="bg-white border-b hover:bg-gray-50" data-id="${user.id}">
                                 <td class="px-6 py-4 font-medium text-gray-900">${user.username}</td>
                                 <td class="px-6 py-4">${user.role === 'admin' ? '管理者' : '一般使用者'}</td>
                                 <td class="px-6 py-4 text-xs">${permissionsText}</td>
                                 <td class="px-6 py-4 space-x-2 whitespace-nowrap">
                                     <button class="edit-user-btn text-indigo-600 hover:text-indigo-900 font-medium text-sm">編輯</button>
                                     ${user.username !== 'admin' ? `<button class="delete-user-btn text-red-600 hover:text-red-900 font-medium text-sm">刪除</button>` : ''}
                                 </td>
                             </tr>
                         `;
                     }).join('');
                 }


                function openUserModal(userId = null) {
                    dom.userForm.reset();
                    document.getElementById('edit-user-id').value = '';
                    const passwordInput = document.getElementById('user-password');
                    const passwordHint = document.getElementById('password-hint');
                    const usernameInput = document.getElementById('user-username'); // Get username input
                    
                    const permissionsContainer = document.getElementById('permissions-container');
                     // Filter out admin-only pages from permissions checkboxes
                    permissionsContainer.innerHTML = Object.keys(pageTitles)
                        .filter(key => key !== 'userManagement' && key !== 'tagManagement') // Exclude admin pages
                        .map(key => `
                        <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
                           <input type="checkbox" name="permission" value="${key}" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500">
                           <span>${pageTitles[key]}</span>
                        </label>
                    `).join('');

                    if (userId) { // Edit mode
                        document.getElementById('user-modal-title').textContent = '編輯使用者';
                        passwordInput.required = false;
                        passwordHint.textContent = '若要變更密碼，請輸入新密碼。留空則不變更。';
                        const user = state.users.find(u => u.id === userId);
                        if (user) {
                            document.getElementById('edit-user-id').value = user.id;
                            usernameInput.value = user.username;
                            usernameInput.disabled = true; // Prevent username change
                            document.getElementById('user-role').value = user.role;
                             if(user.role === 'user' && user.permissions){
                                Object.keys(user.permissions).forEach(perm => {
                                   const checkbox = permissionsContainer.querySelector(`input[value="${perm}"]`);
                                   if(checkbox) checkbox.checked = true;
                                });
                             }
                        } else {
                            console.error(`User with ID ${userId} not found for editing.`);
                            showToast("找不到要編輯的使用者", "error");
                            return;
                        }
                    } else { // Add mode
                        document.getElementById('user-modal-title').textContent = '新增使用者';
                        passwordInput.required = true;
                        passwordHint.textContent = '新增使用者時，此欄位為必填。';
                        usernameInput.disabled = false; // Allow username input for new user
                         usernameInput.value = ''; // Clear username field for add mode
                    }

                    document.getElementById('permissions-section').style.display = document.getElementById('user-role').value === 'user' ? 'block' : 'none';
                    openModal(dom.userModal, dom.userModalContent);
                }
                
                async function handleUserAction(e) {
                    const editBtn = e.target.closest('.edit-user-btn');
                    const deleteBtn = e.target.closest('.delete-user-btn');
                    const row = e.target.closest('tr');
                    if (!row || !state.usersCollection) return; // Add check for collection

                    const userId = row.dataset.id;
                    if (editBtn) {
                        openUserModal(userId);
                    }
                    if (deleteBtn) {
                        const user = state.users.find(u => u.id === userId);
                         if (!user) return; // Exit if user not found
                        showConfirmation('確認刪除', `您確定要刪除使用者 "${user.username}" 嗎？`, async () => {
                            try {
                                await deleteDoc(doc(state.usersCollection, userId));
                                showToast('使用者已刪除', 'success');
                                // No need to manually remove from state.users, Firestore listener will update it
                            } catch (error) {
                                console.error("Error deleting user:", error);
                                showToast('刪除失敗', 'error');
                            }
                        });
                    }
                }

                async function handleSaveUser(e) {
                    e.preventDefault();
                     if (!state.usersCollection) {
                        showToast("無法儲存使用者：資料庫未連接", "error");
                        return;
                     }
                    const userId = document.getElementById('edit-user-id').value;
                    const username = document.getElementById('user-username').value.trim(); // Trim username
                    const password = document.getElementById('user-password').value;
                    const role = document.getElementById('user-role').value;
                    
                     // Basic validation
                     if (!username) {
                         showAlert('請輸入使用者名稱。');
                         return;
                     }
                    if (!userId && !password) { // Password required only for new users
                         showAlert('新增使用者時必須輸入密碼。');
                         return;
                     }


                    const permissions = {};
                    if (role === 'user') {
                        document.querySelectorAll('#permissions-container input:checked').forEach(cb => {
                            permissions[cb.value] = true;
                        });
                    }

                    const userData = { username, role, permissions };

                    if (userId) { // Update
                        if (password) {
                            userData.password = password; // Only update password if provided and not empty
                        } else {
                             // Explicitly remove password field if empty to avoid accidentally setting it
                             delete userData.password;
                        }
                        try {
                            await updateDoc(doc(state.usersCollection, userId), userData);
                            showToast('使用者更新成功', 'success');
                             // Update currentUser if the edited user is the logged-in user
                             if (state.currentUser && state.currentUser.id === userId) {
                                state.currentUser = { ...state.currentUser, ...userData };
                                applyPermissions(); // Re-apply permissions if role/permissions changed
                             }
                        } catch (error) {
                            console.error("Error updating user:", error);
                            showToast('更新失敗: ' + error.message, 'error');
                        }
                    } else { // Add
                        // Check for existing username (case-insensitive) before adding
                        const existingUser = state.users.find(u => u.username.toLowerCase() === username.toLowerCase());
                        if(existingUser) {
                           showAlert('此使用者名稱已存在。');
                           return;
                        }
                        userData.password = password; // Add password for new user
                         try {
                            await addDoc(state.usersCollection, userData);
                            showToast('使用者新增成功', 'success');
                             document.getElementById('user-password').value = ''; // Clear password field after successful add
                        } catch (error) {
                            console.error("Error adding user:", error);
                            showToast('新增失敗: ' + error.message, 'error');
                        }
                    }
                    closeModal(dom.userModal, dom.userModalContent);
                }
                
            } // End of initDashboard
        });
    </script>
</body>
</html>

