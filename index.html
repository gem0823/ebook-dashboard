<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>eBook Dashboard</title>

  <!-- æª”æ¡ˆ 1: ç™»å…¥é é¢æ¨£å¼ (AdminLTE) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">

  <!-- æª”æ¡ˆ 2: å„€è¡¨æ¿æ¨£å¼ (Tailwind & SheetJS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- æª”æ¡ˆ 2: å„€è¡¨æ¿è‡ªè¨‚æ¨£å¼ -->
  <style>
    /* ä½¿ç”¨ Inter å’Œ Noto Sans TC å­—é«” */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body {
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
    }
    /* ... (æª”æ¡ˆ 2 çš„æ‰€æœ‰å…¶ä»– CSS æ¨£å¼) ... */
    .content-section { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
    .content-section.hidden { opacity: 0; transform: translateY(10px); position: absolute; width: 100%; pointer-events: none; }
    .modal-content.open { transform: scale(1); opacity: 1; }
    .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .table-container::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 3px; }
    .table-container::-webkit-scrollbar-thumb:hover { background: #818cf8; }
    .task-header-new { background-color: #e0f2fe; color: #0c4a6e; }
    .task-header-expand { background-color: #dcfce7; color: #166534; }
    input[type="date"] { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem 0.5rem; font-size: 0.875rem; line-height: 1.25rem; min-width: 130px; }
    input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }
    input[type="date"]:invalid { color: #9ca3af; }
    .kpi-table th, .kpi-table td { text-align: center; padding: 0.75rem 0.5rem; border: 1px solid #e5e7eb; }
    .kpi-table .header-group { background-color: #f3f4f6; font-weight: bold; }
    .kpi-table .header-sub { background-color: #f9fafb; font-size: 0.75rem; }
    .kpi-table .item-col { text-align: left; font-weight: bold; background-color: #f9fafb; }
    .kpi-table .total-row { font-weight: bold; background-color: #f3f4f6; }
    .kpi-table .highlight { background-color: #e0f2fe; }
    .kpi-table .gap-col { color: #dc2626; font-weight: bold; }
    .percentage { color: #6b7280; font-size: 0.75rem; margin-left: 4px; }
    .clickable-stat { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; text-decoration-color: #9ca3af; transition: all 0.2s; }
    .clickable-stat:hover { color: #4f46e5; text-decoration-color: #4f46e5; }
    .health-warning { background-color: #fef9c3; color: #a16207; }
    .health-critical { background-color: #fee2e2; color: #b91c1c; }
    .sortable-header { cursor: pointer; user-select: none; }
    .sortable-header:hover { background-color: #f3f4f6; }
    .sort-asc::after { content: ' â–²'; font-size: 0.6em; }
    .sort-desc::after { content: ' â–¼'; font-size: 0.6em; }
    .row-dirty { background-color: #fef9c3 !important; }
    #toast { position: fixed; top: 20px; right: 20px; transform: translateX(200%); transition: transform 0.5s ease-in-out; z-index: 100; }
    #toast.show { transform: translateX(0); }
    /* Checkbox column width */
    .checkbox-col { width: 3rem; text-align: center; }
    /* Row number column width and style */
    .row-number-col { width: 3.5rem; text-align: center; background-color: #f9fafb; font-weight: 500; color: #6b7280; }
    /* Column letter header style */
    .col-letter-header th { background-color: #f3f4f6; font-weight: bold; text-align: center; }

    /* --- èª¿æ•´ï¼šæ¬„å¯¬èª¿æ•´ --- */
    .col-notion { max-width: 150px; min-width: 120px; } /* Aæ¬„: ç¸®å°å¯¬åº¦ */
    .col-publisher-name { min-width: 12em; white-space: normal !important; word-break: break-word; } /* Bæ¬„: æœ€å°å¯¬åº¦ç´„6å€‹ä¸­æ–‡å­— */
    .col-contract-id { min-width: 130px; } /* Cæ¬„: æœ€å°å¯¬åº¦ */
    .col-staff { min-width: 100px; }       /* Dæ¬„: æœ€å°å¯¬åº¦ */
    .col-tier { min-width: 60px; }        /* Eæ¬„: æœ€å°å¯¬åº¦ */
    .col-mission-tags { min-width: 150px; } /* ä»»å‹™æ¨™ç±¤æ¬„ä½ */
    .col-action { min-width: 120px; } /* æ“ä½œæ¬„ä½ */

    /* ç¢ºä¿ input å’Œ select ä¸è¦æ’é–‹ td */
     #master-list-body td input, #master-list-body td select { max-width: 100%; box-sizing: border-box; }

     /* --- æ–°å¢ï¼šå´é‚Šæ¬„æ”¶åˆæ¨£å¼ --- */
    #sidebar { transition: width 0.3s ease-in-out; width: 16rem; /* é è¨­å¯¬åº¦ w-64 */ }
    #sidebar.collapsed { width: 4rem; /* æ”¶åˆå¯¬åº¦ w-16 */ }
    #sidebar.collapsed .sidebar-text { display: none; }
    #sidebar.collapsed .sidebar-header-text { display: none; }
    #sidebar.collapsed .sidebar-footer > *:not(#logoutBtn):not(#db-status) { display: none; } /* æ”¶åˆæ™‚éš±è— footer æ–‡å­— */
    #sidebar.collapsed #logoutBtn span { display: none; } /* éš±è—ç™»å‡ºæŒ‰éˆ•æ–‡å­— */
     #sidebar.collapsed #logoutBtn { width: auto; padding: 0.5rem; } /* èª¿æ•´ç™»å‡ºæŒ‰éˆ•å¤§å° */
     #sidebar.collapsed #userRoleDisplay { display: none; }
     #sidebar.collapsed #db-status { font-size: 0.7rem; } /* ç¸®å°ç‹€æ…‹æ–‡å­— */
     #sidebar.collapsed #nav-admin svg, /* é¸å–®åœ–ç¤ºç½®ä¸­ */
     #sidebar.collapsed #nav-export svg,
     #sidebar.collapsed #nav-individual-contact svg,
     #sidebar.collapsed #nav-publisher-tier svg,
     #sidebar.collapsed #nav-individual-signing svg,
     #sidebar.collapsed #nav-team-signing svg,
     #sidebar.collapsed #nav-publisher-master svg { margin-right: 0 !important; }
     #sidebar.collapsed nav ul a { justify-content: center; } /* åœ–ç¤ºç½®ä¸­ */

     #mainContent { transition: margin-left 0.3s ease-in-out; margin-left: 16rem; /* é è¨­ margin */ }
     body.sidebar-collapsed #mainContent { margin-left: 4rem; /* æ”¶åˆæ™‚ margin */ }

     /* æ¼¢å ¡æŒ‰éˆ•æ¨£å¼ */
     #sidebar-toggle {
        background: none; border: none; cursor: pointer; padding: 0.5rem;
        position: absolute; top: 1.25rem; right: -2.5rem; /* ç§»åˆ°å´é‚Šæ¬„å¤–å³å´ */
        background-color: white; border-radius: 0 0.375rem 0.375rem 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        z-index: 10;
     }
      #sidebar.collapsed #sidebar-toggle { right: -2.5rem; /* æ”¶åˆæ™‚ä»åœ¨å¤–é¢ */ }
     #sidebar-toggle svg { width: 1.5rem; height: 1.5rem; color: #4b5563; }


  </style>

  <!-- æ•´åˆï¼šé¡¯ç¤º/éš±è— çš„æ¨£å¼ -->
  <style>
    #loginSection { display: flex; }
    #mainSection { display: none; }
  </style>
</head>
<!-- æ–°å¢ class="sidebar-collapsed" é è¨­æ”¶åˆ -->
<body class="bg-gray-100 antialiased sidebar-collapsed">

  <!-- ğŸ” ç™»å…¥ç•«é¢å€å¡Š (ä¾†è‡ª æª”æ¡ˆ 1) -->
  <!-- ä½¿ç”¨ Tailwind å±…ä¸­ï¼Œä½¿ç”¨ AdminLTE æ¨£å¼åŒ–å¡ç‰‡ -->
  <div id="loginSection" class="flex items-center justify-center min-h-screen p-4">
    <div class="card card-primary w-full max-w-md shadow-lg">
      <div class="card-header"><h3 class="card-title">ç™»å…¥ eBook Dashboard</h3></div>
      <div class="card-body">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" class="form-control" id="loginEmail" placeholder="è¼¸å…¥ Email">
        </div>
        <div class="form-group">
          <label for="loginPassword">å¯†ç¢¼</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼">
        </div>
        <button class="btn btn-primary mt-3 w-100" id="loginBtn">ç™»å…¥</button>
        <div id="loginError" class="text-danger text-center mt-2"></div>
      </div>
    </div>
  </div>

  <!-- ğŸ§­ ä¸»ç³»çµ±å€å¡Š (ä¾†è‡ª æª”æ¡ˆ 2) -->
  <div id="mainSection" class="flex h-screen">

    <!-- å·¦å´å°è¦½é¸å–® (ä¾†è‡ª æª”æ¡ˆ 2ï¼Œæ•´åˆäº† æª”æ¡ˆ 1 çš„ç™»å‡ºæŒ‰éˆ•) -->
    <!-- æ–°å¢ id="sidebar" -->
    <aside id="sidebar" class="bg-white shadow-md flex flex-col shrink-0 relative">
        <!-- æ–°å¢æ¼¢å ¡æŒ‰éˆ• -->
        <button id="sidebar-toggle" title="æ”¶åˆ/å±•é–‹é¸å–®">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
        <div class="p-6 border-b flex items-center gap-2">
             <!-- <h1 class="text-xl font-bold text-gray-800 sidebar-text">åœ–æœéƒ¨å„€è¡¨æ¿</h1> -->
             <span class="text-xl font-bold text-gray-800">ğŸ“Š</span> <!-- Iconæ›¿ä»£æ–‡å­— -->
             <div class="sidebar-header-text">
                 <h1 class="text-xl font-bold text-gray-800">åœ–æœéƒ¨å„€è¡¨æ¿</h1>
                 <p class="text-sm text-gray-500 mt-1">ä¸­æ–‡é›»å­æ›¸å¾µé›†é€²åº¦</p>
             </div>
        </div>
        <nav class="flex-1 px-4 py-6 overflow-y-auto">
            <ul class="space-y-2">
                <!-- æª”æ¡ˆ 2 çš„å°è¦½é€£çµï¼ŒåŠ å…¥ sidebar-text class -->
                <li><a href="#" id="nav-publisher-master" class="flex items-center px-4 py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-lg shadow-sm"><svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg><span class="sidebar-text">å‡ºç‰ˆç¤¾æ¯é«”ç®¡ç†</span></a></li>
                <li><a href="#" id="nav-team-signing" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="sidebar-text">åœ˜éšŠç°½ç´„é€²åº¦</span></a></li>
                <li><a href="#" id="nav-individual-signing" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 11h-4.17a6.12 6.12 0 0 1-5.6-3.07"/></svg><span class="sidebar-text">å€‹äººç°½ç´„é€²åº¦</span></a></li>
                <li><a href="#" id="nav-publisher-tier" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 10v12"/><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><path d="M12 2v4"/><path d="m15 13-3-3-3 3"/></svg><span class="sidebar-text">å‡ºç‰ˆç¤¾åˆ†ç´šè¯ç¹«é€²åº¦</span></a></li>
                <li><a href="#" id="nav-individual-contact" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 18a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"/><rect width="18" height="18" x="3" y="4" rx="2"/><circle cx="12" cy="10" r="2"/><line x1="8" y1="2" x2="8" y2="4"/><line x1="16" y1="2" x2="16" y2="4"/></svg><span class="sidebar-text">å€‹äººè¯ç¹«é€²åº¦</span></a></li>

                <li class="admin-only" style="display: none;">
                  <a href="#" id="nav-admin" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 11V16"/><path d="M12 8H12.01"/><path d="M21.17 16.83A9.95 9.95 0 0 0 22 12c0-5.52-4.48-10-10-10S2 6.48 2 12a9.95 9.95 0 0 0 .83 4.17L2 22l5.17-1.17Z"/></svg>
                    <span class="sidebar-text">ç®¡ç†å“¡å°ˆå€</span>
                  </a>
                </li>

                <li class="border-t pt-2 mt-2"><a href="#" id="nav-export" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 mr-3 shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span class="sidebar-text">åŒ¯å‡ºå ±è¡¨</span></a></li>
            </ul>
        </nav>

        <!-- ä¾†è‡ª æª”æ¡ˆ 1 çš„ç™»å…¥è³‡è¨Š/ç™»å‡ºæŒ‰éˆ• -->
        <div class="p-4 border-t mt-auto sidebar-footer">
            <div id="userRoleDisplay" class="text-sm font-medium text-gray-700 mb-2 truncate">
              æœªç™»å…¥
            </div>
             <!-- ä¿®æ”¹ç™»å‡ºæŒ‰éˆ•æ¨£å¼ -->
            <button id="logoutBtn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition-all duration-200 text-sm flex items-center justify-center gap-2">
              <svg class="w-4 h-4 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" > <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /> </svg>
              <span class="sidebar-text">ç™»å‡º</span>
            </button>

            <!-- ä¾†è‡ª æª”æ¡ˆ 2 çš„é å°¾è³‡è¨Š -->
            <p class="text-xs text-gray-500 mt-4 sidebar-text">ç‰ˆæœ¬ v4.6.0 (Optimized)</p>
            <p class="text-xs text-gray-500 sidebar-text">è³‡æ–™åº«ç‹€æ…‹: <span id="db-status" class="font-semibold text-gray-400">æœªé€£æ¥</span></p>
        </div>
    </aside>

    <!-- å³å´ä¸»å…§å®¹å€ (ä¾†è‡ª æª”æ¡ˆ 2) -->
    <!-- æ–°å¢ id="mainContent" -->
    <main id="mainContent" class="flex-1 p-6 lg:p-8 overflow-y-auto">
        <header class="mb-8">
            <h2 id="main-title" class="text-3xl font-bold text-gray-900">å‡ºç‰ˆç¤¾æ¯é«”ç®¡ç†</h2>
        </header>

        <div class="relative">
            <!-- æ¨¡çµ„ä¸€ï¼šå‡ºç‰ˆç¤¾æ¯é«”ç®¡ç† -->
            <section id="content-publisher-master" class="content-section">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold text-gray-800">ç›®æ¨™å‡ºç‰ˆç¤¾æ¸…å–®</h3>
                        <div class="flex flex-wrap items-center gap-2">
                            <!-- æ–°å¢ï¼šåˆªé™¤é¸å–é …ç›®æŒ‰éˆ• (Admin Only) -->
                             <button id="delete-selected-btn" class="admin-only bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition-all duration-200 inline-flex items-center text-sm" style="display: none;">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                åˆªé™¤é¸å–
                            </button>
                            <button id="add-publisher-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 inline-flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                æ–°å¢å‡ºç‰ˆç¤¾
                            </button>
                            <button id="download-template-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-700 transition-all duration-200 inline-flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                ä¸‹è¼‰ç¯„æœ¬
                            </button>
                            <button id="import-data-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 transition-all duration-200 inline-flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                åŒ¯å…¥è³‡æ–™
                            </button>
                            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <!-- æœå°‹èˆ‡ç¯©é¸ -->
                    <div class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b">
                        <input type="text" id="search-input" placeholder="æœå°‹å‡ºç‰ˆç¤¾ã€åˆç´„ç·¨è™Ÿ..." class="w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <select id="staff-filter" class="w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                        <select id="tier-filter" class="w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                        <select id="status-filter" class="w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                        <button id="clear-filters-btn" class="text-sm text-gray-600 hover:text-indigo-600">æ¸…é™¤ç¯©é¸</button>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-semibold text-gray-500 ">&lt;è¡¨ä¸€&gt;</h4>
                        <!-- æ–°å¢ï¼šé¡¯ç¤ºç­†æ•¸è³‡è¨Š -->
                        <p id="publisher-count-info" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="overflow-x-auto max-h-[65vh] table-container">
                        <table class="w-full text-sm text-left text-gray-600 border-collapse">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase sticky top-0 z-10 shadow-sm">
                                <!-- æ–°å¢ï¼šæ¬„ä½å­—æ¯æ¨™é ­ -->
                                <tr id="col-letter-header" class="col-letter-header">
                                    <!-- Placeholder cell(s) for checkbox and row number -->
                                </tr>
                                <tr>
                                    <!-- æ–°å¢ï¼šå…¨é¸ Checkbox -->
                                    <th class="px-3 py-3 border-b border-gray-200 checkbox-col admin-only" style="display: none;">
                                      <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </th>
                                    <!-- æ–°å¢ï¼šåˆ—ä½æ•¸å­—æ¨™é ­ -->
                                     <th class="px-3 py-3 border-b border-gray-200 row-number-col">#</th>
                                    <!-- æ–°å¢ CSS class -->
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 col-notion">Notion ç´€éŒ„</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-publisher-name" data-sort="name">å‡ºç‰ˆç¤¾åç¨±</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-contract-id" data-sort="contractId">åˆç´„ç·¨è™Ÿ</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-staff" data-sort="staff">è² è²¬åŒä»</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-tier" data-sort="tier">åˆ†ç´š</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header" data-sort="contactStatus">è¯ç¹«ç‹€æ…‹</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 sortable-header col-mission-tags" data-sort="missionTags">ä»»å‹™æ¨™ç±¤</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-new" data-task-header="task_new_ebook">å–å¾—:é›»å­æ›¸åˆä½œ</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2c">å–å¾—:B2CéŠ·å”®æ¬Šåˆ©</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_gvm">å–å¾—:[ç°ç†Š]</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_trms">å–å¾—:é›»å­æ•™ç§‘æ›¸TRMS</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_kingstone">å–å¾—:[æ›¸ç´]é‡‘çŸ³å ‚</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_sanmin">å–å¾—:[æ›¸ç´]ä¸‰æ°‘</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2c_3rd">å–å¾—:B2Cç¶“éŠ·ç¬¬ä¸‰æ–¹</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b">å–å¾—:B2BéŠ·å”®æ¬Šåˆ©</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b_union">å–å¾—:B2B_è¯ç›Ÿ</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b_public">å–å¾—:B2B_å…¬åœ–</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 task-header-expand" data-task-header="task_get_b2b_cn">å–å¾—:B2B_CN</th>
                                    <th class="px-3 py-3 whitespace-nowrap border-b border-gray-200 col-action">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="master-list-body">
                                <!-- èª¿æ•´ colspan -->
                                <tr class="bg-white border-b"><td colspan="21" class="text-center py-10 text-gray-500">æ­£åœ¨ç­‰å¾…ç™»å…¥...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ... å…¶ä»–æ¨¡çµ„ section ... -->
             <!-- æ¨¡çµ„äºŒï¼šåœ˜éšŠç°½ç´„é€²åº¦ -->
            <section id="content-team-signing" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">2025å¹´8~12æœˆï¼¿å¾µé›†åœ˜é«”ç›®æ¨™(ä¸­æ–‡é›»å­æ›¸)</h3>
                    <p class="text-xs text-gray-500 mb-4">å‚™è¨»ï¼šæœ¬è¡¨ä¸­çš„æ•¸é‡ç‚ºå‡ºç‰ˆç¤¾å“ç‰Œå®¶æ•¸ã€‚çµ±è¨ˆæ™‚åŒä¸€å‡ºç‰ˆç¤¾ï¼Œæ–¼æ­¤è¡¨åªæœƒè¢«è¨ˆç®—è‡³ä¸€å€‹é …ç›®ï¼Œä¸é‡è¤‡è¨ˆç®—ã€‚</p>
                    <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;è¡¨äºŒ&gt;</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse kpi-table">
                            <thead>
                                <tr class="header-group">
                                    <th rowspan="2" class="item-col">é …ç›®</th>
                                    <th colspan="6">ç›®æ¨™</th>
                                    <th colspan="13">é€²åº¦</th>
                                </tr>
                                <tr class="header-sub">
                                    <th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th><th class="highlight">å®¶æ•¸åˆè¨ˆ</th>
                                    <th>8æœˆ</th><th>8æœˆé”æˆç‡</th>
                                    <th>9æœˆ</th><th>9æœˆé”æˆç‡</th>
                                    <th>10æœˆ</th><th>10æœˆé”æˆç‡</th>
                                    <th>11æœˆ</th><th>11æœˆé”æˆç‡</th>
                                    <th>12æœˆ</th><th>12æœˆé”æˆç‡</th>
                                    <th class="highlight">å®¶æ•¸åˆè¨ˆ</th><th class="highlight">å„é …ç›®é”æˆç‡</th><th class="gap-col">ç¼ºå£å®¶æ•¸</th>
                                </tr>
                            </thead>
                            <tbody id="kpi-table-body"></tbody>
                            <tfoot id="kpi-table-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </section>

            <!-- æ¨¡çµ„ä¸‰ï¼šå€‹äººç°½ç´„é€²åº¦ -->
            <section id="content-individual-signing" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">å€‹äººç°½ç´„ç‡ç¸½è¦½</h3>
                    <h4 class="text-sm font-semibold text-gray-500 mb-4">&lt;è¡¨ä¸‰&gt;</h4>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th scope="col" class="px-6 py-3">è² è²¬äºº</th>
                                    <th scope="col" class="px-6 py-3">è² è²¬å–®ä½æ•¸</th>
                                    <th scope="col" class="px-6 py-3">å·²ç°½ç´„</th>
                                    <th scope="col" class="px-6 py-3">ç°½ç´„ç‡</th>
                                </tr>
                            </thead>
                            <tbody id="individual-signing-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- æ¨¡çµ„å››ï¼šå‡ºç‰ˆç¤¾åˆ†ç´šè¯ç¹«é€²åº¦ -->
            <section id="content-publisher-tier" class="content-section hidden">
                <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;è¡¨å››&gt;</h4>
                <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <label for="progress-filter" class="text-sm font-medium text-gray-700">ç¯©é¸æª¢è¦–:</label>
                        <select id="progress-filter" class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                    </div>
                    <div class="text-xs text-gray-600 flex items-center gap-4">
                        <span class="font-bold">åˆ†ç´šå®šç¾©:</span>
                        <span><span class="font-semibold text-red-600">Aç´š:</span> æœ€é‡è¦</span>
                        <span><span class="font-semibold text-yellow-600">Bç´š:</span> æ¬¡ä¹‹</span>
                        <span><span class="font-semibold text-blue-600">Cç´š:</span> ä¸€èˆ¬</span>
                    </div>
                </div>
                <div id="progress-cards-container" class="grid grid-cols-1 xl:grid-cols-2 gap-8"></div>
            </section>

            <!-- æ¨¡çµ„äº”ï¼šå€‹äººè¯ç¹«é€²åº¦ -->
            <section id="content-individual-contact" class="content-section hidden">
                <h4 class="text-sm font-semibold text-gray-500 mb-2">&lt;è¡¨äº”&gt;</h4>
                <div id="individual-contact-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- æ¨¡çµ„å…­ï¼šåŒ¯å‡ºå ±è¡¨ -->
            <section id="content-export" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">é¸æ“‡è¦åŒ¯å‡ºçš„å ±è¡¨</h3>
                    <div class="space-y-4" id="export-options-container">
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table1" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;è¡¨ä¸€&gt; å‡ºç‰ˆç¤¾æ¯é«”ç®¡ç†</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table2" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;è¡¨äºŒ&gt; åœ˜éšŠç°½ç´„é€²åº¦</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table3" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;è¡¨ä¸‰&gt; å€‹äººç°½ç´„é€²åº¦</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table4" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;è¡¨å››&gt; å‡ºç‰ˆç¤¾åˆ†ç´šè¯ç¹«é€²åº¦</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="export-option" value="table5" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">&lt;è¡¨äº”&gt; å€‹äººè¯ç¹«é€²åº¦</span>
                        </label>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="export-selected-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 transition-all duration-200 inline-flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            åŒ¯å‡ºæ‰€é¸å ±è¡¨
                        </button>
                    </div>
                </div>
            </section>

            <!-- ç®¡ç†å“¡å°ˆå€ï¼šä½¿ç”¨è€…ç®¡ç† (ç§»é™¤è§’è‰²è®Šæ›´åŠŸèƒ½) -->
            <section id="content-admin" class="content-section hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ä½¿ç”¨è€…å¸³è™Ÿç®¡ç†</h3>

                    <div class="overflow-x-auto rounded-lg border">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th scope="col" class="px-6 py-3">ä½¿ç”¨è€… Email</th>
                                    <th scope="col" class="px-6 py-3">ç›®å‰è§’è‰²</th>
                                    <!-- ç§»é™¤ "è®Šæ›´è§’è‰²" å’Œ "æ“ä½œ" æ¬„ä½ -->
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                                <!-- User list will be populated here -->
                                <!-- èª¿æ•´ colspan -->
                                <tr><td colspan="2" class="text-center py-10 text-gray-500">æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- æ›´æ–°æç¤ºæ–‡å­— -->
                     <p class="text-xs text-gray-500 mt-4">*æ³¨æ„ï¼šæ–°å¢ä½¿ç”¨è€…å¸³è™Ÿæˆ–è®Šæ›´æ¬Šé™ï¼Œè«‹æ´½æ—èŠ(è‡³ Firebase Authentication ä¸»æ§å°æ“ä½œã€‚)</p>
                </div>
            </section>

        </div>
    </main>
  </div><!-- /#mainSection -->

  <!-- Modals (ä¾†è‡ª æª”æ¡ˆ 2) -->
  <div id="add-publisher-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 border-b flex justify-between items-center">
              <h3 class="text-xl font-bold text-gray-800">æ–°å¢/ç·¨è¼¯å‡ºç‰ˆç¤¾</h3>
              <button id="close-add-modal-btn" class="text-gray-400 hover:text-gray-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
          </div>
          <form id="add-publisher-form" class="p-6 space-y-4">
              <input type="hidden" id="edit-publisher-id">
              <div>
                  <label for="new-publisher-name" class="block text-sm font-medium text-gray-700">å‡ºç‰ˆç¤¾åç¨±</label>
                  <input type="text" id="new-publisher-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                  <label for="new-publisher-notion-url" class="block text-sm font-medium text-gray-700">Notion ç´€éŒ„é€£çµ</label>
                  <input type="url" id="new-publisher-notion-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="è²¼ä¸Š Notion é é¢é€£çµ">
              </div>
              <div>
                  <label for="new-publisher-contract-id" class="block text-sm font-medium text-gray-700">åˆç´„ç·¨è™Ÿ</label>
                  <input type="text" id="new-publisher-contract-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ä¾‹å¦‚: EBK00001 (è‹¥ç„¡å‰‡ç•™ç©º)">
              </div>
              <div>
                  <label for="new-publisher-mission-tags" class="block text-sm font-medium text-gray-700">ä»»å‹™æ¨™ç±¤</label>
                  <input type="text" id="new-publisher-mission-tags" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="å¤šå€‹æ¨™ç±¤è«‹ç”¨ , éš”é–‹">
              </div>
              <div>
                  <label for="new-publisher-staff" class="block text-sm font-medium text-gray-700">è² è²¬åŒä»</label>
                  <select id="new-publisher-staff" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
              </div>
              <div>
                  <label for="new-publisher-tier" class="block text-sm font-medium text-gray-700">åˆ†ç´š</label>
                  <select id="new-publisher-tier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
              </div>
              <div>
                  <label for="new-publisher-status" class="block text-sm font-medium text-gray-700">è¯ç¹«ç‹€æ…‹</label>
                  <select id="new-publisher-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
              </div>
          </form>
          <div class="p-4 bg-gray-50 rounded-b-xl text-right space-x-2">
              <button id="cancel-add-btn" type="button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">å–æ¶ˆ</button>
              <button id="save-add-btn" type="submit" form="add-publisher-form" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">å„²å­˜</button>
          </div>
      </div>
  </div>
  <div id="publisher-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div id="publisher-list-modal-content" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 border-b flex justify-between items-center">
              <h3 class="text-lg font-bold text-gray-800" id="publisher-list-title">å‡ºç‰ˆç¤¾æ¸…å–®</h3>
              <button id="close-publisher-list-btn" class="text-gray-400 hover:text-gray-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
          </div>
          <div class="p-6 max-h-[60vh] overflow-y-auto"><ul id="publisher-list-body" class="space-y-2 text-sm text-gray-700 list-disc list-inside"></ul></div>
      </div>
  </div>
  <!-- Alert Modal -->
  <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 text-center">
              <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
              <h3 class="mt-4 text-lg font-medium text-gray-900">æ“ä½œæé†’</h3>
              <p id="alert-modal-text" class="mt-2 text-sm text-gray-600"></p>
          </div>
          <div class="p-4 bg-gray-50 rounded-b-xl text-center">
              <button id="close-alert-modal-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">æˆ‘çŸ¥é“äº†</button>
          </div>
      </div>
  </div>

  <!-- æ–°å¢ï¼šConfirm Modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
      <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0">
          <div class="p-6 text-center">
              <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
              <h3 class="mt-4 text-lg font-medium text-gray-900">ç¢ºèªæ“ä½œ</h3>
              <p id="confirm-modal-text" class="mt-2 text-sm text-gray-600"></p>
          </div>
          <div class="p-4 bg-gray-50 rounded-b-xl text-center space-x-2">
              <button id="cancel-confirm-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">å–æ¶ˆ</button>
              <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">ç¢ºèªåˆªé™¤</button>
          </div>
      </div>
  </div>

  <!-- Toast Notification (ä¾†è‡ª æª”æ¡ˆ 2) -->
  <div id="toast" class="">
      <div id="toast-content" class="flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-lg" role="alert">
      </div>
  </div>

  <!-- Firebase Config (ä¾†è‡ª æª”æ¡ˆ 2ï¼Œä¾› æª”æ¡ˆ 1 çš„ config ä½¿ç”¨) -->
  <script>
    // æª”æ¡ˆ 1 çš„ configï¼Œç¾åœ¨ç”± æª”æ¡ˆ 2 çš„ config è®Šæ•¸æä¾›
    const __app_id = "ebook-dashboard";
    const __firebase_config = JSON.stringify({
      apiKey: "AIzaSyA735uIwaSCjz09KwI0SNXgvmTwmk5kzXA",
      authDomain: "ebook-dashboard-a0148.firebaseapp.com",
      projectId: "ebook-dashboard-a0148",
      storageBucket: "ebook-dashboard-a0148.firebasestorage.app",
      messagingSenderId: "127405787765",
      appId: "1:127405787765:web:72631dc3d362466660c63c"
    });
  </script>

  <!-- æ•´åˆå¾Œçš„ Script (V11 Modular SDK) -->
  <script type="module">
      // --- Firebase SDK Imports (æ•´åˆ) ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      // *** æ–°å¢ getDocs, deleteDoc ***
      import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, writeBatch, setDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      document.addEventListener('DOMContentLoaded', async function () {
          // --- è¨­å®šèˆ‡å¸¸æ•¸ (ä¾†è‡ª æª”æ¡ˆ 2) ---
          const staffList = ["é™³ç«å›", "é™³ä¿åŸ", "æèŠ·ç‘„", "æè™¹å„€", "æœªåˆ†é…"];
          const tierList = ["A", "B", "C", "X"];
          const contactStatusList = ["æœªè¯ç¹«", "è¯ç¹«ä¸­", "å·²è¯ç¹«ï¼Œç„¡æ„é¡˜æ´½è«‡", "å·²è¯ç¹«ï¼Œæœ‰æ„é¡˜æ´½è«‡", "å¯©ç´„ä¸­", "ç”¨å°ä¸­", "å·²ç°½å›ï¼Œå·²ç§»äº¤åˆç´„"];
          const taskColumns = [ 'task_new_ebook', 'task_get_b2c', 'task_get_gvm', 'task_get_trms', 'task_get_kingstone', 'task_get_sanmin', 'task_get_b2c_3rd', 'task_get_b2b', 'task_get_b2b_union', 'task_get_b2b_public', 'task_get_b2b_cn' ];
          const kpiTargets = {
              'B2C':    { months: [4, 6, 6, 5, 3], taskKey: 'task_get_b2c' },
              'B2B':    { months: [2, 3, 3, 2, 2], taskKey: 'task_get_b2b' },
              'æœªåˆä½œ': { months: [2, 3, 3, 3, 3], taskKey: 'task_new_ebook' },
              'TRMS':   { months: [2, 2, 2, 2, 0], taskKey: 'task_get_trms' }
          };
          // *** ä¿®æ­£ï¼šåŠ å…¥ admin ***
          const pageTitles = {
              publisherMaster: 'å‡ºç‰ˆç¤¾æ¯é«”ç®¡ç†',
              teamSigning: 'åœ˜éšŠç°½ç´„é€²åº¦',
              individualSigning: 'å€‹äººç°½ç´„é€²åº¦',
              publisherTier: 'å‡ºç‰ˆç¤¾åˆ†ç´šè¯ç¹«é€²åº¦',
              individualContact: 'å€‹äººè¯ç¹«é€²åº¦',
              export: 'åŒ¯å‡ºå ±è¡¨',
              admin: 'ç®¡ç†å“¡å°ˆå€'
          };
          // *** ä¿®æ”¹ï¼šåªä¿ç•™ä¸€ç­†ç¯„ä¾‹è³‡æ–™ ***
          const initialData = [
              { name: "ç¯„ä¾‹å‡ºç‰ˆç¤¾", staff: "æœªåˆ†é…", tier: "X", contactStatus: "æœªè¯ç¹«", missionTags: ["ç¯„ä¾‹æ¨™ç±¤"], contractId: null, tasks: {}, notionUrl: null }
          ];

          // --- å…¨åŸŸç‹€æ…‹ç®¡ç† (ä¾†è‡ª æª”æ¡ˆ 2) ---
          const state = {
              publishers: [],
              analytics: {},
              filters: { search: '', staff: 'all', tier: 'all', status: 'all' },
              sort: { by: 'name', order: 'asc' },
              db: null, // å°‡åœ¨åˆå§‹åŒ–æ™‚è¨­å®š
              auth: null, // å°‡åœ¨åˆå§‹åŒ–æ™‚è¨­å®š
              appId: null, // å°‡åœ¨åˆå§‹åŒ–æ™‚è¨­å®š
              publishersCollection: null,
              isDashboardInitialized: false, // *** æ——æ¨™ï¼Œé˜²æ­¢é‡è¤‡åˆå§‹åŒ– ***
              selectedPublisherIds: new Set(), // *** æ–°å¢ï¼šè¿½è¹¤é¸å–çš„é …ç›® ***
              currentRole: 'user', // *** æ–°å¢ï¼šè¿½è¹¤ç›®å‰ä½¿ç”¨è€…è§’è‰² ***
              isSidebarCollapsed: true, // *** æ–°å¢ï¼šå´é‚Šæ¬„ç‹€æ…‹ ***
          };

          // --- DOM å…ƒç´ å¿«å– (æ•´åˆ) ---
          // (æª”æ¡ˆ 2 çš„ dom ç‰©ä»¶)
          const dom = {
              // *** ä¿®æ­£ï¼šç¢ºä¿ replace å‘¼å«æ­£ç¢º ***
              navLinks: Object.fromEntries(Object.keys(pageTitles).map(id => [id, document.getElementById(`nav-${id.replace('publisherMaster', 'publisher-master').replace('teamSigning','team-signing').replace('individualSigning','individual-signing').replace('publisherTier','publisher-tier').replace('individualContact','individual-contact')}`)])),
              contentSections: Object.fromEntries(Object.keys(pageTitles).map(id => [id, document.getElementById(`content-${id.replace('publisherMaster', 'publisher-master').replace('teamSigning','team-signing').replace('individualSigning','individual-signing').replace('publisherTier','publisher-tier').replace('individualContact','individual-contact')}`)])),
              mainTitle: document.getElementById('main-title'),
              dbStatus: document.getElementById('db-status'),
              masterListBody: document.getElementById('master-list-body'),
              searchInput: document.getElementById('search-input'),
              staffFilter: document.getElementById('staff-filter'),
              tierFilter: document.getElementById('tier-filter'),
              statusFilter: document.getElementById('status-filter'),
              addPublisherModal: document.getElementById('add-publisher-modal'),
              addPublisherModalContent: document.getElementById('add-publisher-modal').querySelector('.modal-content'),
              addPublisherForm: document.getElementById('add-publisher-form'),
              publisherListModal: document.getElementById('publisher-list-modal'),
              publisherListModalContent: document.getElementById('publisher-list-modal').querySelector('.modal-content'),
              alertModal: document.getElementById('alert-modal'),
              alertModalContent: document.getElementById('alert-modal').querySelector('.modal-content'),
              alertModalText: document.getElementById('alert-modal-text'),
              // *** æ–°å¢ï¼šConfirm Modal å…ƒç´  ***
              confirmModal: document.getElementById('confirm-modal'),
              confirmModalContent: document.getElementById('confirm-modal').querySelector('.modal-content'),
              confirmModalText: document.getElementById('confirm-modal-text'),
              confirmActionBtn: document.getElementById('confirm-action-btn'),
              cancelConfirmBtn: document.getElementById('cancel-confirm-btn'),
              // *** æ–°å¢ï¼šåˆªé™¤ç›¸é—œæŒ‰éˆ• ***
              selectAllCheckbox: document.getElementById('select-all-checkbox'),
              deleteSelectedBtn: document.getElementById('delete-selected-btn'),
              colLetterHeader: document.getElementById('col-letter-header'), // *** æ–°å¢ï¼šæ¬„ä½å­—æ¯æ¨™é ­åˆ— ***
              sidebar: document.getElementById('sidebar'), // *** æ–°å¢ï¼šå´é‚Šæ¬„å…ƒç´  ***
              sidebarToggle: document.getElementById('sidebar-toggle'), // *** æ–°å¢ï¼šå´é‚Šæ¬„é–‹é—œæŒ‰éˆ• ***
              mainContent: document.getElementById('mainContent'), // *** æ–°å¢ï¼šä¸»å…§å®¹å€å¡Š ***
              publisherCountInfo: document.getElementById('publisher-count-info'), // *** æ–°å¢ï¼šç­†æ•¸è³‡è¨Šå…ƒç´  ***
          };
          // (æª”æ¡ˆ 1 çš„ dom å…ƒç´ )
          const loginSection = document.getElementById('loginSection');
          const mainSection = document.getElementById('mainSection');
          const loginBtn = document.getElementById('loginBtn');
          const logoutBtn = document.getElementById('logoutBtn');
          const loginEmail = document.getElementById('loginEmail');
          const loginPassword = document.getElementById('loginPassword');
          const loginError = document.getElementById('loginError');
          const userRoleDisplay = document.getElementById('userRoleDisplay');
          // *** æ–°å¢ï¼šç®¡ç†å“¡å€å¡Šçš„ tbody ***
          const userListBody = document.getElementById('user-list-body');


          // --- Firebase æ ¸å¿ƒåŠŸèƒ½ (æ•´åˆ) ---
          try {
              state.appId = typeof __app_id !== 'undefined' ? __app_id : 'ebook-dashboard';
              const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
              if (!firebaseConfig.apiKey) throw new Error("Firebase config is missing.");

              const app = initializeApp(firebaseConfig);
              state.db = getFirestore(app);
              state.auth = getAuth(app);
              // *** éŒ¯èª¤ä¿®æ­£ï¼šåœ¨é€™è£¡è¨­å®š dom.dbStatus.textContent ***
              if(dom.dbStatus) dom.dbStatus.textContent = 'åˆå§‹åŒ–...';

          } catch (error) {
              console.error("Firebase initialization failed:", error);
              // *** éŒ¯èª¤ä¿®æ­£ï¼šé˜²å‘†ï¼Œæª¢æŸ¥ dom.dbStatus å’Œ loginError æ˜¯å¦å­˜åœ¨ ***
              if(dom.dbStatus) {
                dom.dbStatus.textContent = 'é€£æ¥å¤±æ•—';
                dom.dbStatus.className = 'font-semibold text-red-600';
              }
              if(loginError) {
                loginError.textContent = 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚';
              }
              return; // åœæ­¢åŸ·è¡Œ
          }

          // --- ç™»å…¥/ç™»å‡º/æ¬Šé™é‚è¼¯ (ä¾†è‡ª æª”æ¡ˆ 1ï¼Œå·²æ”¹ç‚º V11 èªæ³•) ---
          onAuthStateChanged(state.auth, async (user) => {
              if (user) {
                  // ä½¿ç”¨è€…å·²ç™»å…¥ Authï¼Œæª¢æŸ¥ Firestore æ¬Šé™
                  const uid = user.uid;
                  const email = user.email;

                  // é€™æ˜¯ æª”æ¡ˆ 1 çš„æ¬Šé™è·¯å¾‘
                  const userDocRef = doc(state.db, "artifacts", "ebook-dashboard", "users", uid);
                  const userDoc = await getDoc(userDocRef);

                  if (userDoc.exists()) {
                      // --- ç™»å…¥ä¸”æˆæ¬ŠæˆåŠŸ ---
                      state.currentRole = userDoc.data().role; // *** å„²å­˜è§’è‰² ***
                      console.log(`%c[åµéŒ¯ 1/5] ç™»å…¥æˆåŠŸï¼Œæ¬Šé™å·²ç¢ºèª (Role: ${state.currentRole})`, "color: blue; font-weight: bold;");


                      // 1. åˆ‡æ› UI
                      loginSection.style.display = 'none';
                      mainSection.style.display = 'flex'; // å„€è¡¨æ¿ä½¿ç”¨ flex

                      // 2. è¨­å®šä½¿ç”¨è€…è³‡è¨Š
                      userRoleDisplay.textContent = `${email}ï¼ˆ${state.currentRole}ï¼‰`;

                      // 3. è™•ç†ç®¡ç†å“¡æ¬Šé™ç›¸é—œ UI å…ƒç´ 
                      const adminOnlyElements = document.querySelectorAll('.admin-only');
                      const displayStyle = state.currentRole === "admin" ? 'list-item' : 'none'; // é€£çµç”¨ list-item
                      const displayStyleBlock = state.currentRole === "admin" ? 'inline-flex' : 'none'; // æŒ‰éˆ•ç”¨ inline-flex or block
                      const displayStyleTable = state.currentRole === "admin" ? 'table-cell' : 'none'; // è¡¨æ ¼æ¬„ä½ç”¨ table-cell

                      document.querySelectorAll('.admin-only').forEach(el => {
                           if (el.tagName === 'LI') {
                              el.style.display = displayStyle;
                           } else if (el.tagName === 'BUTTON'){
                              el.style.display = displayStyleBlock;
                           } else if (el.tagName === 'TH' || el.tagName === 'TD') {
                              el.style.display = displayStyleTable;
                           } else {
                               el.style.display = displayStyleBlock; // Default
                           }
                      });

                      // *** æ–°å¢ï¼šæ›´æ–°å­—æ¯æ¨™é ­çš„ Colspan ***
                      updateColLetterHeaderColspan();

                      // *** é˜²æ­¢é‡è¤‡åˆå§‹åŒ– ***
                      if (state.isDashboardInitialized) {
                          console.log("[åµéŒ¯] å„€è¡¨æ¿å·²åˆå§‹åŒ–ï¼Œè·³éé‡è¤‡è¨­å®šã€‚");
                          // é‡æ–°æ•´ç†æ™‚ä¹Ÿè¦ç¢ºä¿ admin UI æ­£ç¢ºé¡¯ç¤º
                          document.querySelectorAll('.admin-only').forEach(el => {
                               if (el.tagName === 'LI') { el.style.display = displayStyle;}
                               else if (el.tagName === 'BUTTON'){ el.style.display = displayStyleBlock; }
                               else if (el.tagName === 'TH' || el.tagName === 'TD') { el.style.display = displayStyleTable; }
                               else { el.style.display = displayStyleBlock; }
                          });
                          updateColLetterHeaderColspan(); // é‡æ–°æ•´ç†ä¹Ÿè¦æ›´æ–° Colspan
                          // *** é‡æ–°æ•´ç†æ™‚å¥—ç”¨å´é‚Šæ¬„ç‹€æ…‹ ***
                          applySidebarState();
                          renderAll(); // é‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿ checkbox é¡¯ç¤º
                          return;
                      }

                      // 4. *** è§¸ç™¼å„€è¡¨æ¿è³‡æ–™è¼‰å…¥ (æª”æ¡ˆ 2 çš„æ ¸å¿ƒ) ***
                      console.log("[åµéŒ¯ 2/5] æ­£åœ¨åˆå§‹åŒ–å„€è¡¨æ¿...");
                      dom.dbStatus.textContent = 'å·²é€£æ¥';
                      dom.dbStatus.className = 'font-semibold text-green-600';

                      // é€™æ˜¯ æª”æ¡ˆ 2 çš„è³‡æ–™åº«è·¯å¾‘
                      state.publishersCollection = collection(state.db, `/artifacts/${state.appId}/public/data/publishers`);
                      renderColLetterHeader(); // *** æ–°å¢ï¼šæ¸²æŸ“å­—æ¯æ¨™é ­ ***
                      listenToPublishers(); // <-- åœ¨æ­¤å•Ÿå‹•å„€è¡¨æ¿

                      // 5. åˆå§‹åŒ–å„€è¡¨æ¿çš„äº‹ä»¶ç›£è½å™¨ (åªæ‡‰åŸ·è¡Œä¸€æ¬¡)
                      console.log("[åµéŒ¯ 3/5] æ­£åœ¨è¨­å®šå„€è¡¨æ¿äº‹ä»¶ç›£è½å™¨...");
                      setupEventListeners();
                      setupFilters();
                      switchContent('publisherMaster'); // é è¨­é¡¯ç¤ºä¸»é 

                      // *** å¦‚æœæ˜¯ adminï¼Œç«‹å³è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨ ***
                      if (state.currentRole === 'admin') {
                          fetchUsers();
                      }

                      // *** æ–°å¢ï¼šåˆå§‹åŒ–å´é‚Šæ¬„ç‹€æ…‹ ***
                      applySidebarState();

                      state.isDashboardInitialized = true; // *** æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ– ***

                  } else {
                      // å·²ç™»å…¥ Authï¼Œä½†åœ¨ Firestore ä¸­ç„¡æ¬Šé™
                      await signOut(state.auth);
                      loginError.textContent = "æ‚¨çš„å¸³è™Ÿå°šæœªæˆæ¬Šä½¿ç”¨æ­¤ç³»çµ±";
                      loginSection.style.display = 'flex'; // é¡¯ç¤ºç™»å…¥
                      mainSection.style.display = 'none'; // éš±è—å„€è¡¨æ¿
                      dom.dbStatus.textContent = 'æœªæˆæ¬Š';
                      dom.dbStatus.className = 'font-semibold text-red-600';
                  }
              } else {
                  // ä½¿ç”¨è€…å·²ç™»å‡º
                  loginSection.style.display = 'flex';
                  mainSection.style.display = 'none';
                  dom.dbStatus.textContent = 'æœªé€£æ¥';
                  dom.dbStatus.className = 'font-semibold text-gray-400';
                  state.isDashboardInitialized = false; // é‡è¨­æ——æ¨™
                  state.currentRole = 'user'; // é‡è¨­è§’è‰²
              }
          }); // *** ä¿®æ­£ï¼šè£œä¸Šé€™å€‹ }); ***

          // ç™»å…¥æŒ‰éˆ•äº‹ä»¶ (ä¾†è‡ª æª”æ¡ˆ 1)
          loginBtn.addEventListener("click", async () => {
              const email = loginEmail.value.trim();
              const password = loginPassword.value;
              loginError.textContent = "";
              if (!email || !password) {
                  loginError.textContent = "è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼";
                  return;
              }
              try {
                  loginBtn.disabled = true;
                  loginBtn.textContent = "ç™»å…¥ä¸­...";
                  await signInWithEmailAndPassword(state.auth, email, password);
                  // onAuthStateChanged æœƒè‡ªå‹•è™•ç†å¾ŒçºŒ
              } catch (err) {
                  loginError.textContent = "ç™»å…¥å¤±æ•—ï¼šEmail æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚";
                  console.error("ç™»å…¥éŒ¯èª¤:", err);
              } finally {
                  loginBtn.disabled = false;
                  loginBtn.textContent = "ç™»å…¥";
              }
          });

          // ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ (ä¾†è‡ª æª”æ¡ˆ 1)
          logoutBtn.addEventListener("click", () => {
            signOut(state.auth).then(() => location.reload());
          });


          // --- å„€è¡¨æ¿æ ¸å¿ƒåŠŸèƒ½ (ä¾†è‡ª æª”æ¡ˆ 2) ---

          function listenToPublishers() {
              console.log(`%c[åµéŒ¯ 4/5] æ­£åœ¨é™„åŠ  Snapshot ç›£è½å™¨è‡³: ${state.publishersCollection.path}`, "color: blue;");
              onSnapshot(state.publishersCollection, async (snapshot) => {
                  console.log(`%c[åµéŒ¯ 5/5] Snapshot æˆåŠŸæ¥æ”¶! (ç©ºé›†åˆ: ${snapshot.empty}, æ–‡ä»¶æ•¸: ${snapshot.size})`, "color: green; font-weight: bold;");

                  // *** ä¿®æ”¹ï¼šè¨»è§£æ‰è‡ªå‹•æ¤å…¥è³‡æ–™ ***
                  // if (snapshot.empty && initialData.length > 0) {
                  //     console.log("è³‡æ–™åº«ç‚ºç©ºï¼Œæ­£åœ¨æ¤å…¥ç¯„ä¾‹è³‡æ–™...");
                  //     await seedInitialData();
                  //     return; // Seeding triggers another snapshot
                  // }

                  state.publishers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  state.analytics = calculateAllAnalytics(state.publishers);
                  renderAll(); // è§¸ç™¼æ¸²æŸ“
                  updateDeleteSelectedButtonState(); // æ›´æ–°åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
              }, (error) => {
                  console.error("%c[åµéŒ¯ å¤±æ•—] Firebase Snapshot éŒ¯èª¤:", "color: red; font-weight: bold;", error);
                   // èª¿æ•´ colspan
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="21" class="text-center py-10 text-red-500">è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ Firestore å®‰å…¨è¦å‰‡æˆ–ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚</td></tr>`;
              });
          }

          async function seedInitialData() {
              const batch = writeBatch(state.db); // ä½¿ç”¨ state.db
              initialData.forEach(pubData => {
                  const completeData = { ...pubData, tasks: pubData.tasks || {} };
                  taskColumns.forEach(key => {
                      if (!completeData.tasks.hasOwnProperty(key)) {
                          completeData.tasks[key] = null;
                      }
                  });
                  const newDocRef = doc(state.publishersCollection);
                  batch.set(newDocRef, completeData);
              });
              await batch.commit();
              showToast("å·²è¼‰å…¥åˆå§‹ç¯„ä¾‹è³‡æ–™", "success");
          }

          // --- æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ---
          function renderAll() {
              console.log("%c[åµéŒ¯ 6/6] renderAll() å•Ÿå‹•. æ­£åœ¨æ¸²æŸ“æ‰€æœ‰æ¨¡çµ„...", "color: green;");
              try {
                const filteredAndSorted = getFilteredAndSortedData();
                renderMasterList(filteredAndSorted); // æœƒæ›´æ–°è¡¨æ ¼å…§å®¹
                renderTeamSigningProgress(state.analytics.teamSigningStats);
                renderIndividualSigningProgress(state.analytics.individualSigningStats);
                renderPublisherTierProgress(state.analytics.tierProgressStats);
                renderIndividualContactProgress(state.analytics.individualContactStats);
                // *** æ¸²æŸ“å¾Œæª¢æŸ¥ checkbox ç‹€æ…‹ ***
                updateCheckboxesAfterRender();
                console.log("%c[åµéŒ¯] æ¸²æŸ“å®Œç•¢!", "color: green;");
              } catch (error) {
                  console.error("%c[åµéŒ¯ å¤±æ•—] æ¸²æŸ“ (Render) éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:", "color: red; font-weight: bold;", error);
                  // èª¿æ•´ colspan
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="21" class="text-center py-10 text-red-500">æ¸²æŸ“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</td></tr>`;
              }
          }

          // *** ä¿®æ”¹ï¼šåŠ å…¥æ›´æ–°ç­†æ•¸è³‡è¨Š ***
          function renderMasterList(data) {
              if (!dom.masterListBody) return; // é˜²å‘†

              const totalCount = state.publishers.length;
              const filteredCount = data.length;
              const countInfoEl = dom.publisherCountInfo;

              if (data.length === 0) {
                  const message = totalCount > 0 ? "æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„çµæœã€‚" : "è³‡æ–™åº«ä¸­å°šç„¡è³‡æ–™ï¼Œè«‹æ–°å¢æˆ–åŒ¯å…¥ã€‚";
                   // èª¿æ•´ colspan
                  dom.masterListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="21" class="text-center py-10 text-gray-500">${message}</td></tr>`;
                  // æ›´æ–°ç­†æ•¸
                   if (countInfoEl) {
                        countInfoEl.textContent = totalCount > 0 ? `ç¯©é¸çµæœï¼šå…± 0 ç­†è³‡æ–™ (ç¸½è¨ˆ ${totalCount} ç­†)` : 'å…± 0 ç­†è³‡æ–™ã€‚';
                    }
                  return;
              }

              // æ›´æ–°ç­†æ•¸è³‡è¨Š
               if (countInfoEl) {
                  const isFiltered = state.filters.search || state.filters.staff !== 'all' || state.filters.tier !== 'all' || state.filters.status !== 'all';
                  if (isFiltered) {
                      countInfoEl.textContent = `ç¯©é¸çµæœï¼šå…± ${filteredCount} ç­†è³‡æ–™ (ç¸½è¨ˆ ${totalCount} ç­†)`;
                  } else {
                      countInfoEl.textContent = `å…± ${totalCount} ç­†è³‡æ–™ã€‚`;
                  }
               }


              // *** ä¿®æ”¹ï¼šå‚³å…¥ç´¢å¼• i ***
              dom.masterListBody.innerHTML = data.map((pub, i) => createPublisherRowHtml(pub, i)).join('');

              // *** æ¸²æŸ“å¾Œç«‹å³æ›´æ–° checkbox é¡¯ç¤ºç‹€æ…‹ ***
               const checkBoxes = dom.masterListBody.querySelectorAll('.row-checkbox');
               const displayStyleTable = state.currentRole === "admin" ? 'table-cell' : 'none';
               checkBoxes.forEach(cb => {
                   const cell = cb.closest('td');
                   if (cell) cell.style.display = displayStyleTable;
               });
               // *** æ–°å¢ï¼šæ›´æ–°åˆ—ä½æ•¸å­—æ¬„çš„é¡¯ç¤ºç‹€æ…‹ ***
               const rowNumberCells = dom.masterListBody.querySelectorAll('.row-number-col');
               rowNumberCells.forEach(cell => {
                    cell.style.display = 'table-cell'; // åˆ—ä½æ•¸å­—å§‹çµ‚é¡¯ç¤º
               });
          }

          // --- è³‡æ–™åˆ†æèˆ‡è¨ˆç®— (ä¿æŒä¸è®Š) ---
          // ... calculateAllAnalytics, calculateTeamSigningStats, etc. ...
           function calculateAllAnalytics(publishers) {
              return {
                  teamSigningStats: calculateTeamSigningStats(publishers),
                  individualSigningStats: calculateIndividualSigningStats(publishers),
                  tierProgressStats: calculateTierProgressStats(publishers),
                  individualContactStats: calculateIndividualContactStats(publishers),
              };
          }

          function calculateTeamSigningStats(publishers) {
              const stats = {};
              Object.keys(kpiTargets).forEach(item => {
                  const targetData = kpiTargets[item];
                  const progressCounts = { 8: 0, 9: 0, 10: 0, 11: 0, 12: 0 };
                  publishers.forEach(pub => {
                      // *** ç¢ºä¿ pub.tasks å­˜åœ¨ ***
                      const dateStr = pub.tasks ? pub.tasks[targetData.taskKey] : null;
                      if (dateStr) {
                          try {
                              const month = new Date(dateStr).getMonth() + 1;
                              if (progressCounts.hasOwnProperty(month)) {
                                  progressCounts[month]++;
                              }
                          } catch (e) { /* ignore invalid date */ }
                      }
                  });
                  stats[item] = {
                      targets: targetData.months,
                      progress: [progressCounts[8], progressCounts[9], progressCounts[10], progressCounts[11], progressCounts[12]]
                  };
              });
              return stats;
          }

          function calculateIndividualSigningStats(publishers) {
                 const stats = {};
                 staffList.forEach(s => stats[s] = { total: 0, signed: 0 });
                 publishers.forEach(p => {
                     if (!stats[p.staff]) stats[p.staff] = { total: 0, signed: 0 }; // Handle staff not in default list
                     stats[p.staff].total++;
                     if (p.contactStatus === "å·²ç°½å›ï¼Œå·²ç§»äº¤åˆç´„") {
                         stats[p.staff].signed++;
                     }
                 });
                 return Object.entries(stats)
                    .filter(([, data]) => data.total > 0)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        rate: data.total > 0 ? (data.signed / data.total * 100) : 0
                    }));
          }

          function calculateTierProgressStats(publishers) {
              const progressData = {};
              const currentStaff = Array.from(new Set(publishers.map(p => p.staff))).sort();

              currentStaff.forEach(staffName => {
                  progressData[staffName] = {};
                  tierList.forEach(tier => {
                      progressData[staffName][tier] = { total: 0, stages: {} };
                      contactStatusList.forEach(s => progressData[staffName][tier].stages[s] = 0);
                  });
              });

              publishers.forEach(p => {
                  if (progressData[p.staff] && progressData[p.staff][p.tier]) {
                      progressData[p.staff][p.tier].total++;
                      if (progressData[p.staff][p.tier].stages.hasOwnProperty(p.contactStatus)) {
                             progressData[p.staff][p.tier].stages[p.contactStatus]++;
                      }
                  }
              });
              return progressData;
          }

          function calculateIndividualContactStats(publishers) {
                const stats = {};
                staffList.forEach(s => stats[s] = { total: 0, contacted: 0 });
                 publishers.forEach(p => {
                    if (!stats[p.staff]) stats[p.staff] = { total: 0, contacted: 0 };
                    stats[p.staff].total++;
                    if (p.contactStatus !== "æœªè¯ç¹«") {
                        stats[p.staff].contacted++;
                    }
                });
                 return Object.entries(stats)
                    .filter(([, data]) => data.total > 0)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        rate: data.total > 0 ? (data.contacted / data.total * 100) : 0
                    }));
          }


          // --- å„æ¨¡çµ„æ¸²æŸ“å‡½å¼ (ä¿æŒä¸è®Š) ---
          // ... renderTeamSigningProgress, renderIndividualSigningProgress, etc. ...
           function renderTeamSigningProgress(stats) {
              const kpiTableBody = document.getElementById('kpi-table-body');
              const kpiTableFooter = document.getElementById('kpi-table-footer');
              let bodyHtml = '';
              const progressTotals = {
                  target: { months: [0, 0, 0, 0, 0], total: 0 },
                  progress: { months: [0, 0, 0, 0, 0], total: 0 }
              };

              Object.keys(kpiTargets).forEach(item => {
                  const itemStats = stats[item];
                  if (!itemStats) return; // *** é˜²å‘† ***
                  const targetData = itemStats.targets;
                  const progressMonths = itemStats.progress;
                  const targetTotal = targetData.reduce((a, b) => a + b, 0);
                  const progressTotal = progressMonths.reduce((a, b) => a + b, 0);
                  const overallRate = targetTotal > 0 ? (progressTotal / targetTotal * 100).toFixed(1) : 0;
                  const gap = targetTotal - progressTotal;

                  targetData.forEach((m, i) => progressTotals.target.months[i] += m);
                  progressTotals.target.total += targetTotal;
                  progressMonths.forEach((m, i) => progressTotals.progress.months[i] += m);
                  progressTotals.progress.total += progressTotal;

                  const progressCells = progressMonths.map((p, i) =>
                      `<td>${p}</td><td>${targetData[i] > 0 ? (p / targetData[i] * 100).toFixed(0) : 0}%</td>`
                  ).join('');

                  bodyHtml += `<tr>
                      <td class="item-col">${item}</td>
                      ${targetData.map(m => `<td>${m}</td>`).join('')}
                      <td class="highlight">${targetTotal}</td>
                      ${progressCells}
                      <td class="highlight">${progressTotal}</td>
                      <td class="highlight"><div class="flex items-center justify-center"><span>${overallRate}%</span><div class="w-16 bg-gray-200 rounded-full h-2.5 ml-2"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${overallRate}%"></div></div></div></td>
                      <td class="gap-col">${gap}</td>
                  </tr>`;
              });
              if(kpiTableBody) kpiTableBody.innerHTML = bodyHtml;

              const footerOverallRate = progressTotals.target.total > 0 ? (progressTotals.progress.total / progressTotals.target.total * 100).toFixed(1) : 0;
              const footerGap = progressTotals.target.total - progressTotals.progress.total;
              const footerProgressCells = progressTotals.progress.months.map((p, i) =>
                  `<td>${p}</td><td>${progressTotals.target.months[i] > 0 ? (p / progressTotals.target.months[i] * 100).toFixed(0) : 0}%</td>`
              ).join('');

              if(kpiTableFooter) kpiTableFooter.innerHTML = `<tr class="total-row">
                  <td class="item-col">ç¸½è¨ˆ</td>
                  ${progressTotals.target.months.map(m => `<td>${m}</td>`).join('')}
                  <td class="highlight">${progressTotals.target.total}</td>
                  ${footerProgressCells}
                  <td class="highlight">${progressTotals.progress.total}</td>
                  <td class="highlight">${footerOverallRate}%</td>
                  <td class="gap-col">${footerGap}</td>
              </tr>`;
          }

          function renderIndividualSigningProgress(stats) {
                 const tableBody = document.getElementById('individual-signing-body');
                 if(!tableBody) return;
                 tableBody.innerHTML = stats.map((row, index) => {
                     const rate = row.rate.toFixed(1);
                     return `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b">
                         <td class="px-6 py-4 font-medium text-gray-900">${row.name}</td>
                         <td class="px-6 py-4">${row.total}</td>
                         <td class="px-6 py-4">${row.signed}</td>
                         <td class="px-6 py-4"><div class="flex items-center">
                             <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                <div class="${rate >= 80 ? 'bg-green-600' : rate >= 50 ? 'bg-yellow-400' : 'bg-red-500'} h-2.5 rounded-full" style="width: ${rate}%"></div>
                             </div>
                             <span class="font-medium">${rate}%</span>
                         </div></td>
                     </tr>`;
                 }).join('');
          }

          function renderPublisherTierProgress(progressData) {
              const container = document.getElementById('progress-cards-container');
              const filter = document.getElementById('progress-filter');
              if(!container || !filter) return;

              const staffInFilter = Object.keys(progressData).sort();

              container.innerHTML = staffInFilter.map(name => createProgressCardHTML(name, progressData[name])).join('') || '<p class="text-center text-gray-500 col-span-full">ç„¡è³‡æ–™å¯é¡¯ç¤ºã€‚</p>';

              // Update and preserve filter selection
              const currentFilterValue = filter.value;
              filter.innerHTML = `<option value="all">é¡¯ç¤ºå…¨éƒ¨åŒä»</option>${staffInFilter.map(name => `<option value="${name}">${name}</option>`).join('')}`;
              filter.value = staffInFilter.includes(currentFilterValue) ? currentFilterValue : 'all';
              filter.dispatchEvent(new Event('change')); // Trigger filter change to show/hide cards

              applyHealthCheck();
          }

          function renderIndividualContactProgress(stats) {
                 const container = document.getElementById('individual-contact-cards-container');
                 if(!container) return;
                 container.innerHTML = stats.map(row => {
                     const rate = row.rate.toFixed(0);
                     return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
                         <h3 class="font-semibold text-gray-800">${row.name}</h3>
                         <p class="text-sm text-gray-500 mb-4">å–®ä½è¯ç¹«é€²åº¦</p>
                         <div class="flex justify-between items-center text-sm mb-1"><span>é€²åº¦</span><span class="font-bold">${rate}%</span></div>
                         <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${rate}%;"></div></div>
                         <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between text-sm">
                             <span class="text-gray-600">å·²è¯ç¹«: <strong class="text-gray-900">${row.contacted}</strong></span>
                             <span class="text-gray-600">ç¸½å–®ä½: <strong class="text-gray-900">${row.total}</strong></span>
                         </div>
                     </div>`;
                 }).join('');
          }

          // --- Helper å‡½å¼ ---
          // ä¿®æ”¹ createPublisherRowHtml åŠ å…¥åˆ—ä½æ•¸å­— å’Œ Notion æ›è¡Œ
          function createPublisherRowHtml(pub, index) {
              const tasks = pub.tasks || {};
              const taskCells = taskColumns.map(taskKey => `<td class="px-3 py-2 border-b border-gray-200"><input type="date" class="task-date-input" data-task="${taskKey}" value="${tasks[taskKey] || ''}"></td>`).join('');
              const isSelected = state.selectedPublisherIds.has(pub.id);
              // *** Checkbox å’Œ Delete button çš„é¡¯ç¤ºç‹€æ…‹ç”± CSS .admin-only æ§åˆ¶ ***
              return `
              <tr class="bg-white hover:bg-gray-50 ${isSelected ? 'bg-indigo-50' : ''}" data-id="${pub.id}">
                  <td class="px-3 py-2 border-b border-gray-200 checkbox-col admin-only" style="display: ${state.currentRole === 'admin' ? 'table-cell' : 'none'};">
                    <input type="checkbox" class="row-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-id="${pub.id}" ${isSelected ? 'checked' : ''}>
                  </td>
                  <!-- æ–°å¢ï¼šåˆ—ä½æ•¸å­— -->
                  <td class="px-3 py-2 border-b border-gray-200 row-number-col">${index + 1}</td>
                  <!-- ä¿®æ”¹ï¼šNotion æ¬„ä½å…§å®¹æ›è¡Œ -->
                  <td class="px-3 py-2 border-b border-gray-200 col-notion align-top">
                      <div class="flex flex-col space-y-1">
                          <input type="url" class="master-field-input block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-1.5" data-field="notionUrl" value="${pub.notionUrl || ''}" placeholder="è²¼ä¸Šé€£çµ...">
                          <button class="open-notion-btn p-2 rounded-md bg-gray-200 text-gray-600 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed self-start" title="æ‰“é–‹ Notion é€£çµ" ${!pub.notionUrl ? 'disabled' : ''}>
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                          </button>
                      </div>
                  </td>
                  <td class="px-3 py-3 font-medium text-gray-900 border-b border-gray-200 align-top col-publisher-name">${pub.name}</td>
                  <td class="px-3 py-3 border-b border-gray-200 align-top col-contract-id"><input type="text" class="master-field-input block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-1.5" data-field="contractId" value="${pub.contractId || ''}" placeholder="ç„¡åˆç´„ç·¨è™Ÿ"></td>
                  <td class="px-3 py-3 border-b border-gray-200 align-top col-staff"><select class="master-field-select block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-1.5" data-field="staff">${staffList.map(s => `<option value="${s}" ${pub.staff === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                  <td class="px-3 py-3 border-b border-gray-200 align-top col-tier"><select class="master-field-select block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-1.5" data-field="tier">${tierList.map(t => `<option value="${t}" ${pub.tier === t ? 'selected' : ''}>${t}</option>`).join('')}</select></td>
                  <td class="px-3 py-3 border-b border-gray-200 align-top"><select class="master-field-select block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-1.5 min-w-[150px]" data-field="contactStatus">${contactStatusList.map(s => `<option value="${s}" ${pub.contactStatus === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                  <td class="px-3 py-2 border-b border-gray-200 align-top col-mission-tags"><input type="text" class="master-field-input block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-1.5" data-field="missionTags" value="${Array.isArray(pub.missionTags) ? pub.missionTags.join(', ') : ''}" placeholder="ç„¡æ¨™ç±¤"></td>
                  ${taskCells}
                  <td class="px-3 py-2 border-b border-gray-200 align-top col-action">
                      <div class="flex items-center space-x-2">
                          <button class="save-row-btn hidden text-sm bg-green-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-600">å„²å­˜</button>
                          <button class="cancel-row-btn hidden text-sm bg-gray-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-gray-600">å–æ¶ˆ</button>
                          <!-- æ–°å¢ï¼šåˆªé™¤æŒ‰éˆ• (Admin Only) -->
                          <button class="delete-row-btn admin-only text-sm bg-red-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-red-600" style="display: ${state.currentRole === 'admin' ? 'inline-block' : 'none'};">åˆªé™¤</button>
                      </div>
                  </td>
              </tr>`;
          }

          function getFilteredAndSortedData() {
              let data = [...state.publishers];
              // Filter
              if (state.filters.search) {
                  const searchTerm = state.filters.search.toLowerCase();
                  data = data.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.contractId && p.contractId.toLowerCase().includes(searchTerm)));
              }
              if (state.filters.staff !== 'all') data = data.filter(p => p.staff === state.filters.staff);
              if (state.filters.tier !== 'all') data = data.filter(p => p.tier === state.filters.tier);
              if (state.filters.status !== 'all') data = data.filter(p => p.contactStatus === state.filters.status);

              // Sort
              data.sort((a, b) => {
                  let valA = a[state.sort.by] || '';
                  let valB = b[state.sort.by] || '';
                  if (Array.isArray(valA)) valA = valA.join(', ');
                  if (Array.isArray(valB)) valB = valB.join(', ');

                  if (valA < valB) return state.sort.order === 'asc' ? -1 : 1;
                  if (valA > valB) return state.sort.order === 'asc' ? 1 : -1;
                  return 0;
              });
              return data;
          }

          // *** æ–°å¢ï¼šæ¸²æŸ“å¾Œæ›´æ–° Checkbox å‹¾é¸ç‹€æ…‹ ***
          function updateCheckboxesAfterRender() {
              if (state.currentRole !== 'admin') return; // é admin ä¸åŸ·è¡Œ

              // æ›´æ–° Select All Checkbox
              const allCheckboxes = dom.masterListBody.querySelectorAll('.row-checkbox');
              const allVisibleIds = Array.from(allCheckboxes).map(cb => cb.dataset.id);
              const allVisibleSelected = allVisibleIds.length > 0 && allVisibleIds.every(id => state.selectedPublisherIds.has(id));
              dom.selectAllCheckbox.checked = allVisibleSelected;
              dom.selectAllCheckbox.indeterminate = !allVisibleSelected && allVisibleIds.some(id => state.selectedPublisherIds.has(id));

              // æ›´æ–°å€‹åˆ¥ Checkbox (ç†è«–ä¸Š createPublisherRowHtml å·²è™•ç†ï¼Œé€™è£¡æ˜¯é›™é‡ä¿éšª)
              allCheckboxes.forEach(checkbox => {
                 checkbox.checked = state.selectedPublisherIds.has(checkbox.dataset.id);
                 checkbox.closest('tr').classList.toggle('bg-indigo-50', checkbox.checked); // æ›´æ–°èƒŒæ™¯è‰²
              });

              updateDeleteSelectedButtonState(); // åŒæ­¥æ›´æ–°åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
          }

          // *** æ–°å¢ï¼šæ¬„ä½ç´¢å¼•è½‰å­—æ¯ ***
          function columnIndexToLetter(index) {
                let letter = '';
                let tempIndex = index;
                while (tempIndex >= 0) {
                    letter = String.fromCharCode((tempIndex % 26) + 65) + letter;
                    tempIndex = Math.floor(tempIndex / 26) - 1;
                }
                return letter;
          }

          // *** æ–°å¢ï¼šæ¸²æŸ“æ¬„ä½å­—æ¯æ¨™é ­ ***
          function renderColLetterHeader() {
               if (!dom.colLetterHeader) return;
               const headerCells = document.querySelector('#content-publisher-master thead tr:last-child').cells;
               let letterHtml = '';
               // First cell spans checkbox (if admin) and row number
               const firstColspan = (state.currentRole === 'admin' ? 1 : 0) + 1;
               letterHtml += `<th colspan="${firstColspan}" class="px-3 py-2 border-b border-gray-200"></th>`;

               let letterIndex = 0;
               // Start from the actual data columns
               for (let i = firstColspan; i < headerCells.length; i++) {
                   letterHtml += `<th class="px-3 py-2 border-b border-gray-200">${columnIndexToLetter(letterIndex)}</th>`;
                   letterIndex++;
               }
               dom.colLetterHeader.innerHTML = letterHtml;
          }
           // *** æ–°å¢ï¼šæ›´æ–°æ¬„ä½å­—æ¯æ¨™é ­çš„ Colspan (ç™»å…¥/ç™»å‡ºæ™‚) ***
          function updateColLetterHeaderColspan() {
               if (!dom.colLetterHeader) return;
               const firstCell = dom.colLetterHeader.cells[0];
               if (firstCell) {
                  const firstColspan = (state.currentRole === 'admin' ? 1 : 0) + 1;
                  firstCell.colSpan = firstColspan;
               }
          }

          // --- äº‹ä»¶ç›£è½å™¨è¨­å®š (ä¾†è‡ª æª”æ¡ˆ 2) ---
          function setupEventListeners() {
              // Navigation
              Object.keys(dom.navLinks).forEach(key => {
                  if(dom.navLinks[key]) {
                      dom.navLinks[key].addEventListener('click', (e) => { e.preventDefault(); switchContent(key); });
                  }
              });

              // Master List Filters
              dom.searchInput.addEventListener('input', e => { state.filters.search = e.target.value; renderAll(); });
              dom.staffFilter.addEventListener('change', e => { state.filters.staff = e.target.value; renderAll(); });
              dom.tierFilter.addEventListener('change', e => { state.filters.tier = e.target.value; renderAll(); });
              dom.statusFilter.addEventListener('change', e => { state.filters.status = e.target.value; renderAll(); });
              document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);

              // Master List Table Actions (Sorting, Editing, Selection, Deletion)
              document.querySelector('#content-publisher-master thead').addEventListener('click', handleSort);
              dom.masterListBody.addEventListener('change', handleRowChange); // åŒ…å« checkbox çš„ change
              dom.masterListBody.addEventListener('click', handleRowClick); // åŒ…å« delete button çš„ click

              // *** æ–°å¢ï¼šCheckbox å’Œåˆªé™¤æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ ***
              dom.selectAllCheckbox.addEventListener('change', handleSelectAllChange);
              dom.deleteSelectedBtn.addEventListener('click', handleDeleteSelectedClick);


              // Main Buttons
              document.getElementById('add-publisher-btn').addEventListener('click', () => openAddEditModal());
              document.getElementById('download-template-btn').addEventListener('click', downloadTemplate);
              document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('file-input').click());
              document.getElementById('file-input').addEventListener('change', handleFileImport);

              // Add/Edit Modal
              dom.addPublisherForm.addEventListener('submit', handleSavePublisher);
              document.getElementById('close-add-modal-btn').addEventListener('click', () => closeModal(dom.addPublisherModal, dom.addPublisherModalContent));
              document.getElementById('cancel-add-btn').addEventListener('click', () => closeModal(dom.addPublisherModal, dom.addPublisherModalContent));
              dom.addPublisherModal.addEventListener('click', e => { if (e.target === dom.addPublisherModal) closeModal(dom.addPublisherModal, dom.addPublisherModalContent); });

              // Publisher List Modal
              document.getElementById('close-publisher-list-btn').addEventListener('click', () => closeModal(dom.publisherListModal, dom.publisherListModalContent));
              dom.publisherListModal.addEventListener('click', e => { if (e.target === dom.publisherListModal) closeModal(dom.publisherListModal, dom.publisherListModalContent); });

              // Alert Modal
              document.getElementById('close-alert-modal-btn').addEventListener('click', () => closeModal(dom.alertModal, dom.alertModalContent));
              dom.alertModal.addEventListener('click', e => { if (e.target === dom.alertModal) closeModal(dom.alertModal, dom.alertModalContent); });

              // *** æ–°å¢ï¼šConfirm Modal æŒ‰éˆ•äº‹ä»¶ ***
              dom.cancelConfirmBtn.addEventListener('click', closeConfirmModal);
              dom.confirmModal.addEventListener('click', e => { if (e.target === dom.confirmModal) closeConfirmModal(); });
              // confirmActionBtn çš„äº‹ä»¶åœ¨ openConfirmModal ä¸­å‹•æ…‹è¨­å®š

              // Tier Progress View
              document.getElementById('progress-filter').addEventListener('change', handleTierProgressFilter);
              document.getElementById('progress-cards-container').addEventListener('click', handleTierCardClick);

              // Export
              document.getElementById('export-selected-btn').addEventListener('click', handleExport);

              // *** æ–°å¢ï¼šå´é‚Šæ¬„é–‹é—œäº‹ä»¶ ***
              dom.sidebarToggle.addEventListener('click', toggleSidebar);
          }

          // --- äº‹ä»¶è™•ç†å‡½å¼ (ä¾†è‡ª æª”æ¡ˆ 2) ---
          function switchContent(targetId) {
              dom.mainTitle.textContent = pageTitles[targetId];
              Object.values(dom.navLinks).forEach(link => {
                  if (link) link.classList.remove('bg-indigo-600', 'text-white', 'shadow-sm');
              });
              if(dom.navLinks[targetId]) {
                dom.navLinks[targetId].classList.add('bg-indigo-600', 'text-white', 'shadow-sm');
              }
              Object.values(dom.contentSections).forEach(section => {
                  // *** é˜²å‘†ï¼šæª¢æŸ¥ section æ˜¯å¦å­˜åœ¨ ***
                  if (section) section.classList.add('hidden');
              });
              // *** é˜²å‘†ï¼šæª¢æŸ¥ç›®æ¨™ section æ˜¯å¦å­˜åœ¨ ***
              if(dom.contentSections[targetId]) {
                dom.contentSections[targetId].classList.remove('hidden');

                // *** æ–°å¢ï¼šå¦‚æœåˆ‡æ›åˆ° admin é é¢ï¼Œè¼‰å…¥ä½¿ç”¨è€… ***
                if (targetId === 'admin') {
                   fetchUsers();
                }
              } else {
                  console.warn(`Content section for "${targetId}" not found.`);
              }
          }

          function clearFilters() {
              state.filters = { search: '', staff: 'all', tier: 'all', status: 'all' };
              dom.searchInput.value = '';
              dom.staffFilter.value = 'all';
              dom.tierFilter.value = 'all';
              dom.statusFilter.value = 'all';
              state.selectedPublisherIds.clear(); // æ¸…é™¤é¸å–
              renderAll();
          }

          function handleSort(e) {
              const header = e.target.closest('.sortable-header');
              if (!header) return;

              const sortBy = header.dataset.sort;
              if (state.sort.by === sortBy) {
                  state.sort.order = state.sort.order === 'asc' ? 'desc' : 'asc';
              } else {
                  state.sort.by = sortBy;
                  state.sort.order = 'asc';
              }
              document.querySelectorAll('.sortable-header').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
              header.classList.add(state.sort.order === 'asc' ? 'sort-asc' : 'sort-desc');
              renderAll();
          }

          // ä¿®æ”¹ handleRowChange ä»¥è™•ç† checkbox
          function handleRowChange(e) {
              const row = e.target.closest('tr');
              if (!row || !row.dataset.id) return;

              // è™•ç†è³‡æ–™ä¿®æ”¹
              if (e.target.matches('.master-field-input, .master-field-select, .task-date-input')) {
                  row.classList.add('row-dirty');
                  row.querySelector('.save-row-btn').classList.remove('hidden');
                  row.querySelector('.cancel-row-btn').classList.remove('hidden');
              }

              // è™•ç† checkbox é¸å–
              if (e.target.classList.contains('row-checkbox')) {
                  const checkbox = e.target;
                  const docId = checkbox.dataset.id;
                  if (checkbox.checked) {
                      state.selectedPublisherIds.add(docId);
                      row.classList.add('bg-indigo-50'); // é¸å–æ™‚é«˜äº®
                  } else {
                      state.selectedPublisherIds.delete(docId);
                      row.classList.remove('bg-indigo-50'); // å–æ¶ˆé¸å–æ™‚ç§»é™¤é«˜äº®
                  }
                  updateCheckboxesAfterRender(); // æ›´æ–°å…¨é¸ç‹€æ…‹å’Œåˆªé™¤æŒ‰éˆ•ç‹€æ…‹
              }
          }

           // ä¿®æ”¹ handleRowClick ä»¥è™•ç† delete button
          async function handleRowClick(e) {
              const target = e.target;
              const row = target.closest('tr');
              if (!row) return;
              const docId = row.dataset.id;
              const publisherName = row.cells[3].textContent; // *** ä¿®æ”¹ï¼šåç¨±ç¾åœ¨æ˜¯ç¬¬ 4 æ¬„ (ç´¢å¼• 3) ***

              if (target.closest('.open-notion-btn')) {
                  const url = row.querySelector('[data-field="notionUrl"]').value;
                  if (url) window.open(url, '_blank');
              } else if (target.classList.contains('save-row-btn')) {
                  await saveRowChanges(row, docId);
              } else if (target.classList.contains('cancel-row-btn')) {
                  cancelRowChanges(row, docId);
              } else if (target.classList.contains('delete-row-btn')) {
                  // *** æ–°å¢ï¼šå‘¼å«åˆªé™¤å–®ä¸€é …ç›® ***
                  openConfirmModal(`æ‚¨ç¢ºå®šè¦åˆªé™¤å‡ºç‰ˆç¤¾ã€Œ${publisherName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`, () => {
                      deleteSinglePublisher(docId);
                  });
              }
          }

          async function saveRowChanges(row, docId) {
              const docRef = doc(state.publishersCollection, docId);
              const updatePayload = {};

              row.querySelectorAll('.master-field-input, .master-field-select').forEach(input => {
                  const field = input.dataset.field;
                  updatePayload[field] = (field === 'missionTags')
                      ? input.value.split(',').map(t => t.trim()).filter(Boolean)
                      : (input.value || null);
              });

              updatePayload.tasks = {};
              row.querySelectorAll('.task-date-input').forEach(input => {
                  updatePayload.tasks[input.dataset.task] = input.value || null;
              });

              // *** ä¿®æ­£ï¼šæª¢æŸ¥ updatePayload.contactStatus æ˜¯å¦å­˜åœ¨ ***
              if (updatePayload.contactStatus && updatePayload.contactStatus !== "å·²ç°½å›ï¼Œå·²ç§»äº¤åˆç´„" && Object.values(updatePayload.tasks).some(date => date)) {
                  showAlert("åªæœ‰åœ¨è¯ç¹«ç‹€æ…‹ç‚ºã€Œå·²ç°½å›ï¼Œå·²ç§»äº¤åˆç´„ã€æ™‚ï¼Œæ‰èƒ½å¡«å¯«ä»»å‹™å®Œæˆæ—¥æœŸã€‚");
                  return;
              }

              try {
                  await updateDoc(docRef, updatePayload);
                  row.classList.remove('row-dirty');
                  row.querySelector('.save-row-btn').classList.add('hidden');
                  row.querySelector('.cancel-row-btn').classList.add('hidden');
                  showToast("å„²å­˜æˆåŠŸï¼", "success");
              } catch (error) {
                  console.error("Error updating document:", error);
                  showToast("å„²å­˜å¤±æ•—", "error");
                  if (error.code === 'permission-denied') {
                     showAlert("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•å„²å­˜è®Šæ›´ã€‚è«‹ç¢ºèª Firestore å®‰å…¨è¦å‰‡ã€‚");
                  }
              }
          }

          function cancelRowChanges(row, docId) {
              const originalData = state.publishers.find(p => p.id === docId);
              const index = getFilteredAndSortedData().findIndex(p => p.id === docId); // *** æ–°å¢ï¼šå–å¾—æ­£ç¢ºç´¢å¼• ***
              if (originalData && index !== -1) { // *** ä¿®æ”¹ï¼šæª¢æŸ¥ç´¢å¼• ***
                  // *** ä¿®æ”¹ï¼šå‚³å…¥ç´¢å¼• ***
                  const newRowHtml = createPublisherRowHtml(originalData, index);
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = `<table><tbody>${newRowHtml}</tbody></table>`;
                  const newRow = tempDiv.querySelector('tr');
                  row.replaceWith(newRow);
                  // *** å–æ¶ˆå¾Œç¢ºä¿ checkbox ç‹€æ…‹æ­£ç¢º ***
                  const checkbox = newRow.querySelector('.row-checkbox');
                  if(checkbox) {
                      checkbox.checked = state.selectedPublisherIds.has(docId);
                  }
                   newRow.classList.toggle('bg-indigo-50', state.selectedPublisherIds.has(docId)); // æ›´æ–°èƒŒæ™¯è‰²
              }
          }

          // --- *** æ–°å¢ï¼šåˆªé™¤èˆ‡é¸å–ç›¸é—œå‡½æ•¸ *** ---
          function handleSelectAllChange(e) {
              const isChecked = e.target.checked;
              const allVisibleCheckboxes = dom.masterListBody.querySelectorAll('.row-checkbox');

              allVisibleCheckboxes.forEach(checkbox => {
                  const docId = checkbox.dataset.id;
                  checkbox.checked = isChecked;
                  const row = checkbox.closest('tr');
                  if (isChecked) {
                      state.selectedPublisherIds.add(docId);
                      row.classList.add('bg-indigo-50');
                  } else {
                      state.selectedPublisherIds.delete(docId);
                       row.classList.remove('bg-indigo-50');
                  }
              });
               updateDeleteSelectedButtonState(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          }

          function updateDeleteSelectedButtonState() {
               dom.deleteSelectedBtn.disabled = state.selectedPublisherIds.size === 0;
               dom.deleteSelectedBtn.classList.toggle('opacity-50', state.selectedPublisherIds.size === 0);
               dom.deleteSelectedBtn.classList.toggle('cursor-not-allowed', state.selectedPublisherIds.size === 0);
          }

          function handleDeleteSelectedClick() {
               if (state.selectedPublisherIds.size === 0) return;

               openConfirmModal(`æ‚¨ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${state.selectedPublisherIds.size} å€‹å‡ºç‰ˆç¤¾å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`, () => {
                   deleteSelectedPublishers();
               });
          }

          async function deleteSinglePublisher(docId) {
              if (!docId) return;
              const docRef = doc(state.publishersCollection, docId);
              try {
                  await deleteDoc(docRef);
                  state.selectedPublisherIds.delete(docId); // å¾é¸å–é›†åˆä¸­ç§»é™¤
                  showToast("å‡ºç‰ˆç¤¾åˆªé™¤æˆåŠŸï¼", "success");
                  // onSnapshot æœƒè‡ªå‹•æ›´æ–°ç•«é¢
                  updateDeleteSelectedButtonState(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
              } catch (error) {
                  console.error("åˆªé™¤å–®ä¸€å‡ºç‰ˆç¤¾å¤±æ•—:", error);
                  showToast("åˆªé™¤å¤±æ•—", "error");
                  if (error.code === 'permission-denied') {
                     showAlert("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åˆªé™¤ã€‚è«‹ç¢ºèª Firestore å®‰å…¨è¦å‰‡ã€‚");
                  }
              }
          }

          async function deleteSelectedPublishers() {
              if (state.selectedPublisherIds.size === 0) return;

              const batch = writeBatch(state.db);
              state.selectedPublisherIds.forEach(id => {
                  const docRef = doc(state.publishersCollection, id);
                  batch.delete(docRef);
              });

              try {
                  await batch.commit();
                  showToast(`å·²æˆåŠŸåˆªé™¤ ${state.selectedPublisherIds.size} å€‹å‡ºç‰ˆç¤¾ã€‚`, "success");
                  state.selectedPublisherIds.clear(); // æ¸…ç©ºé¸å–
                  // onSnapshot æœƒè‡ªå‹•æ›´æ–°ç•«é¢
                  updateCheckboxesAfterRender(); // æ›´æ–° checkbox ç‹€æ…‹
                  updateDeleteSelectedButtonState(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
              } catch (error) {
                  console.error("æ‰¹æ¬¡åˆªé™¤å‡ºç‰ˆç¤¾å¤±æ•—:", error);
                  showToast("æ‰¹æ¬¡åˆªé™¤å¤±æ•—", "error");
                   if (error.code === 'permission-denied') {
                     showAlert("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åˆªé™¤ã€‚è«‹ç¢ºèª Firestore å®‰å…¨è¦å‰‡ã€‚");
                  }
              }
          }


          // --- ä½¿ç”¨è€…ç®¡ç†ç›¸é—œå‡½æ•¸ (ä¿æŒç°¡åŒ–) ---
          async function fetchUsers() {
              if (state.auth.currentUser) {
                 const currentUserDocRef = doc(state.db, "artifacts", "ebook-dashboard", "users", state.auth.currentUser.uid);
                 const currentUserDoc = await getDoc(currentUserDocRef);
                 if (!currentUserDoc.exists() || currentUserDoc.data().role !== 'admin') {
                    userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-red-500">æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®ã€‚</td></tr>';
                    return;
                 }
                 userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-gray-500">æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®...</td></tr>';
                 try {
                     const usersCollectionRef = collection(state.db, "artifacts", "ebook-dashboard", "users");
                     const querySnapshot = await getDocs(usersCollectionRef);
                     const users = [];
                     querySnapshot.forEach((doc) => {
                         users.push({
                             id: doc.id,
                             email: doc.data().email || `æœªçŸ¥ Email (UID: ${doc.id})`,
                             role: doc.data().role
                         });
                     });
                     renderUserList(users);
                 } catch (error) {
                     console.error("è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                     userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-red-500">è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯èˆ‡ Firestore å®‰å…¨è¦å‰‡ã€‚</td></tr>';
                     if (error.code === 'permission-denied') {
                         showAlert("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è®€å–ä½¿ç”¨è€…æ¸…å–®ã€‚è«‹ç¢ºèª Firestore å®‰å…¨è¦å‰‡æ˜¯å¦å·²æ›´æ–°ä¸¦å…è¨±ç®¡ç†å“¡è®€å– users é›†åˆã€‚");
                     }
                 }
              }
          }

          function renderUserList(users) {
              if (!userListBody) return; // é˜²å‘†
              if (users.length === 0) {
                 userListBody.innerHTML = '<tr><td colspan="2" class="text-center py-10 text-gray-500">ç›®å‰æ²’æœ‰å…¶ä»–ä½¿ç”¨è€…ã€‚</td></tr>';
                 return;
              }
              userListBody.innerHTML = users.map((user, index) => {
                 const isCurrentUser = user.id === state.auth.currentUser.uid;
                 return `
                 <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b" data-userid="${user.id}">
                     <td class="px-6 py-4 font-medium text-gray-900">${user.email} ${isCurrentUser ? '(æ‚¨)' : ''}</td>
                     <td class="px-6 py-4">${user.role}</td>
                 </tr>`;
              }).join('');
          }

          // --- Modal & UI Helpers ---
          function openModal(modal, content) {
            if (modal && content) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => content.classList.add('open'), 10);
            } else { console.error("Modal or content element not found for openModal"); }
          }
          function closeModal(modal, content) {
            if (modal && content) {
                content.classList.remove('open');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
            } else { console.error("Modal or content element not found for closeModal"); }
          }
          function showAlert(message) {
            if(dom.alertModalText && dom.alertModal && dom.alertModalContent) {
                dom.alertModalText.textContent = message;
                openModal(dom.alertModal, dom.alertModalContent);
            } else { console.error("Alert modal elements not found for showAlert"); }
          }
          // *** æ–°å¢ï¼šConfirm Modal æ§åˆ¶å‡½æ•¸ ***
          let confirmCallback = null; // ç”¨æ–¼å„²å­˜ç¢ºèªå¾Œè¦åŸ·è¡Œçš„å‡½æ•¸
          function openConfirmModal(message, onConfirm) {
              if(dom.confirmModalText && dom.confirmModal && dom.confirmModalContent) {
                  dom.confirmModalText.textContent = message;
                  confirmCallback = onConfirm; // å„²å­˜å›èª¿
                  // ç§»é™¤èˆŠç›£è½å™¨ä»¥é˜²é‡è¤‡è§¸ç™¼
                  dom.confirmActionBtn.removeEventListener('click', handleConfirmAction);
                  dom.confirmActionBtn.addEventListener('click', handleConfirmAction);
                  openModal(dom.confirmModal, dom.confirmModalContent);
              } else { console.error("Confirm modal elements not found for openConfirmModal"); }
          }
          function closeConfirmModal() {
              if(dom.confirmModal && dom.confirmModalContent) {
                 closeModal(dom.confirmModal, dom.confirmModalContent);
                 confirmCallback = null; // æ¸…é™¤å›èª¿
              }
          }
          function handleConfirmAction() {
              if (typeof confirmCallback === 'function') {
                  confirmCallback(); // åŸ·è¡Œå„²å­˜çš„å›èª¿
              }
              closeConfirmModal(); // é—œé–‰ Modal
          }


          function showToast(message, type = "info") {
              const toast = document.getElementById('toast');
              const toastContent = document.getElementById('toast-content');
              if (!toast || !toastContent) return;
              const icons = {
                  success: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>`,
                  error: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>`,
                  warning: `<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-orange-500 bg-orange-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.22 3.001-1.742 3.001H4.42c-1.522 0-2.492-1.667-1.742-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></div>`
              };
              toastContent.innerHTML = `${icons[type] || ''}<div class="ml-3 text-sm font-normal">${message}</div>`;
              toast.classList.add('show');
              setTimeout(() => { toast.classList.remove('show'); }, 3000);
          }

          function setupFilters() {
              if(dom.staffFilter) dom.staffFilter.innerHTML = `<option value="all">æ‰€æœ‰åŒä»</option>${staffList.map(s => `<option value="${s}">${s}</option>`).join('')}`;
              if(dom.tierFilter) dom.tierFilter.innerHTML = `<option value="all">æ‰€æœ‰åˆ†ç´š</option>${tierList.map(t => `<option value="${t}">${t}ç´š</option>`).join('')}`;
              if(dom.statusFilter) dom.statusFilter.innerHTML = `<option value="all">æ‰€æœ‰ç‹€æ…‹</option>${contactStatusList.map(s => `<option value="${s}">${s}</option>`).join('')}`;
          }

          // --- æ–°å¢/ç·¨è¼¯ Modal ---
          function openAddEditModal() {
              if (dom.addPublisherForm) {
                  dom.addPublisherForm.reset();
                  const staffSelect = document.getElementById('new-publisher-staff');
                  const tierSelect = document.getElementById('new-publisher-tier');
                  const statusSelect = document.getElementById('new-publisher-status');
                  if(staffSelect) staffSelect.innerHTML = staffList.map(s => `<option value="${s}">${s}</option>`).join('');
                  if(tierSelect) tierSelect.innerHTML = tierList.map(t => `<option value="${t}">${t}</option>`).join('');
                  if(statusSelect) statusSelect.innerHTML = contactStatusList.map(s => `<option value="${s}">${s}</option>`).join('');
              }
              openModal(dom.addPublisherModal, dom.addPublisherModalContent);
          }

          async function handleSavePublisher(e) {
              e.preventDefault();
              const tagsInput = document.getElementById('new-publisher-mission-tags').value;
              const newPublisher = {
                  name: document.getElementById('new-publisher-name').value,
                  notionUrl: document.getElementById('new-publisher-notion-url').value || null,
                  contractId: document.getElementById('new-publisher-contract-id').value || null,
                  staff: document.getElementById('new-publisher-staff').value,
                  tier: document.getElementById('new-publisher-tier').value,
                  contactStatus: document.getElementById('new-publisher-status').value,
                  missionTags: tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(Boolean) : [],
                  tasks: Object.fromEntries(taskColumns.map(key => [key, null]))
              };

              try {
                  await addDoc(state.publishersCollection, newPublisher);
                  showToast("å‡ºç‰ˆç¤¾æ–°å¢æˆåŠŸ", "success");
              } catch (error) {
                  console.error("Error adding document: ", error);
                  showToast("æ–°å¢å¤±æ•—", "error");
                  if (error.code === 'permission-denied') {
                     showAlert("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•æ–°å¢ã€‚è«‹ç¢ºèª Firestore å®‰å…¨è¦å‰‡ã€‚");
                  }
              }
              closeModal(dom.addPublisherModal, dom.addPublisherModalContent);
          }

          // --- XLSX Import/Export (ä¿æŒä¸è®Š) ---
          // ... downloadTemplate, handleFileImport, normalizeDate ...
          function downloadTemplate() {
                const baseHeaders = ["å‡ºç‰ˆç¤¾åç¨±", "Notion ç´€éŒ„é€£çµ", "åˆç´„ç·¨è™Ÿ", "è² è²¬åŒä»", "åˆ†ç´š", "è¯ç¹«ç‹€æ…‹", "å¾µé›†çµ„æŒ‡å®šä»»å‹™"];
                const taskHeaders = taskColumns.map(key => {
                   const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                   return headerEl ? headerEl.textContent : key; // Fallback to key if header not found
                });
                const allHeaders = [...baseHeaders, ...taskHeaders];
                const exampleRow = [ "ç¯„ä¾‹å‡ºç‰ˆç¤¾", "https://www.notion.so/your-page-id", "EBK00001-1", "é™³ç«å›", "A", "è¯ç¹«ä¸­", "æœªåˆä½œ<æ›¸>,B2Bé‡é»", "2025-08-15", ...Array(taskColumns.length - 1).fill("") ];
                const worksheet = window.XLSX.utils.aoa_to_sheet([allHeaders, exampleRow]);
                const workbook = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(workbook, worksheet, "å‡ºç‰ˆç¤¾");
                window.XLSX.writeFile(workbook, "åŒ¯å…¥ç¯„æœ¬.xlsx");
          }

          function handleFileImport(event) {
              const file = event.target.files[0]; if (!file) return;
              const reader = new FileReader();
              reader.onload = async (e) => {
                  try {
                      const data = new Uint8Array(e.target.result);
                      const workbook = window.XLSX.read(data, { type: 'array' });
                      const sheetName = workbook.SheetNames[0];
                      const worksheet = workbook.Sheets[sheetName];
                      const records = window.XLSX.utils.sheet_to_json(worksheet);
                      if (!records || records.length === 0) { showToast("æª”æ¡ˆç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤", "error"); return; }

                      const batch = writeBatch(state.db);
                      let createdCount = 0, updatedCount = 0;

                      for (const record of records) {
                          const publisherName = record["å‡ºç‰ˆç¤¾åç¨±"];
                          if (!publisherName) continue;

                          const missionTag = record["å¾µé›†çµ„æŒ‡å®šä»»å‹™"];
                          const missionTags = (missionTag && missionTag !== "ä¸åœ¨æŒ‡å®šä»»å‹™ç¯„åœ") ? missionTag.toString().split(',').map(t => t.trim()) : [];

                          const publisherData = {
                              name: publisherName,
                              notionUrl: record["Notion ç´€éŒ„é€£çµ"] || null,
                              contractId: record["åˆç´„ç·¨è™Ÿ"] || null,
                              staff: record["å¾µé›†"] || record["è² è²¬åŒä»"] || 'æœªåˆ†é…',
                              tier: record["åˆ†ç´š"] || 'X',
                              contactStatus: record["è¯ç¹«ç‹€æ…‹"] || 'æœªè¯ç¹«',
                              missionTags: missionTags,
                              tasks: {}
                          };
                          taskColumns.forEach(key => {
                              const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                              const headerText = headerEl ? headerEl.textContent : key; // Use header text for lookup
                              if (record[headerText] !== undefined) {
                                  publisherData.tasks[key] = normalizeDate(record[headerText]);
                              }
                          });

                          const existingPub = state.publishers.find(p => p.name === publisherName);
                          const docRef = existingPub ? doc(state.publishersCollection, existingPub.id) : doc(state.publishersCollection);
                          batch.set(docRef, publisherData);
                          existingPub ? updatedCount++ : createdCount++;
                      }
                      await batch.commit();
                      showToast(`åŒ¯å…¥å®Œæˆï¼š${createdCount} ç­†æ–°å¢ï¼Œ${updatedCount} ç­†æ›´æ–°`, "success");
                  } catch (error) {
                      showToast("æª”æ¡ˆè™•ç†å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼", "error");
                      console.error("Error processing XLSX:", error);
                  } finally {
                      event.target.value = '';
                  }
              };
              reader.readAsArrayBuffer(file);
          }

          function normalizeDate(value) {
              if (value === null || typeof value === 'undefined') return null;
              if (typeof value === 'number') {
                  // Handle Excel date serial numbers
                  // Excel dates start from 1900-01-01 as day 1 (Windows) or 1904-01-01 (Mac)
                  // This basic conversion assumes Windows Excel format (needs adjustment for Mac)
                   if (value > 60) value--; // Adjust for Excel leap year bug (1900)
                   const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899
                   const date = new Date(excelEpoch.getTime() + value * 24 * 60 * 60 * 1000);
                   if (!isNaN(date.getTime())) {
                       const year = date.getFullYear();
                       const month = (date.getMonth() + 1).toString().padStart(2, '0');
                       const day = date.getDate().toString().padStart(2, '0');
                       return `${year}-${month}-${day}`;
                   } else {
                       return null; // Invalid number
                   }
              }
              // Handle string dates (YYYY-MM-DD or YYYY/MM/DD)
              if (typeof value === 'string') {
                  value = value.replace(/\//g, '-'); // Normalize separators
                   const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                       // Check if it's a valid date string format
                       if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                           return value; // Already in correct format
                       } else {
                            // Try to format it correctly
                           const year = date.getFullYear();
                           const month = (date.getMonth() + 1).toString().padStart(2, '0');
                           const day = date.getDate().toString().padStart(2, '0');
                           return `${year}-${month}-${day}`;
                       }
                    } else {
                         return null; // Invalid string
                    }
              }
               // Handle Date objects
               if (value instanceof Date) {
                  if (!isNaN(value.getTime())) {
                      const year = value.getFullYear();
                      const month = (value.getMonth() + 1).toString().padStart(2, '0');
                      const day = value.getDate().toString().padStart(2, '0');
                      return `${year}-${month}-${day}`;
                  } else {
                     return null; // Invalid date object
                  }
               }

               return null; // Unhandled type
            }

          // --- è¡¨å›› & è¡¨äº” Card ç›¸é—œå‡½å¼ (ä¿æŒä¸è®Š) ---
          // ... handleTierProgressFilter, handleTierCardClick, etc. ...
          function handleTierProgressFilter(e) {
              const selectedValue = e.target.value;
              document.querySelectorAll('.progress-card').forEach(card => {
                  card.style.display = (selectedValue === 'all' || card.dataset.name === selectedValue) ? '' : 'none';
              });
          }

          function handleTierCardClick(e) {
              const statEl = e.target.closest('.clickable-stat');
              if (!statEl) return;

              const cell = statEl.closest('td');
              const row = statEl.closest('tr');
              const card = statEl.closest('.progress-card');

              const staff = card.dataset.name;
              const tier = row.dataset.tier;
              const status = cell.dataset.stage;

              const filtered = state.publishers.filter(p => p.staff === staff && p.tier === tier && p.contactStatus === status);

              const listTitleEl = document.getElementById('publisher-list-title');
              if(listTitleEl) listTitleEl.textContent = `${staff} - ${tier}ç´š - ${status}`;

              const listBody = document.getElementById('publisher-list-body');
              if(listBody) {
                  listBody.innerHTML = filtered.length > 0
                      ? filtered.map(p => `<li>${p.name} (${p.contractId || 'ç„¡ç·¨è™Ÿ'})</li>`).join('')
                      : '<li>ç„¡ç¬¦åˆæ¢ä»¶çš„å‡ºç‰ˆç¤¾</li>';
              }

              openModal(dom.publisherListModal, dom.publisherListModalContent);
          }

          function createProgressCardHTML(name, data) {
                 let totalRow = { "æ¯é«”æ•¸": 0 };
                 contactStatusList.forEach(s => totalRow[s] = 0);

                 let tableBody = tierList.map(tier => {
                     const tierData = data[tier];
                     if (!tierData || tierData.total === 0) return '';
                     let stageHtml = '';
                     contactStatusList.forEach(stage => {
                         const value = tierData.stages[stage] || 0;
                         const percentage = tierData.total > 0 ? (value / tierData.total * 100).toFixed(0) : 0;
                         stageHtml += `<td data-stage="${stage}" data-value="${value}"><span class="clickable-stat">${value}</span><span class="percentage">(${percentage}%)</span></td>`;
                         totalRow[stage] += value;
                     });
                     totalRow["æ¯é«”æ•¸"] += tierData.total;
                     return `<tr class="border-b" data-tier="${tier}"><td class="px-3 py-3 font-medium text-gray-900 text-left">${tier}ç´š</td>${stageHtml}<td class="font-bold bg-gray-50 text-gray-800">${tierData.total}</td></tr>`;
                 }).join('');

                 if (totalRow["æ¯é«”æ•¸"] === 0) return '';
                 return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 progress-card" data-name="${name}"><h3 class="text-xl font-bold text-gray-800 mb-4">${name}</h3><div class="overflow-x-auto"><table class="w-full text-xs text-center text-gray-600"><thead class="bg-gray-100 text-gray-700 uppercase"><tr><th class="px-3 py-3 text-left">åˆ†ç´š</th>${contactStatusList.map(s => `<th class="px-3 py-3">${s.replace('å·²è¯ç¹«ï¼Œ','')}</th>`).join('')}<th class="px-3 py-3 bg-gray-200 font-bold">æ¯é«”æ•¸</th></tr></thead><tbody>${tableBody}<tr class="bg-gray-100 font-bold"><td class="px-3 py-4 text-gray-900 text-left">ç¸½è¨ˆ</td>${contactStatusList.map(s => `<td>${totalRow[s]}</td>`).join('')}<td class="bg-indigo-100 text-indigo-800">${totalRow["æ¯é«”æ•¸"]}</td></tr></tbody></table></div></div>`;
          }

          function applyHealthCheck() {
              document.querySelectorAll('.progress-card').forEach(card => {
                  const aTierRow = card.querySelector('tr[data-tier="A"]');
                  if (aTierRow) {
                      const notContactedCell = aTierRow.querySelector('td[data-stage="æœªè¯ç¹«"]');
                      if(!notContactedCell) return; // é˜²å‘†
                      const totalCell = aTierRow.cells[aTierRow.cells.length - 1];
                      if(!totalCell) return; // é˜²å‘†

                      const total = parseInt(totalCell.textContent);
                      const notContactedCount = parseInt(notContactedCell.dataset.value);
                      const percentage = total > 0 ? (notContactedCount / total) * 100 : 0;

                      notContactedCell.classList.remove('health-warning', 'health-critical');
                      if (percentage >= 50) notContactedCell.classList.add('health-critical');
                      else if (percentage >= 25) notContactedCell.classList.add('health-warning');
                  }
              });
          }

          // --- Export Handler (ä¿æŒä¸è®Š) ---
          // ... handleExport ...
           function handleExport() {
                 const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="export-option"]:checked'));
                 if(selectedCheckboxes.length === 0) {
                     showToast("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦åŒ¯å‡ºçš„å ±è¡¨", "warning");
                     return;
                 }

                 const workbook = window.XLSX.utils.book_new();

                 // Info Sheet
                 const infoSheetData = [
                    ["å ±è¡¨åŒ¯å‡ºè³‡è¨Š"],
                    ["åŒ¯å‡ºæ—¥æœŸ", new Date().toLocaleString()],
                    [""],
                    ["ç¯©é¸æ¢ä»¶"],
                    ["æœå°‹é—œéµå­—", state.filters.search || "(ç„¡)"],
                    ["è² è²¬åŒä»", state.filters.staff === 'all' ? "(å…¨éƒ¨)" : state.filters.staff],
                    ["åˆ†ç´š", state.filters.tier === 'all' ? "(å…¨éƒ¨)" : state.filters.tier],
                    ["è¯ç¹«ç‹€æ…‹", state.filters.status === 'all' ? "(å…¨éƒ¨)" : state.filters.status],
                    [""],
                    ["åŒ¯å‡ºçš„å ±è¡¨"],
                    ...selectedCheckboxes.map(cb => [cb.nextElementSibling.textContent.trim()])
                 ];
                 const infoSheet = window.XLSX.utils.aoa_to_sheet(infoSheetData);
                 infoSheet['!cols'] = [{ wch: 30 }, { wch: 30 }];
                 window.XLSX.utils.book_append_sheet(workbook, infoSheet, "åŒ¯å‡ºè³‡è¨Š");

                // Data Sheets
                const exportFunctions = {
                    table1: getPublisherMasterDataForExport,
                    table2: getTeamSigningDataForExport,
                    table3: getIndividualSigningDataForExport,
                    table4: getPublisherTierDataForExport,
                    table5: getIndividualContactDataForExport,
                };
                const sheetNames = {
                    table1: "è¡¨ä¸€_å‡ºç‰ˆç¤¾æ¯é«”ç®¡ç†",
                    table2: "è¡¨äºŒ_åœ˜éšŠç°½ç´„é€²åº¦",
                    table3: "è¡¨ä¸‰_å€‹äººç°½ç´„é€²åº¦",
                    table4: "è¡¨å››_åˆ†ç´šè¯ç¹«é€²åº¦",
                    table5: "è¡¨äº”_å€‹äººè¯ç¹«é€²åº¦",
                };

                selectedCheckboxes.forEach(checkbox => {
                    const optionValue = checkbox.value;
                    if(exportFunctions[optionValue]) { // é˜²å‘†
                        const data = exportFunctions[optionValue]();
                        if (data && data.length > 0) {
                            const worksheet = window.XLSX.utils.json_to_sheet(data);
                            window.XLSX.utils.book_append_sheet(workbook, worksheet, sheetNames[optionValue]);
                        }
                    }
                });

                 window.XLSX.writeFile(workbook, `å¾µé›†é€²åº¦å ±è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
                 showToast("å ±è¡¨åŒ¯å‡ºæˆåŠŸï¼", "success");
            }

            // --- Export Data Formatting (ä¿æŒä¸è®Š) ---
            // ... getPublisherMasterDataForExport, getTeamSigningDataForExport, etc. ...
             function getPublisherMasterDataForExport() {
                 // *** ä¿®æ”¹ï¼šåŠ å…¥åˆ—ä½ ***
                return getFilteredAndSortedData().map((pub, index) => {
                    let row = {
                        "#": index + 1, // åˆ—ä½
                        "å‡ºç‰ˆç¤¾åç¨±": pub.name,
                        "Notion ç´€éŒ„é€£çµ": pub.notionUrl || '',
                        "åˆç´„ç·¨è™Ÿ": pub.contractId || '',
                        "è² è²¬åŒä»": pub.staff,
                        "åˆ†ç´š": pub.tier,
                        "è¯ç¹«ç‹€æ…‹": pub.contactStatus,
                        "ä»»å‹™æ¨™ç±¤": Array.isArray(pub.missionTags) ? pub.missionTags.join(', ') : ''
                    };
                    taskColumns.forEach((key, colIndex) => { // åŠ å…¥ colIndex
                        const headerEl = document.querySelector(`th[data-task-header="${key}"]`);
                        const headerText = headerEl ? headerEl.textContent : key;
                        // *** ä¿®æ”¹ï¼šåŠ å…¥å­—æ¯æ¨™é ­ ***
                        const letterHeader = `${columnIndexToLetter(colIndex + 7)}_${headerText}`; // 7 = å‰é¢çš„å›ºå®šæ¬„ä½æ•¸
                        row[letterHeader] = pub.tasks[key] || '';
                    });
                     // *** æ–°å¢ï¼šç‚ºå›ºå®šæ¬„ä½åŠ ä¸Šå­—æ¯æ¨™é ­ ***
                     row[`A_Notion ç´€éŒ„é€£çµ`] = row['Notion ç´€éŒ„é€£çµ']; delete row['Notion ç´€éŒ„é€£çµ'];
                     row[`B_å‡ºç‰ˆç¤¾åç¨±`] = row['å‡ºç‰ˆç¤¾åç¨±']; delete row['å‡ºç‰ˆç¤¾åç¨±'];
                     row[`C_åˆç´„ç·¨è™Ÿ`] = row['åˆç´„ç·¨è™Ÿ']; delete row['åˆç´„ç·¨è™Ÿ'];
                     row[`D_è² è²¬åŒä»`] = row['è² è²¬åŒä»']; delete row['è² è²¬åŒä»'];
                     row[`E_åˆ†ç´š`] = row['åˆ†ç´š']; delete row['åˆ†ç´š'];
                     row[`F_è¯ç¹«ç‹€æ…‹`] = row['è¯ç¹«ç‹€æ…‹']; delete row['è¯ç¹«ç‹€æ…‹'];
                     row[`G_ä»»å‹™æ¨™ç±¤`] = row['ä»»å‹™æ¨™ç±¤']; delete row['ä»»å‹™æ¨™ç±¤'];

                     // èª¿æ•´é †åºï¼Œå°‡ '#' æ”¾ç¬¬ä¸€
                     const orderedRow = { '#': row['#'] };
                     delete row['#'];
                     Object.assign(orderedRow, row);

                    return orderedRow;
                });
            }

            function getTeamSigningDataForExport() {
                const header1 = ["é …ç›®", "ç›®æ¨™_8æœˆ", "ç›®æ¨™_9æœˆ", "ç›®æ¨™_10æœˆ", "ç›®æ¨™_11æœˆ", "ç›®æ¨™_12æœˆ", "ç›®æ¨™_å®¶æ•¸åˆè¨ˆ", "é€²åº¦_8æœˆ", "é”æˆç‡_8æœˆ", "é€²åº¦_9æœˆ", "é”æˆç‡_9æœˆ", "é€²åº¦_10æœˆ", "é”æˆç‡_10æœˆ", "é€²åº¦_11æœˆ", "é”æˆç‡_11æœˆ", "é€²åº¦_12æœˆ", "é”æˆç‡_12æœˆ", "é€²åº¦_å®¶æ•¸åˆè¨ˆ", "å„é …ç›®é”æˆç‡", "ç¼ºå£å®¶æ•¸"];
                const tableData = [];
                const bodyEl = document.getElementById('kpi-table-body');
                const footerEl = document.getElementById('kpi-table-footer');
                if(!bodyEl || !footerEl) return [];

                const bodyRows = bodyEl.rows;
                const footerRow = footerEl.rows[0];

                Array.from(bodyRows).forEach(row => {
                    const rowData = {};
                    Array.from(row.cells).forEach((cell, i) => { rowData[header1[i]] = cell.textContent; });
                    tableData.push(rowData);
                });

                if (footerRow) { // é˜²å‘†
                    const footerData = {};
                    Array.from(footerRow.cells).forEach((cell, i) => { footerData[header1[i]] = cell.textContent; });
                    tableData.push(footerData);
                }
                return tableData;
            }

            function getIndividualSigningDataForExport() {
                return state.analytics.individualSigningStats.map(row => ({
                    "è² è²¬äºº": row.name,
                    "è² è²¬å–®ä½æ•¸": row.total,
                    "å·²ç°½ç´„": row.signed,
                    "ç°½ç´„ç‡(%)": row.rate.toFixed(1),
                }));
            }

            function getPublisherTierDataForExport() {
                 const flatData = [];
                 const progressData = state.analytics.tierProgressStats;
                 Object.keys(progressData).sort().forEach(staffName => {
                     Object.keys(progressData[staffName]).sort().forEach(tier => {
                         const tierData = progressData[staffName][tier];
                         if (tierData.total > 0) {
                             contactStatusList.forEach(stage => {
                                 const count = tierData.stages[stage] || 0;
                                 if (count > 0) {
                                     flatData.push({ "è² è²¬åŒä»": staffName, "åˆ†ç´š": tier, "è¯ç¹«ç‹€æ…‹": stage, "å‡ºç‰ˆç¤¾æ•¸é‡": count });
                                 }
                             });
                         }
                     });
                 });
                 return flatData;
            }

            function getIndividualContactDataForExport(){
                return state.analytics.individualContactStats.map(row => ({
                    "è² è²¬äºº": row.name,
                    "ç¸½å–®ä½": row.total,
                    "å·²è¯ç¹«": row.contacted,
                    "è¯ç¹«ç‡(%)": row.rate.toFixed(0)
                }));
            }

           // *** æ–°å¢ï¼šå´é‚Šæ¬„åˆ‡æ›å‡½æ•¸ ***
           function toggleSidebar() {
               state.isSidebarCollapsed = !state.isSidebarCollapsed;
               applySidebarState();
           }

           // *** æ–°å¢ï¼šæ‡‰ç”¨å´é‚Šæ¬„ç‹€æ…‹ ***
           function applySidebarState() {
                if (state.isSidebarCollapsed) {
                   dom.sidebar.classList.add('collapsed');
                   document.body.classList.add('sidebar-collapsed');
                } else {
                   dom.sidebar.classList.remove('collapsed');
                   document.body.classList.remove('sidebar-collapsed');
                }
           }


      }); // *** ä¿®æ­£ï¼šè£œä¸Šé€™å€‹ }); ***
  </script>
</body>
</html>

